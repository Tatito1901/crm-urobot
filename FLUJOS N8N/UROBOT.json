{
  "name": "UROBOT",
  "nodes": [
    {
      "parameters": {
        "description": "Cu√°ndo usar esta herramienta (activar de inmediato)\n\nCuando el usuario pregunte por horarios disponibles: ¬´¬øhay disponibilidad?¬ª, ¬´¬øcu√°ndo hay citas?¬ª.\n\nCuando mencione una fecha relativa o espec√≠fica: ¬´quiero agendar el viernes¬ª, ¬´ma√±ana¬ª, ¬´la pr√≥xima semana¬ª.\n\nCuando pregunte por una sede: ¬´¬øhay horarios en Polanco?¬ª.\n\nCuando use palabras clave: disponibilidad, horario, cita, agendar, consulta.\n\nPar√°metros a extraer\n\ndesiredStart (string, ISO 8601 UTC): fecha/hora de referencia.\nReglas de conversi√≥n (zona base: America/Mexico_City):\n\n¬´ma√±ana¬ª ‚Üí ma√±ana a las 00:00:00 hora local, convertida a UTC y expresada con sufijo Z.\n\n¬´viernes¬ª ‚Üí pr√≥ximo viernes a las 00:00:00 hora local, convertida a UTC (con Z).\n\n¬´la pr√≥xima semana¬ª ‚Üí pr√≥ximo lunes a las 00:00:00 hora local, convertida a UTC (con Z).\n\nSi NO menciona fecha ‚Üí hoy a las 00:00:00 hora local, convertida a UTC (con Z).\nFormato requerido: YYYY-MM-DDTHH:MM:SSZ\nEjemplo: 2025-10-17T00:00:00Z\n\nuserText (string): mensaje original del usuario, sin modificaciones.\n\nsedePreferida (string): sede solicitada por el usuario.\nValores v√°lidos (siempre en may√∫sculas): POLANCO, SATELITE.\nNormalizaci√≥n:\n\n¬´polanco¬ª, ¬´Polanco¬ª ‚Üí POLANCO\n\n¬´sat√©lite¬ª, ¬´satelite¬ª, ¬´Satelite¬ª ‚Üí SATELITE\n\nSi NO menciona sede ‚Üí cadena vac√≠a ''.\n\ntimezone (string): enviar siempre America/Mexico_City.\n\nEjemplos\n\nUsuario: ¬´Quiero cita ma√±ana en Polanco¬ª\n‚Üí desiredStart: ma√±ana 00:00 local ‚Üí a UTC con Z\n‚Üí userText: ¬´Quiero cita ma√±ana en Polanco¬ª\n‚Üí sedePreferida: POLANCO\n\nUsuario: ¬´¬øHay horarios el viernes?¬ª\n‚Üí desiredStart: pr√≥ximo viernes 00:00 local ‚Üí a UTC con Z\n‚Üí userText: ¬´¬øHay horarios el viernes?¬ª\n‚Üí sedePreferida: ''\n\nUsuario: ¬´¬øCu√°ndo tienen disponibilidad?¬ª\n‚Üí desiredStart: hoy 00:00 local ‚Üí a UTC con Z\n‚Üí userText: ¬´¬øCu√°ndo tienen disponibilidad?¬ª\n‚Üí sedePreferida: ''\n\nReglas importantes\n\nNunca inventes horarios: usa siempre esta herramienta para consultar disponibilidad.\n\nSiempre extrae y normaliza la fecha si el usuario la menciona (convierte lenguaje natural ‚Üí ISO 8601 con Z).\n\nSedes siempre en may√∫sculas y limitarse a los valores v√°lidos indicados.\n\nLa marca Z implica UTC: calcula en hora local America/Mexico_City y convierte a UTC antes de formatear.",
        "workflowId": {
          "__rl": true,
          "value": "HtbhK8aN1uBbKCLU",
          "mode": "list",
          "cachedResultUrl": "/workflow/HtbhK8aN1uBbKCLU",
          "cachedResultName": "DISPONIBILIDAD_CALENDARIO"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "maxResults": 50,
            "desiredStart": "={{ $fromAI('desiredStart', $now.toUTC().toISO(), 'string') }}",
            "userText": "={{ $fromAI('userText', $json.mensajeUsuario || '', 'string') }}",
            "sedePreferida": "={{ $fromAI('sedePreferida', '', 'string').toUpperCase() }}",
            "timezone": "America/Mexico_City",
            "windowDays": 14,
            "requestId": "={{ $now.toMillis() + '-' + Math.random().toString(36).substr(2, 9) }}",
            "source": "urobot_whatsapp"
          },
          "matchingColumns": [
            "params"
          ],
          "schema": [
            {
              "id": "desiredStart",
              "displayName": "desiredStart",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "userText",
              "displayName": "userText",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "sedePreferida",
              "displayName": "sedePreferida",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "timezone",
              "displayName": "timezone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "windowDays",
              "displayName": "windowDays",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "maxResults",
              "displayName": "maxResults",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "includeWeekends",
              "displayName": "includeWeekends",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            },
            {
              "id": "onlyMorning",
              "displayName": "onlyMorning",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            },
            {
              "id": "onlyAfternoon",
              "displayName": "onlyAfternoon",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            },
            {
              "id": "requestId",
              "displayName": "requestId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false,
          "values": {
            "string": [
              {
                "name": "userText",
                "value": "={{$json.mensajeUsuario}}"
              },
              {
                "name": "sedePreferida",
                "value": "={{$json.sedePreferida || \"\"}}"
              },
              {
                "name": "timezone",
                "value": "America/Mexico_City"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4848,
        688
      ],
      "id": "3e835cab-bf7c-4632-acd7-1638fd5c0165",
      "name": "call'GET_DISPONIBILIDAD_CALENDARIOS"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "=NOMBRE: UroBot ‚Äî Asistente de Agenda M√©dica del Dr. Mario Mart√≠nez Thomas (Urolog√≠a)\n\nFECHA_HOY: {{ $today.setZone('America/Mexico_City').toFormat('dd/MM/yyyy') }}\n\nHORA_AHORA: {{ $now.setZone('America/Mexico_City').toFormat('HH:mm') }}\n\nOBJETIVO\nAtender a pacientes por chat de manera empatica, proactiva con la finalidad de poder asistirlos para agendar consulta o llevar el lead hacia la consulta (WhatsApp/web): consultar disponibilidad, agendar, reagendar, escalar a humano, enviar confirmaciones y educar (RAG) sin dar diagn√≥sticos. Mantener privacidad y UX cl√≠nica impecable.\n\nIdentidad, estilo y l√≠mites\n\nTono: profesional, cercano y emp√°tico. Usa ‚Äút√∫‚Äù.\n\nBrevedad: m√°x. 4‚Äì5 l√≠neas por bloque; 1 dato por turno.\n\nLenguaje: m√©dico accesible; explica t√©rminos sin jerga.\n\nProactivo: si algo falla, ofrece alternativas concretas.\n\nNunca: exponer IDs, eventId, UUID, timestamps ISO, errores internos, ni ‚Äúpensamientos‚Äù.\n\nPol√≠ticas de seguridad cl√≠nica (m√°xima prioridad)\n\nUrgencias (deriva de inmediato, no agendar): dolor insoportable, sangrado abundante, fiebre >38.5¬∞C con escalofr√≠os, retenci√≥n urinaria, trauma genital severo, hinchaz√≥n testicular s√∫bita y dolorosa, priapismo >4h, hematuria con dolor severo, infecci√≥n con fiebre alta.\nMensaje (copiar textual):\n\nüö® IMPORTANTE: Tu situaci√≥n requiere atenci√≥n m√©dica urgente ahora.\nüè• √Ångeles Santa M√≥nica (Polanco) ‚Äî Tem√≠stocles 210, 24 h\nüè• San √Ångel Inn Sat√©lite ‚Äî Circuito Centro Comercial 2251, 24 h\nSi el dolor es intenso o hay sangrado abundante, llama al 911.\nDespu√©s de urgencias, te ayudo a agendar control con el Dr. Mario.\n\nSedes, horarios y costos (responder directo, sin herramientas ni RAG)\n\nüìç POLANCO ‚Äî Hospital √Ångeles Santa M√≥nica\n\nDirecci√≥n: Av. Tem√≠stocles 210, Polanco IV Secci√≥n, Miguel Hidalgo, 11550 CDMX\n\nGOOGLE MAPS https://maps.app.goo.gl/WfDcuYRKghxjf13F8\n\nHorarios: Lunes 09:00‚Äì13:00 ‚Ä¢ Martes 16:00‚Äì20:00 ‚Ä¢ Viernes 15:00‚Äì19:00\n\nüìç SAT√âLITE ‚Äî Hospital San √Ångel Inn Sat√©lite\n\nDirecci√≥n: Circuito Centro Comercial 2251, Ciudad Sat√©lite, Naucalpan, Edo. M√©x., 53100\n\nGOOGLE MAPS https://share.google/KKsa4h5nPRZqAl4Ih\n\nHorarios: Mi√©rcoles 09:00‚Äì13:00 ‚Ä¢ Jueves 09:00‚Äì13:00 y 15:00‚Äì20:00 ‚Ä¢ S√°bados alternos 09:00‚Äì13:00\n\nDetecci√≥n por texto: satelite/sat√©lite, san angel inn, naucalpan, plaza sat√©lite, edo mex\n\nTarifas (MXN)\n\nConsulta inicial/subsecuente: $1,200\n\nVPH l√°ser CO‚ÇÇ: $3,500 (otras lesiones: a cotizar)\n\nCirug√≠as (aprox, incluye honorarios + seguimiento):\n\nCircuncisi√≥n (l√°ser CO‚ÇÇ): $16,000\n\nVasectom√≠a sin bistur√≠: $12,500\n\nBiopsia prost√°tica con sedaci√≥n: $15,000\nNo incluyen estudios preop ($800‚Äì$2,000 aprox.). Pago: efectivo/transferencia. Facturaci√≥n disponible. Sin convenio directo (recibo para reembolso).\n\nPol√≠tica de herramientas (router estricto)\n\nSIEMPRE usa herramientas para log√≠stica; jam√°s inventes disponibilidad.\n\nGET_DISPONIBILIDAD_CALENDARIOS ‚Üí cuando pidan horarios/fechas o digan ‚Äú¬øcu√°ndo hay?‚Äù\n\nAGENDAR_CONSULTA ‚Üí cuando elijan un horario mostrado\n\nREAGENDAR_CONSULTA ‚Üí cambiar fecha/hora/sede de una cita existente\n\nESCALAR_A_HUMANO ‚Üí si lo piden, caso complejo, facturaci√≥n, cirug√≠a, frustraci√≥n\n\nLEAD_TRACKER ‚Üí al detectar prospecto (nombre + tel) antes de cita\n\nRAG_EDUCATIVO ‚Üí s√≥lo educaci√≥n (procedimientos/condiciones); no log√≠stica (horarios, costos, direcciones)\n\nRazonamiento: piensa en privado y no muestres tu proceso; comparte √∫nicamente la respuesta final. Si necesitas datos o acciones, llama herramienta.\n\nValidaciones obligatorias (antes de llamar herramientas)\n\nFecha/hora: futura ‚â• 2 h.\n\nSede: POLANCO | SATELITE (normaliza variantes).\n\nTel√©fono: MX10 (quitar +52/521/01/044/045, espacios y guiones).\n\nTipo de cita: primera_vez | subsecuente.\n\nMotivo: texto ‚â• 3 palabras (capitaliza 1¬™, evita ‚Äúsolo checar‚Äù).\n\nTZ: interpreta en CDMX y convierte a UTC (Z) internamente (no sumes offsets a mano).\n\nNormalizaci√≥n de datos\n\nFechas: entrada natural ‚Üí YYYY-MM-DD (local); herramientas requieren UTC YYYY-MM-DDT00:00:00Z para desiredStart (disponibilidad) y start/end ISO (agendar).\n\nHoras: acepta 12h; convierte a HH:mm 24h.\n\nSede: mapea sin√≥nimos (polanco/√°ngeles/tem√≠stocles ‚Üí POLANCO; sat√©lite/satelite/san angel inn/naucalpan/edo mex ‚Üí SATELITE).\n\nNombre: capitaliza cada palabra (con acentos).\n\nPrivacidad: nunca muestres IDs/eventId/ISO en chat; solo ‚ÄúViernes 25 de octubre, 3:00 PM‚Äù.\n\nPlantillas (NLG) y UX\n\nDisponibilidad (mostrar m√°x. 5 por sede, agrupado por d√≠a):\n\n‚ÄúEncontr√© estas opciones:\nPolanco ‚Äî Vie 25: 3:00 PM, 3:30 PM ‚Ä¢ Lun 28: 9:30 AM\nSat√©lite ‚Äî Jue 31: 5:00 PM, 6:00 PM\n¬øCu√°l te acomoda?‚Äù\n\nAgendado (√©xito):\n\n‚Äú‚úÖ ¬°Cita confirmada!\nüìÖ [D√≠a completo, fecha]\nüïê [Hora 12h] (30 min)\nüìç [Sede + hospital]\n¬øTe env√≠o la ubicaci√≥n en Google Maps?‚Äù\n\nConflicto (slot no disponible):\n\n‚ÄúEse horario se ocup√≥. Te propongo estas opciones cercanas: [3‚Äì5 alternativas]. ¬øCu√°l eliges?‚Äù\n\nReagendado (√©xito):\n\nDevuelve exactamente response.messages.urobot (no edites).\n\nEscalado (con consentimiento):\n\n‚ÄúEntiendo. M√≥nica puede ayudarte por WhatsApp. ¬øTe la comunico?‚Äù\n(Si ‚Äús√≠‚Äù ‚Üí herramienta; devuelve exactamente agent_message).\n\nHerramientas (contratos JSON)\n1) GET_DISPONIBILIDAD_CALENDARIOS\n\nCu√°ndo: preguntan por horarios/fechas/sedes o intenciones de agendar.\nEntrada:\n\n{\n  \"desiredStart\": \"YYYY-MM-DDT00:00:00Z\",\n  \"sedePreferida\": \"POLANCO|SATELITE|\",\n  \"userText\": \"<texto original>\",\n  \"timezone\": \"America/Mexico_City\",\n  \"includeWeekends\": true,\n  \"onlyMorning\": false,\n  \"onlyAfternoon\": false\n}\n\n\nSalida (ejemplo):\n\n{\n  \"slots\": [\n    {\n      \"slotId\": \"S1abc123\",\n      \"sede\": \"POLANCO\",\n      \"start\": \"2025-10-25T21:00:00.000Z\",\n      \"end\": \"2025-10-25T21:30:00.000Z\",\n      \"startLocal\": \"25/10/2025 03:00 PM\",\n      \"endLocal\": \"25/10/2025 03:30 PM\",\n      \"durationMinutes\": 30,\n      \"dayKey\": \"2025-10-25\",\n      \"startHM\": \"15:00\"\n    }\n  ],\n  \"summary\": { \"source\": \"calendars\", \"requestId\": \"...\" }\n}\n\n\nReglas de presentaci√≥n: solo muestra d√≠a + hora legibles (no slotId/ISO), m√°ximo 5 por sede, agrupado por d√≠a.\n\n2) AGENDAR_CONSULTA\n\nPrerequisitos: slotId mostrado + nombre + tel MX10 + tipoCita + motivo ‚â•3 palabras.\nEntrada:\n\n{\n  \"slotId\": \"S1abc123\",\n  \"sede\": \"POLANCO\",\n  \"start\": \"2025-10-25T21:00:00.000Z\",\n  \"end\": \"2025-10-25T21:30:00.000Z\",\n  \"paciente\": {\n    \"nombre\": \"Juan P√©rez L√≥pez\",\n    \"telefono\": \"5512345678\",\n    \"email\": \"opcional@mail.com\"\n  },\n  \"tipoCita\": \"primera_vez\",\n  \"motivoConsulta\": \"Dolor al orinar con peque√±as gotas de sangre\",\n  \"idempotencyKey\": \"hash(telefono|start|sede)\"\n}\n\n\nRespuestas esperadas:\n\nBOOKED ‚Üí env√≠a plantilla de √©xito + ofrece Maps.\n\nCONFLICT ‚Üí re-consulta disponibilidad ¬±2 d√≠as (misma sede) y ofrece 3‚Äì5 opciones.\n\nPARTIAL_ERROR / ERROR ‚Üí disculpa breve + reintento o escalar.\n\n3) REAGENDAR_CONSULTA\n\nCu√°ndo: ‚Äúcambiar/mover/reagendar‚Äù.\nPrerequisitos: tel MX10 + newDate (YYYY-MM-DD, local) + newTime (HH:mm 24h, local) + newSede.\nEntrada:\n\n{\n  \"telefono\": \"5512345678\",\n  \"consultaId\": \"\",\n  \"newDate\": \"2025-10-28\",\n  \"newTime\": \"15:00\",\n  \"newSede\": \"POLANCO\",\n  \"reason\": \"Conflicto laboral\"\n}\n\n\nRespuestas:\n\nRESCHEDULED ‚Üí devuelve tal cual response.messages.urobot.\n\nNOT_FOUND ‚Üí explica y ofrece agendar nuevo.\n\nUNAVAILABLE ‚Üí consulta disponibilidad ¬±3 d√≠as y ofrece 3‚Äì5 opciones.\n\nDAY_NOT_AVAILABLE / TIME_OUT_OF_RANGE / VALIDATION_ERROR ‚Üí explica rango v√°lido y propone horas.\n\n4) ESCALAR_A_HUMANO\n\nCu√°ndo: lo piden, frustraci√≥n, facturaci√≥n, cirug√≠a, caso complejo, preferencia de llamada.\nFlujo: pedir permiso ‚Üí herramienta ‚Üí devolver agent_message al usuario sin texto extra.\nEntrada:\n\n{\n  \"telefono\": \"5512345678\",\n  \"nombrePaciente\": \"Juan P√©rez L√≥pez\",\n  \"motivo\": \"facturacion|cirugia|frustracion|llamada|solicitud_explicita|otro\",\n  \"contexto\": \"Resumen breve (2‚Äì4 oraciones).\",\n  \"prioridad\": \"alta|normal\"\n}\n\n5) LEAD_TRACKER\n\nCu√°ndo: detectes prospecto (nombre + tel), incluso antes de agendar.\nEntrada m√≠nima:\n\n{\n  \"nombre_completo\": \"Juan P√©rez L√≥pez\",\n  \"telefono_whatsapp\": \"5512345678\",\n  \"fuente_lead\": \"WhatsApp\",\n  \"notas_iniciales\": \"Quiere costos de vasectom√≠a\",\n  \"session_id\": \"<si aplica>\"\n}\n\n\nComportamiento: dedupe por MX10, actualizar ultima_interaccion, total_interacciones.\n\n6) RAG_EDUCATIVO (solo info m√©dica general)\n\nCu√°ndo: explicar procedimientos/condiciones (p.ej., vasectom√≠a, circuncisi√≥n, VPH, HBP).\nReglas: no usar RAG para horarios/costos/direcciones/log√≠stica. A√±ade disclaimer: ‚ÄúNo sustituye valoraci√≥n m√©dica‚Äù.\n\nReglas de razonamiento y privacidad\n\nRazonamiento interno: piensa paso a paso en privado; no compartas tu proceso ni listas de reglas.\n\nSalida: solo respuestas finales amigables y/o plantillas definidas.\n\nPrivacidad: censura cualquier rastro t√©cnico; si la herramienta devuelve ISO/IDs, no los muestres.\n\nEjemplos (few-shot)\n\nEjemplo 1 ‚Äî Pedir disponibilidad general\nUsuario: ‚Äú¬øCu√°ndo hay citas en Sat√©lite la pr√≥xima semana por la tarde?‚Äù\nAgente (interno): Llama GET_DISPONIBILIDAD_CALENDARIOS con desiredStart a lunes prox. sedePreferida=\"SATELITE\", onlyAfternoon=true.\nAgente (usuario): ‚ÄúTengo estas opciones en Sat√©lite: Mi√© 5:00 PM ‚Ä¢ Jue 6:00 PM ‚Ä¢ S√°b 11:30 AM. ¬øCu√°l te acomoda?‚Äù\n\nEjemplo 2 ‚Äî Agendar\nUsuario: ‚ÄúLa de Jueves 6:00 PM en Sat√©lite.‚Äù\nAgente: ‚ÄúPerfecto. ¬øTu nombre completo?‚Äù ‚Üí ‚Äú¬øTu n√∫mero a 10 d√≠gitos?‚Äù ‚Üí ‚Äú¬øEs primera vez o subsecuente?‚Äù ‚Üí ‚Äú¬øMotivo de tu consulta?‚Äù (‚â•3 palabras) ‚Üí Llama AGENDAR_CONSULTA.\nRespuesta (√©xito): ‚Äú‚úÖ ¬°Cita confirmada! Jueves 6:00 PM ‚Ä¢ Sat√©lite. ¬øTe env√≠o ubicaci√≥n en Maps?‚Äù\n\nEjemplo 3 ‚Äî Reagendar\nUsuario: ‚ÄúNo puedo ma√±ana, ¬ølo movemos al viernes 3:30 PM en Polanco?‚Äù\nAgente: valida MX10; convierte 3:30 PM ‚Üí 15:30; llama REAGENDAR_CONSULTA.\nSi UNAVAILABLE: ‚ÄúEse horario no est√° libre. Te propongo: Vie 3:00 PM ‚Ä¢ 4:00 PM, o Lun 9:30 AM. ¬øCu√°l te funciona?‚Äù\n\nEjemplo 4 ‚Äî Escalar\nUsuario: ‚ÄúQuiero hablar con alguien por WhatsApp para facturar.‚Äù\nAgente: ‚ÄúClaro, M√≥nica puede ayudarte. ¬øLa contacto ahora?‚Äù (si ‚Äús√≠‚Äù ‚Üí herramienta; devolver agent_message).\n\nEjemplo 5 ‚Äî Educaci√≥n (RAG)\nUsuario: ‚Äú¬øC√≥mo es la vasectom√≠a?‚Äù\nAgente: Resumen breve (qu√© es, duraci√≥n, anestesia local, recuperaci√≥n t√≠pica) + ‚ÄúEsto no sustituye una valoraci√≥n m√©dica. ¬øAgendamos para revisar tu caso?‚Äù\n\nChecklist final (antes de responder)\n\n¬øEvalu√© urgencias?\n\n¬øUs√© la herramienta correcta (disp/agendar/reagendar/escalar/RAG)?\n\n¬øValid√© MX10, fecha futura ‚â•2 h, franja v√°lida de la sede?\n\n¬øConvert√≠ CDMX ‚Üí UTC (Z) sin sumar offsets manuales?\n\n¬øMostr√© solo fecha/hora legibles (sin ISO/IDs)?\n\n¬øFui conciso y ofrec√≠ alternativas si algo fall√≥?\n\nRespuestas r√°pidas (snippets)\n\nHorarios por sede (gen√©rico):\n‚ÄúEl Dr. Mario consulta en Polanco (Lun 9‚Äì13, Mar 16‚Äì20, Vie 15‚Äì19) y Sat√©lite (Mi√© 9‚Äì13, Jue 9‚Äì13 y 15‚Äì20, S√°bados alternos 9‚Äì13). ¬øPrefieres sede y d√≠a?‚Äù\n\nDirecciones completas:\n\nPOLANCO ‚Äî √Ångeles Santa M√≥nica, Tem√≠stocles 210, Polanco. ¬øTe env√≠o Maps?\n\nSAT√âLITE ‚Äî San √Ångel Inn Sat√©lite, Circuito Centro Comercial 2251. ¬øTe env√≠o Maps?\n\nCostos:\n‚ÄúLa consulta cuesta $1,200. ¬øDeseas agendar? Para vasectom√≠a: $12,500 (aprox).‚Äù\n\nNotas operativas\n\nUsa AGENDAR_CONSULTA con idempotencyKey = hash(telefono|start|sede).\n\nEn reagendos, preferir actualizar evento; si cambia de sede (calendario) entonces crear nuevo.\n\nRegistra leads tempranos con LEAD_TRACKER (dedupe por MX10).\n\nPara escalado, devuelve exactamente agent_message de la herramienta.",
          "returnIntermediateSteps": false,
          "batching": {},
          "enableStreaming": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        5024,
        368
      ],
      "id": "899a9bed-2cdf-4569-a4c2-f0eb4c1f3586",
      "name": "Urobot"
    },
    {
      "parameters": {
        "jsCode": "/**\n * WhatsApp Formatter v13.0 - NATURAL Y CONVERSACIONAL\n * Sistema de Agendamiento - Dr. Mario Mart√≠nez Thomas\n * Enfoque: Texto natural, sin espaciado excesivo, conversacional\n */\n\nreturn items.map(item => {\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // CONFIGURACI√ìN\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const CONFIG = {\n    maxLength: 1400,\n    formatPhones: true,\n    useSeparators: true,\n    separatorStyle: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',\n    useEmojis: true,\n    naturalMode: true,  // Modo natural activado\n    maxConsecutiveBreaks: 1  // M√°ximo 1 l√≠nea en blanco entre p√°rrafos\n  };\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // EXTRACCI√ìN DE TEXTO\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const extractText = () => {\n    const sources = [\n      item?.json?.output,\n      item?.json?.text,\n      item?.json?.message,\n      $json?.output,\n      $input?.first()?.json?.output,\n      ''\n    ];\n    \n    const text = sources.find(v => v !== undefined && v !== null);\n    \n    if (typeof text === 'string') return text;\n    if (!text) return '';\n    if (Array.isArray(text)) return text.join('\\n');\n    if (typeof text === 'object') {\n      try { return JSON.stringify(text, null, 2); }\n      catch { return String(text); }\n    }\n    return String(text);\n  };\n\n  let text = extractText();\n  \n  if (!text || text.trim().length === 0) {\n    return { json: { success: false, error: 'Sin contenido', output: '' } };\n  }\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // LIMPIEZA PROFUNDA\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const deepClean = (str) => {\n    str = str.normalize('NFC');\n    str = str.replace(/\\\\n/g, '\\n').replace(/\\\\r\\\\n/g, '\\n').replace(/\\r\\n?/g, '\\n');\n    str = str.replace(/[\\u200B-\\u200D\\uFEFF\\u00AD]/g, '');\n    str = str.replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F]/g, '');\n    \n    const entities = {\n      '&nbsp;': ' ', '&amp;': '&', '&quot;': '\"', '&apos;': \"'\",\n      '&lt;': '<', '&gt;': '>', '&ldquo;': '\"', '&rdquo;': '\"'\n    };\n    Object.entries(entities).forEach(([e, c]) => {\n      str = str.replace(new RegExp(e, 'gi'), c);\n    });\n    str = str.replace(/&#(\\d+);/g, (_, d) => String.fromCharCode(parseInt(d, 10)));\n    str = str.replace(/&#x([0-9A-Fa-f]+);/g, (_, h) => String.fromCharCode(parseInt(h, 16)));\n    \n    str = str.replace(/<\\/(p|div|br|li|h[1-6]|tr|td)\\s*>/gi, '\\n');\n    str = str.replace(/<(p|div|br|li|h[1-6]|tr|td)[^>]*>/gi, '\\n');\n    str = str.replace(/<[^>]+>/g, '');\n    \n    str = str.replace(/\\*\\*/g, '');\n    str = str.replace(/\\*(?!\\s*\\n)/g, '');\n    str = str.replace(/(?<=\\s)\\*(?=\\w)/g, '');\n    str = str.replace(/_{2,}/g, '');\n    \n    str = str.replace(/[\\t\\f\\v]+/g, ' ');\n    str = str.replace(/\\u00A0/g, ' ');\n    str = str.replace(/ {2,}/g, ' ');\n    str = str.replace(/^ +/gm, '');\n    str = str.replace(/ +$/gm, '');\n    \n    str = str.replace(/([sS]√°bado)\\s+s:/gi, '$1s:');\n    str = str.replace(/(üìç)\\s*\\1+/g, '$1');\n    str = str.replace(/(üè•)\\s*\\1+/g, '$1');\n    \n    // ‚úÖ CR√çTICO: Limitar l√≠neas en blanco a m√°ximo 2 (una l√≠nea vac√≠a)\n    str = str.replace(/\\n{3,}/g, '\\n\\n');\n    \n    str = str.replace(/\\.{4,}/g, '...');\n    str = str.replace(/\\s+([,.;:!?¬°¬ø])/g, '$1');\n    str = str.replace(/([¬°¬ø])\\s+/g, '$1');\n    str = str.replace(/([.!?]){2,}/g, '$1');\n    \n    return str.trim();\n  };\n\n  text = deepClean(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // FORMATO NATURAL Y CONVERSACIONAL\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  /**\n   * Procesa y formatea el texto de manera NATURAL\n   * SIN agregar espacios innecesarios\n   */\n  const formatNatural = (txt) => {\n    const lines = txt.split('\\n');\n    const formatted = [];\n    let hoursList = [];\n    let currentDate = null;\n    \n    for (let i = 0; i < lines.length; i++) {\n      let line = lines[i].trim();\n      \n      // Saltar l√≠neas vac√≠as pero mantener UNA si ya hay contenido\n      if (!line) {\n        // Solo agregar l√≠nea vac√≠a si la anterior no era vac√≠a\n        if (formatted.length > 0 && formatted[formatted.length - 1] !== '') {\n          // ‚úÖ CAMBIO CR√çTICO: Solo agregar si la siguiente l√≠nea es una SEDE o separador importante\n          const nextNonEmpty = lines.slice(i + 1).find(l => l.trim() !== '');\n          if (nextNonEmpty && (\n            /^(?:üìç\\s*)?(SEDE\\s+)/i.test(nextNonEmpty) ||\n            /^(?:‚îÄ{5,}|={5,}|-{5,})$/.test(nextNonEmpty)\n          )) {\n            formatted.push('');\n          }\n        }\n        continue;\n      }\n      \n      // SEDE - Formato compacto\n      if (/^(?:üìç\\s*)?(SEDE\\s+(?:POLANCO|SAT[√âE]LITE|DE\\s+POLANCO|DE\\s+SAT[√âE]LITE))/i.test(line)) {\n        // Guardar lista de horas si existe\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        if (formatted.length > 0 && formatted[formatted.length - 1] !== '') {\n          formatted.push('');\n        }\n        \n        let sedeName = line.replace(/^üìç\\s*/i, '').trim();\n        sedeName = sedeName.replace(/^SEDE\\s+DE\\s+/i, 'SEDE ');\n        \n        if (CONFIG.useSeparators) {\n          formatted.push(CONFIG.separatorStyle);\n        }\n        formatted.push(`üìç ${sedeName.toUpperCase()}`);\n        continue;\n      }\n      \n      // HOSPITAL - en la misma l√≠nea que SEDE si es posible\n      if (/^(?:üè•\\s*)?Hospital/i.test(line)) {\n        line = line.replace(/^üè•\\s*/i, '').trim();\n        formatted.push(`üè• ${line}`);\n        continue;\n      }\n      \n      // HORARIOS DE CONSULTA (Lunes: 9:00-13:00)\n      const dayMatch = line.match(/^(Lunes|Martes|Mi[√©e]rcoles|Jueves|Viernes|S[√°a]bados?|Domingo)s?:?\\s*(.+)/i);\n      if (dayMatch) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        const day = dayMatch[1].charAt(0).toUpperCase() + dayMatch[1].slice(1).toLowerCase();\n        let time = dayMatch[2].trim();\n        const dayFixed = day === 'S√°bado' && line.toLowerCase().includes('s√°bados') ? 'S√°bados' : day;\n        \n        formatted.push(`${dayFixed}: ${time}`);\n        continue;\n      }\n      \n      // FECHAS (Viernes 24 de octubre) - Inicio de lista compacta\n      const dateMatch = line.match(/^(Lunes|Martes|Mi[√©e]rcoles|Jueves|Viernes|S[√°a]bado|Domingo)\\s+\\d{1,2}\\s+de\\s+\\w+/i);\n      if (dateMatch) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n        }\n        \n        currentDate = line;\n        hoursList = [];\n        continue;\n      }\n      \n      // HORAS en lista (3:00 PM, 3:30 PM, etc.)\n      if (/^\\d{1,2}:\\d{2}\\s*(?:AM|PM)?/i.test(line) || /^[‚Ä¢\\-*]\\s*\\d{1,2}:\\d{2}/i.test(line)) {\n        const hour = line.replace(/^[‚Ä¢\\-*]\\s*/, '').trim();\n        hoursList.push(hour);\n        continue;\n      }\n      \n      // RANGOS DE HORARIOS (de 3:00 PM a 6:30 PM)\n      if (/de\\s+\\d{1,2}:\\d{2}\\s*(?:AM|PM)?\\s*a\\s*\\d{1,2}:\\d{2}\\s*(?:AM|PM)?/i.test(line)) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        formatted.push(line);\n        continue;\n      }\n      \n      // LISTAS con vi√±etas (- o ‚Ä¢)\n      if (/^[-‚Ä¢]\\s+/.test(line)) {\n        const content = line.replace(/^[-‚Ä¢]\\s+/, '').trim();\n        formatted.push(`‚Ä¢ ${content}`);\n        continue;\n      }\n      \n      // ‚úÖ CAMBIO CR√çTICO: PREGUNTAS - NO agregar l√≠nea en blanco antes\n      if (/^[¬ø?]/.test(line)) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        // NO agregar l√≠nea en blanco aqu√≠, solo agregar la pregunta\n        formatted.push(line);\n        continue;\n      }\n      \n      // L√≠nea normal\n      if (line.length > 0) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        formatted.push(line);\n      }\n    }\n    \n    // Guardar √∫ltima lista si existe\n    if (hoursList.length > 0) {\n      formatted.push(formatHoursList(hoursList));\n    }\n    \n    return formatted.join('\\n');\n  };\n  \n  /**\n   * Formatea lista de horas de manera compacta\n   */\n  const formatHoursList = (hours) => {\n    if (hours.length === 0) return '';\n    \n    // Si son muchas horas consecutivas, resumir\n    if (hours.length >= 8 && areConsecutive(hours)) {\n      const first = hours[0];\n      const last = hours[hours.length - 1];\n      return `Horarios: ${first} - ${last} (cada 30 min)`;\n    }\n    \n    // Si son menos de 6, mostrar en l√≠nea\n    if (hours.length <= 6) {\n      return `Horarios: ${hours.join(' ‚Ä¢ ')}`;\n    }\n    \n    // Si son m√°s, dividir en l√≠neas de 6\n    const result = ['Horarios disponibles:'];\n    for (let i = 0; i < hours.length; i += 6) {\n      const chunk = hours.slice(i, i + 6);\n      result.push(`  ${chunk.join(' ‚Ä¢ ')}`);\n    }\n    return result.join('\\n');\n  };\n  \n  /**\n   * Verifica si las horas son consecutivas (cada 30 min)\n   */\n  const areConsecutive = (hours) => {\n    if (hours.length < 2) return false;\n    \n    for (let i = 0; i < hours.length - 1; i++) {\n      const current = parseTime(hours[i]);\n      const next = parseTime(hours[i + 1]);\n      if (!current || !next) return false;\n      \n      const diff = next - current;\n      if (diff !== 30 && diff !== 60) return false;\n    }\n    \n    return true;\n  };\n  \n  /**\n   * Convierte hora a minutos\n   */\n  const parseTime = (timeStr) => {\n    const match = timeStr.match(/(\\d{1,2}):(\\d{2})\\s*(AM|PM)?/i);\n    if (!match) return null;\n    \n    let hours = parseInt(match[1]);\n    const minutes = parseInt(match[2]);\n    const period = match[3]?.toUpperCase();\n    \n    if (period === 'PM' && hours !== 12) hours += 12;\n    if (period === 'AM' && hours === 12) hours = 0;\n    \n    return hours * 60 + minutes;\n  };\n\n  text = formatNatural(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // LIMPIEZA FINAL - CONVERSACIONAL\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const formatPhones = (txt) => {\n    if (!CONFIG.formatPhones) return txt;\n    return txt.replace(\n      /(?:^\\+?52[\\s-]*)?(\\d{2})[\\s-]*(\\d{4})[\\s-]*(\\d{4})/g,\n      '($1) $2-$3'\n    );\n  };\n\n  const addSubtleHighlights = (txt) => {\n    return txt.replace(\n      /\\$\\s*[\\d,]+(?:\\.\\d{2})?(?:\\s*(?:MXN|pesos))?/gi,\n      match => `*${match.trim()}*`\n    );\n  };\n\n  const finalCleanup = (txt) => {\n    // ‚úÖ Eliminar espacios m√∫ltiples\n    txt = txt.replace(/  +/g, ' ');\n    \n    // ‚úÖ CR√çTICO: Limitar a M√ÅXIMO 2 saltos de l√≠nea (1 l√≠nea en blanco)\n    txt = txt.replace(/\\n{3,}/g, '\\n\\n');\n    \n    // ‚úÖ NO agregar l√≠neas en blanco antes de preguntas\n    txt = txt.replace(/\\n\\n([¬ø?])/g, '\\n$1');\n    \n    // ‚úÖ Asegurar que las listas no tengan l√≠neas en blanco extra\n    txt = txt.replace(/\\n\\n(‚Ä¢ )/g, '\\n$1');\n    \n    return txt.trim();\n  };\n\n  text = formatPhones(text);\n  text = addSubtleHighlights(text);\n  text = finalCleanup(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // DIVISI√ìN INTELIGENTE\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const smartSplit = (txt) => {\n    if (txt.length <= CONFIG.maxLength) return [txt];\n    \n    const messages = [];\n    const separator = CONFIG.useSeparators ? CONFIG.separatorStyle : '---';\n    const sections = txt.split(new RegExp(separator, 'g'));\n    let current = '';\n    \n    for (let i = 0; i < sections.length; i++) {\n      const section = sections[i].trim();\n      if (!section) continue;\n      \n      const piece = i > 0 ? `${separator}\\n${section}` : section;\n      \n      if (current.length + piece.length > CONFIG.maxLength && current) {\n        messages.push(current.trim() + '\\n\\n_(contin√∫a...)_');\n        current = piece;\n      } else {\n        current += (current ? '\\n\\n' : '') + piece;\n      }\n    }\n    \n    if (current) messages.push(current.trim());\n    return messages;\n  };\n\n  const messages = smartSplit(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // OUTPUT FINAL\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  return {\n    json: {\n      output: messages[0],\n      success: true,\n      messageCount: messages.length,\n      totalLength: text.length,\n      allMessages: messages.length > 1 ? messages : undefined,\n      processed: {\n        cleaned: true,\n        formatted: true,\n        style: 'natural-conversational',\n        timestamp: new Date().toISOString()\n      }\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5760,
        368
      ],
      "id": "291b53a3-2a4f-4fbd-9d73-0fb7b8a34f45",
      "name": "Limpiar respuesta de agente1",
      "retryOnFail": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11159216-7689-4618-a01d-55c07a8c2775",
              "name": "=mensajeUsuario",
              "value": "={{ \n  $json.mensajeUsuario \n  || $node[\"Armar Respuesta\"]?.json?.transcripcion \n  || $node[\"Transcribe a recording\"]?.json?.text\n  || $node[\"Webhook1\"].json.body.data.messages.message.conversation \n  || '' \n}}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4400,
        272
      ],
      "id": "50748c34-5aa8-44bb-a487-9c9c94eede7c",
      "name": "Mapear Mensaje1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook1').item.json.body.data.messages.message.audioMessage }}",
                    "rightValue": true,
                    "operator": {
                      "type": "object",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "4d9ae069-2fd0-49e8-b69b-d91e745af3e8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "24fd1f58-d0a5-4116-80c0-4f0ba4b4f828",
                    "leftValue": "={{ $('Webhook1').item.json.body.data.messages.message }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3280,
        272
      ],
      "id": "ae82bfb8-1382-4a78-a99b-eff280881381",
      "name": "Switch1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb412f41-019f-4bb8-a452-e665d1027e0a",
              "name": "=numeroRemitente",
              "value": "={{$json.body.data.messages.key.remoteJid}}",
              "type": "string"
            },
            {
              "id": "1cb507bf-fc90-413c-9eea-16526b334494",
              "name": "nombreUsuario",
              "value": "={{$json.body.data.messages.pushName}}",
              "type": "string"
            },
            {
              "id": "b75d41bd-9b6b-4b8d-a118-8d6691cc1c6a",
              "name": "mensajeUsuario",
              "value": "={{$json.body.data.messages.message.conversation}}",
              "type": "string"
            },
            {
              "id": "b3fd2c11-5469-4b0c-833d-eb03bcf21cef",
              "name": "body.sessionId",
              "value": "={{ $json.body.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3056,
        176
      ],
      "id": "c16efece-499b-410f-b72a-9cf59686e6af",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "e257a96a-f46a-4a68-b7b7-79f3dadfbe2b",
        "options": {
          "rawBody": false
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2832,
        176
      ],
      "id": "9739dcc7-ca5a-498f-b83f-8e3753d75f2d",
      "name": "Webhook1",
      "webhookId": "e257a96a-f46a-4a68-b7b7-79f3dadfbe2b"
    },
    {
      "parameters": {
        "options": {
          "maxOutputTokens": 65536
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4400,
        704
      ],
      "id": "bcd9f9d0-7bbb-47b5-b398-65a89ef20e37",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "xlzbIxHOowfqL2yj",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "    \"toolDescription\": \"utiliza esta herramienta cuando el usuario pregunte acerca de procedimientos urol√≥gicos. Aqu√≠ es donde encontrar√°s contexto relevante para las respuestas.\\n\\nEn esta herramienta tambi√©n contamos con informaci√≥n relevante del dr mario\",\n",
        "tableName": {
          "__rl": true,
          "value": "conocimiento_procedimientos_urologia",
          "mode": "list",
          "cachedResultName": "conocimiento_procedimientos_urologia"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        5008,
        592
      ],
      "id": "baf0b1fc-3408-4a9d-91e3-1d9e3e415fd3",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "Uq22EkraEAEoR2CQ",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        5088,
        800
      ],
      "id": "638fb612-e6d7-45c4-b77b-b0b4bc42ffe6",
      "name": "Embeddings Google Gemini",
      "credentials": {
        "googlePalmApi": {
          "id": "xlzbIxHOowfqL2yj",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "description": "Usa esta herramienta INMEDIATAMENTE cuando detectes cualquiera de estas situaciones:\n\nSITUACIONES QUE REQUIEREN ESCALAMIENTO:\n\n1. SOLICITUD EXPLICITA\n   - \"Quiero hablar con alguien\"\n   - \"Necesito una persona\"\n   - \"Comuniquenme con un asesor\"\n   - \"Prefiero hablar con un humano\"\n\n2. FACTURACION Y COMPROBANTES\n   - Solicita factura, CFDI, o comprobante fiscal\n   - Menciona RFC o razon social\n   - Necesita datos fiscales\n\n3. PROGRAMAR CIRUGIA\n   - Quiere AGENDAR una cirugia (no solo preguntar sobre ella)\n   - Solicita fecha para operacion\n   - Pregunta \"cuando me pueden operar\"\n\n4. FRUSTRACION O MOLESTIA\n   - Muestra enojo, frustracion, o insatisfaccion\n   - Dice que \"no le ayudas\" o \"no entiende\"\n   - Expresa quejas sobre el servicio\n\n5. SOLICITA LLAMADA TELEFONICA\n   - Pide explicitamente que lo llamen\n   - Dice \"llamame\" o \"pueden marcarme\"\n\n6. DUDAS COMPLEJAS SOBRE COSTOS\n   - Pregunta por descuentos o negociacion\n   - Consulta planes de pago o financiamiento\n   - Necesita cotizacion detallada\n\n7. INFORMACION QUE NO PUEDES DAR\n   - Preguntas medicas especificas que requieren al doctor\n   - Situaciones que necesitan autorizacion\n   - Casos especiales o excepciones\n\nIMPORTANTE:\n- SIEMPRE captura el historial de conversacion completo\n- Solicita permiso al paciente antes de escalar: \"¬øTe parece bien que Monica se ponga en contacto contigo?\"\n- Si el usuario acepta, ENTONCES llama a esta herramienta\n- Clasifica correctamente el motivo y la prioridad\n\nPARAMETROS:\n- telefono: numero del paciente (10 digitos, sin prefijos)\n- nombrePaciente: nombre completo\n- motivo: ['facturacion', 'programar_cirugia', 'dudas_costos', 'quiere_llamada', 'hablar_con_persona', 'informacion_adicional', 'otro']\n- contexto: resumen claro de 1-2 frases sobre lo que necesita\n- conversationHistory: DEBE incluir los ultimos 5-10 mensajes\n- prioridad: 'alta' si hay frustracion/urgencia/cirugia, 'normal' en otros casos",
        "workflowId": {
          "__rl": true,
          "value": "YRms68urnyKHe3Y7",
          "mode": "list",
          "cachedResultUrl": "/workflow/YRms68urnyKHe3Y7",
          "cachedResultName": "ESCALAR_A_HUMANO"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $fromAI('telefono', '', 'string')}}",
            "nombrePaciente": "={{ $fromAI('nombrePaciente', '', 'string') }}\n",
            "motivo": "={{ $fromAI('motivo', 'hablar_con_persona', 'string') }}",
            "contexto": "={{ $fromAI('contexto', 'El paciente solicita atencion personalizada', 'string') }}",
            "canalPreferido": "={{ $fromAI('canalPreferido', 'whatsapp', 'string') }}",
            "prioridad": "={{ $fromAI('prioridad', 'normal', 'string') }}\"\n"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "nombrePaciente",
              "displayName": "nombrePaciente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "motivo",
              "displayName": "motivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contexto",
              "displayName": "contexto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "canalPreferido",
              "displayName": "canalPreferido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "prioridad",
              "displayName": "prioridad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5264,
        704
      ],
      "id": "851831af-9f96-494a-90ff-f7475b8f3cbf",
      "name": "ESCALAR_HUMANO"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/decrypt-media",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ data: { messages: $(\"Webhook1\").item.json.body.data.messages } }) }}\n",
        "options": {}
      },
      "id": "07f0d3e8-1bf0-4462-9d9e-63e3876b877b",
      "name": "Decrypt Media (Wasender)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        3504,
        192
      ],
      "credentials": {
        "httpBearerAuth": {
          "id": "skLVidDokzorVyYh",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $(\"Decrypt Media (Wasender)\").item.json.publicUrl }}\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "options": {}
      },
      "id": "e9567efa-9632-4a95-8523-82706d3e6cc4",
      "name": "Descargar Decrypt (OGG)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        3728,
        192
      ],
      "credentials": {
        "httpBearerAuth": {
          "id": "skLVidDokzorVyYh",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "transcripcion",
              "value": "={{$json.text}}"
            }
          ]
        },
        "options": {}
      },
      "id": "bc5810de-c83c-4fdc-9385-6f1f65c1104e",
      "name": "Armar Respuesta",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        4176,
        192
      ]
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        3952,
        192
      ],
      "id": "66070287-7b33-4cbd-af6a-8e1a5ddcda29",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "TGzvTmDHFZ17RPAv",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        4400,
        464
      ],
      "id": "e37c68db-9ff5-4a9e-8da5-754f0de15f55",
      "name": "When chat message received",
      "webhookId": "aea3f6f5-6dbf-4bf7-9620-6ab470f82e22"
    },
    {
      "parameters": {
        "jsCode": "/**\n * LEAD_CAPTURE v4.1 ‚Äì SUPABASE EDITION (Alineado a esquema)\n * - Telefono_WhatsApp: 10 d√≠gitos MX (sin +) para matching y UNIQUE\n * - Fechas: ISO completo (timestamptz friendly)\n * - Saneo de UUID/fechas nulas\n * - Corrige snake_case de existing.estado\n */\n\nconst src = $input.first().json;\n\n// ---------- CONFIG ----------\nconst COOLDOWN_MIN = 10;\nconst USE_MSG_ID_DEDUP = false;\n\n// ---------- HELPERS ----------\nconst trim = (v) => (v == null ? '' : String(v).trim());\n\nfunction digitsOnly(s) {\n  s = String(s || '');\n  let out = '';\n  for (let i = 0; i < s.length; i++) {\n    const c = s.charCodeAt(i);\n    if (c >= 48 && c <= 57) out += s[i];\n  }\n  return out;\n}\n\n// Canon MX 10 d√≠gitos (√∫ltimos 10); √∫til para tu columna telefono_whatsapp\nfunction toMX10(anyPhone) {\n  const d = digitsOnly(anyPhone);\n  if (!d) return '';\n  // toma √∫ltimos 10 d√≠gitos (comportamiento t√≠pico MX)\n  return d.length >= 10 ? d.slice(-10) : d; \n}\n\n// E.164 r√°pido (por si lo quieres usar en otra capa)\nfunction toE164Fast(anyPhone, cc='52') {\n  const d = digitsOnly(anyPhone);\n  if (!d) return '';\n  // si ya viene con 52XXXXXXXXXX (12 d√≠gitos) o 10 d√≠gitos nacionales\n  if (d.length === 10) return `+${cc}${d}`;\n  if (d.length === 12 && d.startsWith(cc)) return `+${d}`;\n  return `+${d}`; // fallback\n}\n\n// A ISO completo (timestamptz). Si viene \"YYYY-MM-DD\", subo a T00:00:00Z\nfunction toISODateTime(x) {\n  if (!x) return null;\n  if (x instanceof Date && !isNaN(x)) return x.toISOString();\n  const s = trim(x);\n  if (!s) return null;\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(s)) return `${s}T00:00:00Z`;\n  const dt = new Date(s);\n  return isNaN(dt) ? null : dt.toISOString();\n}\n\nfunction titleCaseFast(name){\n  let s = trim(name);\n  if (!s) return '';\n  if (s.length <= 24 && /[A-Z√Å√â√ç√ì√ö√ë√ú]/.test(s)) return s;\n  s = s.toLowerCase();\n  const parts = s.split(' ');\n  for (let i=0;i<parts.length;i++){\n    const w = parts[i]; if (w) parts[i] = w[0].toUpperCase() + w.slice(1);\n  }\n  return parts.join(' ');\n}\n\nfunction isUuid(v){\n  if (v == null) return false;\n  const s = String(v).trim();\n  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);\n}\nfunction cleanUuidOrNull(v){\n  const s = trim(v);\n  if (!s || s.toLowerCase() === 'null') return null;\n  return isUuid(s) ? s : null;\n}\n\n// ---------- INPUTS ----------\nconst numeroRemitente = src.numeroRemitente || (src.body?.data?.messages?.key?.remoteJid) || src.Telefono_WhatsApp || '';\nconst nombreUsuario   = src.nombreUsuario || src.Nombre_Completo || 'Desconocido';\nconst mensajeUsuario  = src.mensajeUsuario || src.Notas_Iniciales || '';\nconst sessionId       = src.body?.sessionId || src.Session_ID || '';\n\nconst telefonoCanon10 = toMX10(numeroRemitente);          // <-- el que guardamos y usamos para duplicados\n// const telefonoE164    = toE164Fast(numeroRemitente);    // <-- opcional si quisieras guardarlo aparte\n\nif (!telefonoCanon10) return [];\n\n// ---------- GATING ----------\nconst existing = src._existing || null;\nconst isCreate = !existing;\n\nconst sMsg = trim(mensajeUsuario);\nconst lowMsg = sMsg.toLowerCase();\nconst stops = new Set(['ok','va','sale','gracias','de nada','hola','üëç','üëå','üòÄ','üòÉ','üòÑ','üòÅ','üëçüèª','üëçüèΩ','üëçüèø','buenos dias','buenas tardes','buenas noches']);\nconst msgIsNoise = sMsg && (sMsg.length <= 2 || stops.has(lowMsg));\nconst kws = ['cita','agenda','disponibilidad','horario','hora','costo','precio','ubicaci√≥n','polanco','sat√©lite','satelite','consulta','urgencia'];\nconst msgHasSignal = !!kws.find(k => lowMsg.includes(k));\n\nlet cooldownPassed = true;\nif (existing && (existing.ultima_interaccion || existing.ultima_interaccion === 0)){\n  const last = new Date(existing.ultima_interaccion);\n  if (!isNaN(last)) {\n    const diffMin = (Date.now() - last.getTime()) / 60000;\n    cooldownPassed = diffMin >= COOLDOWN_MIN;\n  }\n}\n\nif (!isCreate && !(msgHasSignal || cooldownPassed)) {\n  return [];\n}\n\n// ---------- BUILD OUTPUT ----------\nconst nowISO = new Date().toISOString();        // ISO completo\nconst leadId = trim(src.Lead_ID || null) || null;\n\n// OJO: existing viene de BD con snake_case\nconst estadoBD = existing?.estado || null;\nconst estado = msgHasSignal ? 'Calificado' : (isCreate ? 'Nuevo' : (estadoBD || 'Contactado'));\n\nlet notas = trim(sMsg);\nif (notas.length > 200) notas = notas.slice(0,200);\n\n// Si hay existente, preserva su fecha de primer contacto; si no, usa ahora\nconst fechaPrimerContacto = isCreate\n  ? nowISO\n  : (toISODateTime(existing?.fecha_primer_contacto) || nowISO);\n\nreturn [{\n  json: {\n    // Identidad\n    Lead_ID: leadId,                              // puede ser null (UNIQUE nullable)\n    Nombre_Completo: titleCaseFast(nombreUsuario),\n\n    // TELEFONO: la forma can√≥nica que usa tu Search Duplicate y UNIQUE\n    Telefono_WhatsApp: telefonoCanon10,           // <-- 10 d√≠gitos MX\n\n    // Meta\n    Fuente_Lead: 'WhatsApp',\n    Fecha_Primer_Contacto: fechaPrimerContacto,   // timestamptz ISO\n    Estado: estado,\n    Notas_Iniciales: notas,\n    Session_ID: sessionId,\n\n    // Interacciones\n    ultima_interaccion: nowISO,                   // timestamptz ISO\n    total_interacciones: isCreate ? 1 : (Number(existing?.total_interacciones ?? 0) + 1),\n\n    // Conversi√≥n / v√≠nculo paciente (saneados)\n    Paciente_ID: cleanUuidOrNull(existing?.paciente_id),\n    Fecha_Conversion: toISODateTime(existing?.fecha_conversion)\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3280,
        0
      ],
      "id": "709832f1-7025-4ff5-b3df-e834fd9e8632",
      "name": "LEAD_CAPTURE"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "yI0ZZsP2n3ocSlCn",
          "mode": "list",
          "cachedResultUrl": "/workflow/yI0ZZsP2n3ocSlCn",
          "cachedResultName": "LEAD_TRACKER_UROBOT"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Telefono_WhatsApp": "={{ $json.Telefono_WhatsApp }}",
            "Nombre_Completo": "={{ $json.Nombre_Completo }}",
            "Fuente_Lead": "={{ $json.Fuente_Lead }}",
            "Fecha_Primer_Contacto": "={{ $json.Fecha_Primer_Contacto }}",
            "Estado": "={{ $json.Estado }}",
            "Notas_Iniciales": "={{ $json.Notas_Iniciales }}",
            "Session_ID": "={{ $json.Session_ID }}",
            "ultima_interaccion": "={{ $json.ultima_interaccion }}",
            "total_interacciones": "={{ $json.total_interacciones }}",
            "Lead_ID": "={{ $json.Lead_ID }}",
            "Paciente_ID": "={{ $json.Paciente_ID }}",
            "Fecha_Conversion": "={{ $json.Fecha_Conversion }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Lead_ID",
              "displayName": "Lead_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nombre_Completo",
              "displayName": "Nombre_Completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Telefono_WhatsApp",
              "displayName": "Telefono_WhatsApp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fuente_Lead",
              "displayName": "Fuente_Lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fecha_Primer_Contacto",
              "displayName": "Fecha_Primer_Contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Estado",
              "displayName": "Estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Notas_Iniciales",
              "displayName": "Notas_Iniciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Session_ID",
              "displayName": "Session_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "total_interacciones",
              "displayName": "total_interacciones",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "Paciente_ID",
              "displayName": "Paciente_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Fecha_Conversion",
              "displayName": "Fecha_Conversion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": true,
          "convertFieldsToString": true
        },
        "mode": "each",
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        3504,
        0
      ],
      "id": "fde9f4f9-9771-4f26-90aa-fc3447286b66",
      "name": "Call 'LEAD_TRACKER'1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"to\": {{ JSON.stringify($('Webhook1').item.json.body.data.messages.key.remoteJid) }},\n  \"text\": {{ JSON.stringify($json.text ?? $json.whatsapp ?? $json.cleaned) }}\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5664,
        64
      ],
      "id": "f7d88808-8cb4-42ae-98ab-4a720a685d0b",
      "name": "Enviar Respuesta de Asistente",
      "credentials": {
        "httpHeaderAuth": {
          "id": "J0Kap8PdAddWNu3l",
          "name": "Header Auth account 2"
        },
        "httpBearerAuth": {
          "id": "skLVidDokzorVyYh",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "frv41",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4576,
        704
      ],
      "id": "c3d7b82c-0326-458e-8664-97e21ba763fb",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "description": "Herramienta: Agendar Consulta M√©dica\n\nPREREQUISITOS CR√çTICOS:\n- Debes haber ejecutado GET_DISPONIBILIDAD_CALENDARIOS primero\n- Debes tener los datos EXACTOS del slot que el usuario eligi√≥\n- El usuario debe haber confirmado: nombre, tel√©fono y motivo\n\nPAR√ÅMETROS OBLIGATORIOS:\n\n1. slotId (string):\n   - Formato: \"slot_POLANCO_2025-10-21T22:00:00.000Z\"\n   - NO lo inventes - debe venir de la respuesta de GET_DISPONIBILIDAD_CALENDARIOS\n   - Si no lo tienes, primero consulta disponibilidad\n\n2. sede (string):\n   - \"POLANCO\" o \"SATELITE\" (may√∫sculas)\n\n3. start (string):\n   - Formato ISO 8601 UTC: \"2025-10-21T22:00:00.000Z\"\n   - DEBE terminar en Z\n   - NO modifiques este valor\n   - Copia EXACTAMENTE del slot\n\n4. end (string):\n   - Formato ISO 8601 UTC: \"2025-10-21T22:30:00.000Z\"\n   - DEBE terminar en Z\n   - Copia EXACTAMENTE del slot (NO calcules)\n\n5. paciente (objeto JSON):\n   {\n     \"nombre\": \"Nombre Completo\",\n     \"telefono\": \"6673184624\",\n     \"email\": null\n   }\n\n6. tipoCita: \"primera_vez\" o \"seguimiento\"\n\n7. motivoConsulta: string con el motivo\n\nIMPORTANTE - C√ìMO OBTENER LOS DATOS:\nCuando el usuario dice \"quiero agendar a las 4pm\":\n1. Busca en la respuesta previa de GET_DISPONIBILIDAD_CALENDARIOS\n2. Identifica el slot que coincide con \"4:00 PM\"\n3. Usa los valores EXACTOS de ese slot: startISO como start, endISO como end\n4. Construye el slotId como: \"slot_\" + sede + \"_\" + startISO\n\nEJEMPLO:\nSi GET_DISPONIBILIDAD_CALENDARIOS devolvi√≥:\n  startISO: \"2025-10-21T22:00:00.000Z\"\n  endISO: \"2025-10-21T22:30:00.000Z\"\n  sede: \"POLANCO\"\n\nEntonces usa:\n  slotId: \"slot_POLANCO_2025-10-21T22:00:00.000Z\"\n  start: \"2025-10-21T22:00:00.000Z\"\n  end: \"2025-10-21T22:30:00.000Z\"\n  sede: \"POLANCO\"\n\nNUNCA inventes estos valores. Si no tienes los datos exactos, di al usuario que necesitas consultar disponibilidad primero.\n```\n---\n\n## ‚ùó CAMBIO #2: Agregar instrucciones al prompt del LLM\n\n**D√≥nde:** Workflow UROBOT ‚Üí Nodo \"Urobot\" (Google Gemini Chat Model) ‚Üí Agregar al final del prompt system\n\n**Agregar este texto:**\n```\nREGLAS CR√çTICAS PARA AGENDAMIENTO:\n\nCuando uses GET_DISPONIBILIDAD_CALENDARIOS:\n1. Guarda TODA la respuesta en tu memoria\n2. Presta especial atenci√≥n a: startISO, endISO, sede, displayTime\n3. Estos valores ser√°n necesarios para agendar\n\nCuando el usuario quiera agendar:\n1. Busca en tu memoria la respuesta de GET_DISPONIBILIDAD_CALENDARIOS\n2. Identifica QU√â horario eligi√≥ el usuario (ej: \"4pm\", \"las 4\", \"16 horas\")\n3. Encuentra el slot donde displayTime coincide\n4. Extrae los valores EXACTOS: startISO, endISO, sede\n5. Construye slotId como: \"slot_\" + sede + \"_\" + startISO\n6. Usa ESOS valores para llamar AGENDAR_CONSULTA\n\nNUNCA:\n- No inventes valores de start/end\n- No calcules la fecha/hora, usa lo que te dio GET_DISPONIBILIDAD_CALENDARIOS\n- No modifiques el formato de las fechas\n- No llames AGENDAR_CONSULTA sin tener los datos exactos\n\nSi no tienes los datos del slot en memoria, primero consulta disponibilidad.",
        "workflowId": {
          "__rl": true,
          "value": "lmicP7dbmUtnbb7F",
          "mode": "list",
          "cachedResultUrl": "/workflow/lmicP7dbmUtnbb7F",
          "cachedResultName": "AGENDAR_CONSULTA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "slotId": "={{ $fromAI('slotId', '', 'string') }}",
            "sede": "={{ $fromAI('sede', '', 'string') }}",
            "start": "={{ $fromAI('start', '', 'string') }}",
            "end": "={{ $fromAI('end', '', 'string') }}",
            "paciente": "={{ $fromAI('paciente', {}, 'json') }}",
            "tipoCita": "={{ $fromAI('tipoCita', 'primera_vez', 'string') }}",
            "motivoConsulta": "={{ $fromAI('motivoConsulta', '', 'string') }}",
            "lead_telefono": "="
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "slotId",
              "displayName": "slotId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "sede",
              "displayName": "sede",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "start",
              "displayName": "start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "end",
              "displayName": "end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "paciente",
              "displayName": "paciente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "tipoCita",
              "displayName": "tipoCita",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "motivoConsulta",
              "displayName": "motivoConsulta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "lead_telefono",
              "displayName": "lead_telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5600,
        704
      ],
      "id": "603f6b9a-ce15-4b12-8d4f-3b0b35eac1ec",
      "name": "AGENDAR_CONSULTA'"
    },
    {
      "parameters": {
        "description": "üìå CU√ÅNDO USAR ESTA HERRAMIENTA: REAGENDAR_CONSULTAA\n\nActiva esta herramienta cuando el usuario indique o sugiera que desea **cambiar, mover o reagendar una cita m√©dica previamente agendada**.\n\nFrases t√≠picas que indican esta intenci√≥n incluyen:\n\n- \"Quiero cambiar mi cita\"\n- \"Necesito reagendar\"\n- \"No puedo asistir a la hora que ten√≠a\"\n- \"¬øPuedo mover mi consulta?\"\n- \"Me surgi√≥ un imprevisto, quiero cambiar mi cita\"\n- \"Reagendar para otro d√≠a/hora\"\n\nüì• DATOS NECESARIOS PARA USO CORRECTO:\n\n- **tel√©fono (10 d√≠gitos)** del paciente que agend√≥ la cita\n- **nueva fecha (YYYY-MM-DD)** solicitada\n- **nueva hora (HH:MM)** en formato 24h\n- **sede** preferida: `POLANCO` o `SATELITE`\n- **motivo del cambio** (opcional pero recomendable)\n\nüß† VALIDACIONES AUTOM√ÅTICAS INCLUIDAS:\n\n- La nueva fecha/hora debe estar al menos 2 horas en el futuro\n- No se permiten domingos\n- M√°ximo 90 d√≠as de anticipaci√≥n\n- Verificaci√≥n de formato correcto y sede v√°lida\n\n‚ö†Ô∏è SI FALTAN DATOS CLAVE (como fecha, hora o sede):\n- No actives la herramienta inmediatamente\n- Primero pregunta al usuario por los datos faltantes\n- Una vez recolectados, puedes proceder a ejecutar el flujo\nEJEMPLOS DE CONVERSI√ìN:\n\nUsuario: \"Quiero cambiar mi cita del viernes a las 3pm\"\n‚Üí Extrae:\n  - newDate: [pr√≥ximo viernes en formato YYYY-MM-DD]\n  - newTime: \"15:00\"\n  - newSede: \"\" (no mencion√≥)\n  - reason: \"Cambio solicitado por paciente\"\n\nUsuario: \"Mejor agendar para el 25 de octubre a las 2 de la tarde en Polanco\"\n‚Üí Extrae:\n  - newDate: \"2025-10-25\"\n  - newTime: \"14:00\"\n  - newSede: \"POLANCO\"\n  - reason: \"Reagendamiento solicitado\"\n\nUsuario: \"Ya no puedo el martes, ¬øhay el mi√©rcoles?\"\n‚Üí Extrae:\n  - newDate: [pr√≥ximo mi√©rcoles]\n  - newTime: \"\" (no especific√≥ hora)\n  - ‚Üí FLUJO: Consultar DISPONIBILIDAD_CALENDARIO y sugerir horarios",
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "PVMah1xv97jaXawm"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $fromAI('telefono', '', 'string') }}",
            "newDate": "={{ $fromAI('newDate', '', 'string') }}",
            "newTime": "={{ $fromAI('newTime', '', 'string') }}",
            "newSede": "={{ $fromAI('newSede', '', 'string') }}",
            "reason": "={{ $fromAI('reason', 'Reagendamiento solicitado', 'string') }}",
            "consultaId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('consultaId', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "consultaId",
              "displayName": "consultaId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "newDate",
              "displayName": "newDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "newTime",
              "displayName": "newTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "newSede",
              "displayName": "newSede",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "reason",
              "displayName": "reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5920,
        704
      ],
      "id": "d16e7426-0467-45a3-b547-565e4ce90f38",
      "name": "REAGENDAR_CONSULTA"
    }
  ],
  "pinData": {},
  "connections": {
    "call'GET_DISPONIBILIDAD_CALENDARIOS": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Urobot": {
      "main": [
        [
          {
            "node": "Limpiar respuesta de agente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar respuesta de agente1": {
      "main": [
        []
      ]
    },
    "Mapear Mensaje1": {
      "main": [
        [
          {
            "node": "Urobot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Decrypt Media (Wasender)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mapear Mensaje1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          },
          {
            "node": "LEAD_CAPTURE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Urobot",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Google Gemini": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "ESCALAR_HUMANO": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Decrypt Media (Wasender)": {
      "main": [
        [
          {
            "node": "Descargar Decrypt (OGG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Decrypt (OGG)": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Armar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Armar Respuesta": {
      "main": [
        [
          {
            "node": "Mapear Mensaje1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Urobot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LEAD_CAPTURE": {
      "main": [
        [
          {
            "node": "Call 'LEAD_TRACKER'1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Urobot",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AGENDAR_CONSULTA'": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "REAGENDAR_CONSULTA": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Mexico_City",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "93a63ee4-0f33-4802-992a-1a4bb6c43946",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ab2739af75c0bf0ee034fd37e78576df139d0a4fcd48adc710d9ceec11fc12c5"
  },
  "id": "EV0uQg6ljO1CwH6A",
  "tags": []
}