{
  "name": "CARDIOBOT",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        47104,
        784
      ],
      "id": "b0ea0c1b-6f31-4f04-863d-3976ee98c36a",
      "name": "WhatsApp Trigger",
      "webhookId": "cardiobot-webhook-id",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "XXWkRLsCRcyn4ak2",
          "name": "WhatsApp OAuth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üö´ FILTRO DE STATUS UPDATES - ANTI-LOOP (v2 - Soporta Chat Trigger)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst data = $input.first()?.json || {};\n\n// Si viene del Chat Trigger (tiene chatInput), crear estructura compatible\nif (data.chatInput && !data.messages) {\n  const mockPhone = '526673184624'; // Test phone\n  const mockTimestamp = Math.floor(Date.now() / 1000).toString();\n  \n  return [{\n    json: {\n      messages: [{\n        from: mockPhone,\n        id: 'chat-trigger-' + Date.now(),\n        timestamp: mockTimestamp,\n        type: 'text',\n        text: { body: data.chatInput }\n      }],\n      metadata: {\n        phone_number_id: 'test-phone-id'\n      },\n      _fromChatTrigger: true,\n      _sessionId: data.sessionId\n    }\n  }];\n}\n\n// Si tiene 'statuses' es una notificaci√≥n de estado - DETENER\nif (data.statuses && data.statuses.length > 0) {\n  return [];\n}\n\n// Si NO tiene 'messages' o est√° vac√≠o - DETENER\nif (!data.messages || data.messages.length === 0) {\n  return [];\n}\n\n// Si el mensaje no tiene 'from' (remitente) - DETENER\nconst msg = data.messages[0];\nif (!msg.from) {\n  return [];\n}\n\n// Extraer datos de Meta Ads (Click-to-WhatsApp)\nconst referral = msg.referral || {};\nconst esMetaAds = !!(referral.source_url || referral.headline || referral.body || referral.ctwa_clid);\n\nconst metaAdsData = {\n  es_meta_ads: esMetaAds,\n  meta_source_url: referral.source_url || null,\n  meta_headline: referral.headline || null,\n  meta_body: referral.body || null,\n  meta_ctwa_clid: referral.ctwa_clid || null,\n  meta_source_id: referral.source_id || null,\n  meta_source_type: referral.source_type || null\n};\n\n// TODO OK - Es un mensaje real de usuario\nreturn [{ json: { ...data, ...metaAdsData } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        47328,
        880
      ],
      "id": "19baff96-98b1-4b7e-befd-d8b1fdfb8119",
      "name": "üö´ Filtrar Status"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ‚ö° RATE LIMIT CHECK\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst triggerData = $input.first()?.json || {};\nconst messages = triggerData.messages || [];\nconst message = messages[0] || {};\n\nif (!messages.length || !message.from) {\n  return [{ json: { ...triggerData, _rate_limit_ok: false, _reason: 'no_message' } }];\n}\n\nconst timestamp = parseInt(message.timestamp || '0');\nconst now = Math.floor(Date.now() / 1000);\nconst messageAge = now - timestamp;\n\n// Rechazar mensajes muy antiguos (> 5 minutos)\nif (messageAge > 300) {\n  return [{ json: { ...triggerData, _rate_limit_ok: false, _reason: 'mensaje_antiguo' } }];\n}\n\nreturn [{ \n  json: { \n    ...triggerData, \n    _rate_limit_ok: true,\n    _telefono: message.from,\n    _mensaje_id: message.id\n  } \n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        47552,
        880
      ],
      "id": "fd980219-e48f-49a9-8013-c81aceae9bba",
      "name": "‚ö° Rate Limit Check",
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "is-valid",
              "leftValue": "={{ $json._rate_limit_ok }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        47776,
        880
      ],
      "id": "d698018a-7af2-4f10-bb45-d2727c30b093",
      "name": "üö¶ Rate OK?"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "is-imagen",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "imagen"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "is-audio",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "is-doc",
                    "leftValue": "={{ $json.messages[0].type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "documento"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        48000,
        848
      ],
      "id": "9270f1f4-4aeb-4c4e-993f-10b6c3aa715b",
      "name": "üì± Tipo Media?"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].image.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        48224,
        608
      ],
      "id": "b15c8e23-d650-4dad-986a-1cd5167b6ec7",
      "name": "WA Get URL Imagen",
      "webhookId": "6fc57830-97ec-439d-946d-b1acaa940db9",
      "credentials": {
        "whatsAppApi": {
          "id": "OBqndwyo0fpCTd2B",
          "name": "WhatsApp account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        48448,
        608
      ],
      "id": "b8f4aaa1-79ff-4b9c-8ef5-5bcf6fc8753a",
      "name": "HTTP Descargar Imagen",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 1000,
      "credentials": {
        "whatsAppApi": {
          "id": "OBqndwyo0fpCTd2B",
          "name": "WhatsApp account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list"
        },
        "text": "Eres el m√≥dulo de visi√≥n de Cardiobot (asistente de cardiolog√≠a).\n\nANALIZA LA IMAGEN Y DESCRIBE:\n\n>>> SI ES FOTO CL√çNICA (ECG, Holter, presi√≥n arterial, estudios card√≠acos):\n- Tipo de estudio/documento\n- Datos relevantes visibles\n- Cualquier valor anormal que detectes\n- Calidad de la imagen\n\n>>> SI ES DOCUMENTO M√âDICO:\n- Transcribe datos clave (nombre, diagn√≥stico, valores)\n- Identifica si es receta, estudio de laboratorio, etc.\n\n>>> SI ES IRRELEVANTE:\nIndica que no es contenido m√©dico relevante.\n\nResponde de forma concisa para que el chatbot pueda continuar la conversaci√≥n.",
        "inputType": "base64",
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        48672,
        608
      ],
      "id": "514172f0-f9ca-48af-a30a-ed308e925b6b",
      "name": "OpenAI Vision",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 1000,
      "credentials": {
        "openAiApi": {
          "id": "FpK4AqObM2tsV9bK",
          "name": "OpenAi account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "img-msg",
              "name": "mensajeUsuario",
              "type": "string",
              "value": "={{ $json.content || $json.text || '[Imagen analizada]' }}"
            },
            {
              "id": "img-origin",
              "name": "_origen_media",
              "type": "string",
              "value": "imagen_analizada"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        48896,
        608
      ],
      "id": "f96e5c04-6557-4cac-b287-2c5288527684",
      "name": "Set Texto Imagen"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $json.messages[0].audio.id }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        48224,
        800
      ],
      "id": "0aa32174-a81f-4509-80a1-3b15bb5d92cf",
      "name": "WA Get URL Audio",
      "webhookId": "65e7ab21-1736-47cf-b8bc-6d8c0c5df045",
      "credentials": {
        "whatsAppApi": {
          "id": "OBqndwyo0fpCTd2B",
          "name": "WhatsApp account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        48448,
        800
      ],
      "id": "579bb8be-d1ef-45c6-a6bc-11b4b82052cc",
      "name": "HTTP Descargar Audio",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 1000,
      "credentials": {
        "whatsAppApi": {
          "id": "OBqndwyo0fpCTd2B",
          "name": "WhatsApp account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        48672,
        800
      ],
      "id": "55fcdadf-3d9d-437a-a440-909b7357e69d",
      "name": "OpenAI Whisper",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 1000,
      "credentials": {
        "openAiApi": {
          "id": "FpK4AqObM2tsV9bK",
          "name": "OpenAi account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "aud-msg",
              "name": "mensajeUsuario",
              "type": "string",
              "value": "={{ $json.text || '[Audio transcrito]' }}"
            },
            {
              "id": "aud-origin",
              "name": "_origen_media",
              "type": "string",
              "value": "audio_transcrito"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        48896,
        800
      ],
      "id": "70d1f83d-0128-4738-8c16-2cc5f2d9057d",
      "name": "Set Texto Audio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "doc-msg",
              "name": "mensajeUsuario",
              "type": "string",
              "value": "=[Documento recibido: {{ $json.messages[0].document.filename || 'archivo' }}]"
            },
            {
              "id": "doc-origin",
              "name": "_origen_media",
              "type": "string",
              "value": "documento"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        48896,
        992
      ],
      "id": "abb8c90c-6ee6-4fdc-b8c8-5b8e3fde0a1b",
      "name": "Set Texto Documento"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "txt-msg",
              "name": "mensajeUsuario",
              "type": "string",
              "value": "={{ $json.messages?.[0]?.text?.body || $json.messages?.[0]?.button?.text || $json.messages?.[0]?.interactive?.button_reply?.title || '' }}"
            },
            {
              "id": "txt-origin",
              "name": "_origen_media",
              "type": "string",
              "value": "texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        49120,
        1136
      ],
      "id": "f0602cd3-ae50-419a-8f37-3eabb7ad6b2a",
      "name": "Set Texto Normal"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 1Ô∏è‚É£ VALIDAR Y NORMALIZAR (v3 - Obtiene datos de nodos previos)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Obtener datos del flujo anterior\nconst setTexto = $input.first()?.json || {};\nconst filterData = $('üö´ Filtrar Status').first()?.json || {};\nconst rateData = $('‚ö° Rate Limit Check').first()?.json || {};\n\n// Usar datos del filtro que ya proces√≥ el mensaje\nconst messages = filterData.messages || [];\nconst message = messages[0] || {};\nconst metadata = filterData.metadata || {};\n\nconst telefono = message.from || rateData._telefono || '526673184624';\nconst mensajeId = message.id || rateData._mensaje_id || 'msg-' + Date.now();\nconst msgType = message.type || 'text';\nconst fromChatTrigger = filterData._fromChatTrigger === true;\nconst sessionId = filterData._sessionId || mensajeId;\n\n// Extraer texto\nlet mensajeUsuario = setTexto.mensajeUsuario || '';\nif (!mensajeUsuario && msgType === 'text') {\n  mensajeUsuario = message.text?.body || '';\n}\n\n// Extraer nombre del perfil de WhatsApp (contacts est√° al nivel del payload, no dentro de message)\nconst contacts = filterData.contacts || [];\nlet nombreUsuario = contacts[0]?.profile?.name || 'Usuario';\n\n// Detectar origen (Meta Ads vs Org√°nico)\nconst esMetaAds = filterData.es_meta_ads === true;\nconst metaCtwaClid = filterData.meta_ctwa_clid || null;\nconst metaHeadline = filterData.meta_headline || null;\nconst metaSourceUrl = filterData.meta_source_url || null;\n\n// Determinar fuente del paciente\nlet fuente = 'organico';\nlet campana_id = null;\nif (esMetaAds) {\n  fuente = 'meta_ads';\n  campana_id = metaCtwaClid;\n}\n\nreturn [{\n  json: {\n    telefono,\n    mensajeUsuario,\n    mensaje_id_externo: mensajeId,\n    tipoMedia: msgType === 'text' ? 'texto' : msgType,\n    nombreUsuario,\n    metadata,\n    phone_number_id: metadata.phone_number_id,\n    external_chat_id: sessionId,\n    _fromChatTrigger: fromChatTrigger,\n    _validated: true,\n    // Datos de origen\n    fuente,\n    es_meta_ads: esMetaAds,\n    campana_id,\n    meta_headline: metaHeadline,\n    meta_source_url: metaSourceUrl,\n    meta_ctwa_clid: metaCtwaClid\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        49344,
        976
      ],
      "id": "d79ebac2-fe3b-4cce-81f9-15a3e41bfeea",
      "name": "1Ô∏è‚É£ Validar y Normalizar",
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM check_rate_limit($1::text)",
        "options": {
          "queryReplacement": "={{ [$json.telefono] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        49568,
        976
      ],
      "id": "8e2d6806-d236-405d-976b-431d8532d125",
      "name": "üîí Check Rate Limit DB",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "rate-ok",
              "leftValue": "={{ $json.puede_responder }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        49792,
        976
      ],
      "id": "850b553c-3e2a-4c4a-bbfb-7acd1a92b6ed",
      "name": "üîí Rate Limit OK?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM upsert_conversacion_inteligente($1::text, $2::text, $3::text, $4::text)",
        "options": {
          "queryReplacement": "={{ ['whatsapp', $('1Ô∏è‚É£ Validar y Normalizar').first().json.external_chat_id || $json.external_chat_id, $('1Ô∏è‚É£ Validar y Normalizar').first().json.telefono, $('1Ô∏è‚É£ Validar y Normalizar').first().json.nombre_confirmado || $('1Ô∏è‚É£ Validar y Normalizar').first().json.nombreUsuario || 'Usuario'] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        50016,
        880
      ],
      "id": "d99313de-3c5a-4626-9bdc-ecd61e0030e4",
      "name": "2Ô∏è‚É£ Upsert Conversaci√≥n",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM insertar_mensaje_idempotente($1::uuid, $2::text, $3::text, $4::text, $5::text, $6::text, $7::jsonb, $8::text)",
        "options": {
          "queryReplacement": "={{ [$('2Ô∏è‚É£ Upsert Conversaci√≥n').first().json.conversacion_id || $json.conversacion_id, 'inbound', $('1Ô∏è‚É£ Validar y Normalizar').first().json.mensajeUsuario.substring(0, 10000), $('1Ô∏è‚É£ Validar y Normalizar').first().json.mensaje_id_externo, 'whatsapp', $('1Ô∏è‚É£ Validar y Normalizar').first().json.external_chat_id, {}, $('1Ô∏è‚É£ Validar y Normalizar').first().json.tipoMedia === 'texto' ? 'text' : $('1Ô∏è‚É£ Validar y Normalizar').first().json.tipoMedia] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        50240,
        880
      ],
      "id": "3f707a76-ac8d-4e94-9f66-dcde4be7f51c",
      "name": "3Ô∏è‚É£ Guardar Mensaje",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT obtener_contexto_completo_v3($1) as contexto",
        "options": {
          "queryReplacement": "={{ [$('1Ô∏è‚É£ Validar y Normalizar').first().json.telefono] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        51360,
        880
      ],
      "id": "23a951f3-16f2-4a97-adc5-059ea4a70f7b",
      "name": "4Ô∏è‚É£ Cargar Contexto",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 5Ô∏è‚É£ PROCESAR CONTEXTO (VERSI√ìN MEJORADA v2 - CON URGENCIA Y S√çNTOMAS)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst getInput = (nodeName) => $(nodeName).first()?.json || {};\nconst normalizado = getInput('1Ô∏è‚É£ Validar y Normalizar');\nconst convResult = getInput('2Ô∏è‚É£ Upsert Conversaci√≥n');\nconst ctxRawInput = $input.first()?.json?.contexto;\n\n// === PARSE DEL CONTEXTO DE BD ===\nlet ctx = {};\ntry {\n  ctx = typeof ctxRawInput === 'string' ? JSON.parse(ctxRawInput) : (ctxRawInput || {});\n} catch (e) {\n  ctx = {};\n}\n\n// === EXTRACCI√ìN DE CAMPOS DEL CONTEXTO ===\nconst {\n  historial_mensajes: historial = '',\n  ultimo_mensaje_bot: ultimoBot = '',\n  sintomas_acumulados: sintomasRaw = [],\n  sintomas_texto: sintomasTexto = '',\n  banderas_rojas: banderasPrev = [],\n  urgencia_percibida: urgenciaPrev = 'normal',\n  tiempo_evolucion: tiempoEvolucion = null,\n  sentimiento: sentimientoPrev = null,\n  lead_id: leadId = null,\n  es_paciente: esPaciente = false,\n  pregunto_precio: preguntoPrecio = false,\n  funnel_stage: funnelPrevio = 'awareness',\n  total_mensajes: totalMensajes = 0,\n  nombre: nombreContexto\n} = ctx;\n\n// === PROCESAR S√çNTOMAS ACUMULADOS ===\n// Pueden venir como array de objetos o array de strings\nlet sintomasArray = [];\nif (Array.isArray(sintomasRaw)) {\n  sintomasArray = sintomasRaw;\n} else if (typeof sintomasRaw === 'object' && sintomasRaw !== null) {\n  // Si es un objeto, intentar convertir a array\n  sintomasArray = Object.values(sintomasRaw);\n}\n\n// Extraer solo nombres para texto simple\nconst sintomasNombres = sintomasArray\n  .map(s => typeof s === 'string' ? s : (s?.nombre || ''))\n  .filter(Boolean);\n\n// === DETERMINAR NOMBRE FINAL ===\nconst nombreFinal = normalizado.nombre_en_mensaje || \n                    normalizado.nombre_confirmado || \n                    nombreContexto || \n                    'Usuario';\n\n// === CONSTRUIR CONTEXTO PARA AN√ÅLISIS ===\nconst partesContexto = [];\n\nif (historial.length > 50) {\n  partesContexto.push(`CONVERSACI√ìN PREVIA:\\n${historial}`);\n}\n\nif (ultimoBot) {\n  partesContexto.push(`MI √öLTIMO MENSAJE:\\n${ultimoBot}`);\n}\n\nif (sintomasNombres.length > 0) {\n  partesContexto.push(`S√çNTOMAS YA MENCIONADOS: ${sintomasNombres.join(', ')}`);\n}\n\nif (urgenciaPrev && urgenciaPrev !== 'normal') {\n  partesContexto.push(`‚ö†Ô∏è URGENCIA PREVIA: ${urgenciaPrev.toUpperCase()}`);\n}\n\nif (tiempoEvolucion) {\n  partesContexto.push(`TIEMPO DE EVOLUCI√ìN: ${tiempoEvolucion}`);\n}\n\nif (preguntoPrecio) {\n  partesContexto.push('NOTA: Ya pregunt√≥ por precios');\n}\n\nif (esPaciente) {\n  partesContexto.push('‚≠ê ES PACIENTE EXISTENTE');\n}\n\nconst contextoParaAnalisis = partesContexto.join('\\n\\n') || 'Primera interacci√≥n';\n\n// === FLAGS DE ESTADO ===\nconst mensajesEnHistorial = (historial.match(/üë§|ü§ñ/g) || []).length;\nconst esPrimeraInteraccion = mensajesEnHistorial < 2 && totalMensajes <= 1;\nconst tieneHistorialReal = historial.length > 50;\n\n// === RETORNAR DATOS COMPLETOS ===\nreturn [{\n  json: {\n    // Datos normalizados del mensaje\n    ...normalizado,\n    \n    // IDs\n    conversacion_id: convResult.conversacion_id || normalizado.conversacion_id,\n    lead_id: convResult.lead_id || leadId,\n    \n    // Contexto para el analizador\n    contexto_para_analisis: contextoParaAnalisis,\n    historial_mensajes: historial,\n    ultimo_mensaje_bot: ultimoBot,\n    \n    // S√≠ntomas (ambos formatos)\n    sintomas_acumulados: sintomasArray,\n    sintomas_texto: sintomasTexto || sintomasNombres.join(', '),\n    \n    // Banderas rojas previas\n    banderas_rojas_previas: Array.isArray(banderasPrev) ? banderasPrev : [],\n    \n    // Urgencia previa (importante para no bajarla)\n    urgencia_percibida: urgenciaPrev,\n    \n    // Tiempo de evoluci√≥n previo\n    tiempo_evolucion: tiempoEvolucion,\n    \n    // Otros datos del lead\n    es_paciente: esPaciente,\n    pregunto_precio: preguntoPrecio,\n    funnel_stage: funnelPrevio,\n    sentimiento_previo: sentimientoPrev,\n    \n    // Nombre\n    nombreUsuario: nombreFinal,\n    nombre_confirmado: normalizado.nombre_confirmado || nombreContexto,\n    \n    // Flags\n    es_primera_interaccion: esPrimeraInteraccion,\n    tiene_historial_real: tieneHistorialReal,\n    total_mensajes: totalMensajes,\n    \n    // Origen (Meta Ads)\n    fuente: normalizado.fuente || 'organico',\n    es_meta_ads: normalizado.es_meta_ads || false,\n    campana_id: normalizado.campana_id || null,\n    meta_headline: normalizado.meta_headline || null,\n    meta_ctwa_clid: normalizado.meta_ctwa_clid || null\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        51584,
        880
      ],
      "id": "67c4b725-e66d-4e4c-bfbc-20e6a97c207a",
      "name": "5Ô∏è‚É£ Procesar Contexto"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un analista experto en comportamiento de pacientes y triage cardiol√≥gico. Tu trabajo es extraer SE√ëALES CL√çNICAS Y DE COMPORTAMIENTO del mensaje del paciente para que el chatbot tome las mejores decisiones.\n\nMENSAJE PACIENTE: \"{{ $json.mensajeUsuario }}\"\n√öLTIMO BOT: \"{{ $json.ultimo_mensaje_bot || '' }}\"\nCONTEXTO PREVIO: {{ $json.contexto_para_analisis || 'Inicio' }}\nS√çNTOMAS DETECTADOS: {{ $json.sintomas_texto || 'Ninguno' }}\nFUNNEL ACTUAL: {{ $json.funnel_stage || 'awareness' }}\nTOTAL MENSAJES: {{ $json.total_mensajes || 0 }}\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nINSTRUCCIONES DE AN√ÅLISIS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n### PARTE 1: INTENCI√ìN Y COMPORTAMIENTO\n\n**INTENCIONES (elige la PRINCIPAL):**\n| Intenci√≥n | Se√±ales |\n|-----------|---------|\n| agendar_listo | \"quiero agendar\", da fecha/hora, \"reserva\", \"ap√°rtame\" |\n| agendar_dudando | \"tal vez\", \"tendr√≠a que ver\", muestra inter√©s pero no decide |\n| solo_informacion | \"quiero informaci√≥n\", \"quiero saber\", NO menciona agendar. Estos pacientes buscan datos, no cita |\n| consultar_disponibilidad | \"qu√© d√≠as tienen\", \"horarios\" |\n| preguntar_precio | \"cu√°nto cuesta\", \"tarifas\", \"$\", \"honorarios\" |\n| expresar_sintomas | describe malestares f√≠sicos |\n| saludo | \"hola\", \"buenos d√≠as\", primer contacto gen√©rico |\n| confirmacion | \"s√≠\", \"ok\", \"perfecto\", \"dale\" en respuesta a algo que el bot propuso |\n| objecion | expresa duda, rechazo o barrera para agendar |\n| rechazo | \"no gracias\", \"no me interesa\", \"despu√©s\" |\n| seguimiento | pregunta sobre cita existente |\n\n**PERFIL DEL PACIENTE (elige UNO):**\n| Perfil | Se√±ales |\n|--------|---------|\n| decidido | Quiere agendar, da datos, no duda |\n| interesado_cautelo | Tiene inter√©s real pero quiere m√°s info antes de decidir |\n| precio_sensible | Pregunta costos, menciona presupuesto, jubilado, pensionado, \"est√° caro\" |\n| solo_curiosidad | \"quiero informaci√≥n\" gen√©rico, sin s√≠ntomas ni urgencia |\n| referido_medico | \"me mand√≥ mi doctor\", \"me refirieron\", ya tiene indicaci√≥n |\n| asustado | Describe s√≠ntomas con miedo, usa \"me preocupa\", \"tengo miedo\" |\n| urgente_real | S√≠ntomas activos ahora mismo, necesita atenci√≥n inmediata |\n\n**EMOCIONES DETECTADAS (array, puede haber varias):**\n- miedo: \"me da miedo\", \"estoy asustado\", tono ansioso\n- preocupacion: \"me preocupa\", \"no s√© qu√© hacer\"\n- ansiedad_precio: menciona dinero, presupuesto, jubilaci√≥n, \"est√° caro\"\n- frustraci√≥n: \"ya te dije\", \"por qu√© no\", tono molesto\n- esperanza: \"ojal√°\", \"espero que\", busca soluci√≥n\n- urgencia: \"necesito ya\", \"no puedo esperar\"\n- desconfianza: \"no s√© si\", \"tengo que pensarlo\"\n- alivio: \"qu√© bueno\", \"me tranquiliza\"\n- indiferencia: respuestas cortas sin emoci√≥n, \"ok\", \"ah bueno\"\n\n**SE√ëALES DE PRECIO (IMPORTANTE ‚Äî detectar TODAS):**\n- Pregunta expl√≠cita de precio/costos/tarifas\n- Menciona ser jubilado, pensionado, estudiante, desempleado\n- Dice \"es mucho\", \"est√° caro\", \"no tengo\", \"es accesible?\"\n- Pide descuento, promoci√≥n, facilidades de pago\n- Menciona que ya fue a otro lugar m√°s barato\n- Indirecta: \"¬øy cu√°nto sale todo?\" antes de cualquier otra pregunta\n\n**PREDICCI√ìN DE CONVERSI√ìN:**\n- alta: tiene s√≠ntomas reales + quiere agendar + no menciona barreras\n- media: tiene inter√©s pero hay alguna barrera (precio, tiempo, miedo)\n- baja: solo pide info, no tiene urgencia, menciona barreras fuertes\n- necesita_incentivo: quiere atenderse pero el precio/miedo lo detiene ‚Üí necesita algo extra para decidir\n\n**¬øQU√â ESTRATEGIA USAR? (si predicci√≥n = necesita_incentivo o baja):**\n‚õî NUNCA sugerir descuento. El precio NO se negocia. La estrategia es justificar el valor.\n\n- anclar_valor: sensible al precio ‚Üí enfatizar que $1,200 incluye consulta + ECG, que en otros lados cobran por separado, que es una hora completa con especialista\n- urgencia_medica: no sabe que su condici√≥n es seria ‚Üí explicar el riesgo real de no atenderse, crear consciencia del problema\n- prueba_social: desconfiado ‚Üí mencionar experiencia del Dr. Fausto, que es especialista, a√±os de experiencia\n- empatia_profunda: asustado o preocupado ‚Üí escuchar primero, validar emociones, construir confianza antes de ofrecer cita\n- educacion_medica: solo busca info ‚Üí darle valor educativo real que demuestre conocimiento, crear el vac√≠o (\"sin el ECG estar√≠amos adivinando\")\n- conveniencia: tiene barrera de tiempo ‚Üí ofrecer horarios flexibles, enfatizar que es r√°pido (1 hora) y cerca de metro\n- ninguno: ya est√° listo o no hay barrera clara\n\n### PARTE 2: AN√ÅLISIS CL√çNICO\n\n**S√çNTOMAS CARD√çACOS (mapear al t√©rmino m√©dico):**\n| Coloquial | M√©dico | Severidad base |\n|-----------|--------|---------------|\n| \"me falta el aire\" | disnea | moderada |\n| \"me duele el pecho\" | dolor_toracico | moderada-severa |\n| \"el coraz√≥n me late r√°pido\" | taquicardia | moderada |\n| \"me desmay√©\" | sincope | severa |\n| \"se me hinchan los pies/tobillos\" | edema_periferico | moderada |\n| \"me mareo\" | mareo | leve |\n| \"presi√≥n alta\" | hipertension | moderada |\n| \"no puedo dormir/insomnio\" | insomnio | leve |\n| \"orino mucho de noche\" | nicturia | leve-moderada |\n\nREGLA CR√çTICA para descripcion_original: SIEMPRE pon las PALABRAS EXACTAS del paciente, NO el t√©rmino m√©dico.\nEjemplo: paciente dice \"se me hinchan los tobillos\" ‚Üí nombre: \"edema_periferico\", descripcion_original: \"se me hinchan los tobillos\"\n\n**BANDERAS ROJAS (solo si REALMENTE aplican):**\n- Dolor tor√°cico >5min que irradia a brazo/cuello/mand√≠bula\n- S√≠ncope (desmayo REAL, no solo mareo)\n- Disnea EN REPOSO (no de esfuerzo)\n- Sudoraci√≥n fr√≠a + dolor de pecho SIMULT√ÅNEOS\n- Palpitaciones + desmayo/mareo SIMULT√ÅNEOS\n‚ö†Ô∏è \"disnea\" sola NO es bandera roja. \"edema\" solo NO es bandera roja. Deben cumplir los criterios exactos.\n\n**SEVERIDAD (asigna correctamente, NO todo es \"moderada\"):**\n- leve: s√≠ntoma ocasional que no limita actividades\n- moderada: s√≠ntoma frecuente que causa molestia\n- severa: s√≠ntoma constante, limita actividades, o es intr√≠nsecamente grave (s√≠ncope, infarto, etc.)\n\n### PARTE 3: FORMATO DE SALIDA\n\nResponde SOLO con este JSON (sin markdown, sin explicaciones):\n\n{\n  \"intencion_principal\": \"agendar_listo|agendar_dudando|solo_informacion|consultar_disponibilidad|preguntar_precio|expresar_sintomas|saludo|confirmacion|objecion|rechazo|seguimiento\",\n\n  \"perfil_paciente\": \"decidido|interesado_cautelo|precio_sensible|solo_curiosidad|referido_medico|asustado|urgente_real\",\n\n  \"emociones_detectadas\": [\"lista de emociones\"],\n\n  \"nivel_compromiso\": 1-10,\n  \"prediccion_conversion\": \"alta|media|baja|necesita_incentivo\",\n  \"incentivo_sugerido\": \"descuento|urgencia_medica|prueba_social|facilidades_pago|empatia|ninguno\",\n\n  \"barrera_principal\": \"precio|miedo|tiempo|desconfianza|indecision|ninguna\",\n  \"detalle_barrera\": \"explicaci√≥n breve de por qu√© crees que esta es la barrera\",\n\n  \"senales_precio\": {\n    \"pregunto_precio\": true/false,\n    \"menciono_presupuesto\": true/false,\n    \"indicadores\": [\"lista de frases exactas que indican sensibilidad al precio\"],\n    \"nivel_sensibilidad\": \"ninguna|baja|media|alta|critica\"\n  },\n\n  \"sentimiento\": \"urgente|preocupado|ansioso|curioso|neutral|positivo|frustrado|desconfiado\",\n\n  \"urgencia_percibida\": \"normal|alta|emergencia\",\n\n  \"sintomas_estructurados\": [\n    {\n      \"nombre\": \"termino_medico\",\n      \"descripcion_original\": \"PALABRAS EXACTAS del paciente, NO el t√©rmino m√©dico\",\n      \"severidad\": \"leve|moderada|severa\",\n      \"tiempo_evolucion\": \"lo que mencione o null\"\n    }\n  ],\n\n  \"banderas_rojas\": [\"solo banderas REALES que cumplan criterios exactos\"],\n\n  \"nombre_detectado\": \"nombre PROPIO de persona o null. NUNCA s√≠ntomas ni t√©rminos m√©dicos\",\n  \"edad_detectada\": \"edad si la menciona o null\",\n  \"fecha_mencionada\": \"fecha si menciona o null\",\n  \"hora_mencionada\": \"hora si menciona o null\",\n\n  \"datos_relevantes\": {\n    \"ocupacion\": \"si la menciona o null\",\n    \"antecedentes_mencionados\": [\"lista de condiciones previas mencionadas\"],\n    \"medicamentos_mencionados\": [\"lista de medicamentos si menciona\"],\n    \"para_quien\": \"para_si_mismo|familiar|otro\"\n  },\n\n  \"siguiente_paso_ideal\": \"qu√© deber√≠a hacer el bot a continuaci√≥n\"\n}\n\n### NOTAS FINALES\n- nivel_compromiso: 1-3 solo curiosidad, 4-6 interesado, 7-9 casi listo, 10 quiere agendar ya\n- Si alguien pregunta precio ANTES de describir s√≠ntomas ‚Üí perfil \"precio_sensible\", predicci√≥n \"necesita_incentivo\"\n- Si alguien dice \"quiero informaci√≥n\" sin m√°s ‚Üí perfil \"solo_curiosidad\", predicci√≥n \"baja\"\n- Si alguien lista s√≠ntomas reales + pregunta precio ‚Üí perfil \"interesado_cautelo\", barrera \"precio\"\n- \"jubilado\", \"pensionado\", \"estudiante\" ‚Üí nivel_sensibilidad precio \"alta\" o \"critica\"\n- Un paciente que da su edad, s√≠ntomas detallados y pregunta precio QUIERE atenderse pero necesita que le demuestren el VALOR. No darle descuento, sino anclar el valor: \"$1,200 incluye todo, consulta completa + electrocardiograma interpretado al momento\""
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.4,
      "position": [
        51808,
        880
      ],
      "id": "4c91235d-cdb7-4c88-a492-e86c958dd3c4",
      "name": "6Ô∏è‚É£ Analizar Gemini",
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 1500,
      "continueOnFail": true
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-lite",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        51888,
        1104
      ],
      "id": "322b5db4-da25-4249-a084-13f727671c68",
      "name": "Gemini Analizador",
      "credentials": {
        "googlePalmApi": {
          "id": "jMelorawCvKtHf1j",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 7Ô∏è‚É£ PROCESAR AN√ÅLISIS (v10 - Behavioral Intelligence + Clinical)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst ctx = $('5Ô∏è‚É£ Procesar Contexto').first()?.json || {};\nconst analysisRaw = $input.first()?.json?.text || '{}';\n\n// === PARSE DEL JSON DE LA IA ===\nlet analisis = {};\ntry {\n  let cleaned = analysisRaw.replace(/```json|```/gi, '').trim();\n  const match = cleaned.match(/\\{[\\s\\S]*\\}/);\n  if (match) cleaned = match[0];\n  analisis = JSON.parse(cleaned);\n} catch (e) {\n  analisis = { \n    intencion_principal: 'otro', \n    perfil_paciente: 'solo_curiosidad',\n    emociones_detectadas: [],\n    sintomas_estructurados: [], \n    banderas_rojas: [],\n    urgencia_percibida: 'normal',\n    nivel_compromiso: 5,\n    prediccion_conversion: 'media',\n    incentivo_sugerido: 'ninguno',\n    barrera_principal: 'ninguna',\n    senales_precio: { pregunto_precio: false, nivel_sensibilidad: 'ninguna' }\n  };\n}\n\n// === INTENCI√ìN (con fallback legacy) ===\nconst intencionPrincipal = analisis.intencion_principal || analisis.intencion || 'otro';\n\n// === PERFIL Y COMPORTAMIENTO (NUEVO) ===\nconst perfilPaciente = analisis.perfil_paciente || 'solo_curiosidad';\nconst emocionesDetectadas = Array.isArray(analisis.emociones_detectadas) ? analisis.emociones_detectadas : [];\nconst nivelCompromiso = analisis.nivel_compromiso || 5;\nconst prediccionConversion = analisis.prediccion_conversion || 'media';\nconst incentivoSugerido = analisis.incentivo_sugerido || 'ninguno';\nconst barrieraPrincipal = analisis.barrera_principal || 'ninguna';\nconst detalleBarrera = analisis.detalle_barrera || '';\n\n// === SE√ëALES DE PRECIO (NUEVO) ===\nconst senalesPrecio = analisis.senales_precio || {};\nconst preguntoPrecioNuevo = senalesPrecio.pregunto_precio || analisis.pregunto_precio || false;\nconst mencionoPresupuesto = senalesPrecio.menciono_presupuesto || false;\nconst indicadoresPrecio = Array.isArray(senalesPrecio.indicadores) ? senalesPrecio.indicadores : [];\nconst nivelSensibilidadPrecio = senalesPrecio.nivel_sensibilidad || 'ninguna';\n\n// === DATOS RELEVANTES (NUEVO) ===\nconst datosRelevantes = analisis.datos_relevantes || {};\nconst ocupacion = datosRelevantes.ocupacion || null;\nconst antecedentesMencionados = Array.isArray(datosRelevantes.antecedentes_mencionados) ? datosRelevantes.antecedentes_mencionados : [];\nconst medicamentosMencionados = Array.isArray(datosRelevantes.medicamentos_mencionados) ? datosRelevantes.medicamentos_mencionados : [];\nconst paraQuien = datosRelevantes.para_quien || 'para_si_mismo';\n\n// === OTROS CAMPOS ===\nconst sentimiento = analisis.sentimiento || 'neutral';\nconst tonoEmocional = analisis.tono_emocional || emocionesDetectadas.join(', ');\nconst fechaMencionada = analisis.fecha_mencionada || null;\nconst horaMencionada = analisis.hora_mencionada || null;\nconst edadDetectada = analisis.edad_detectada || null;\nconst siguientePaso = analisis.siguiente_paso_ideal || '';\n\n// === VALIDACI√ìN DE NOMBRE (anti-s√≠ntoma) ===\nconst terminosMedicos = new Set([\n  'disnea', 'taquicardia', 'bradicardia', 'sincope', 's√≠ncope', 'edema',\n  'arritmia', 'angina', 'infarto', 'hipertension', 'hipertensi√≥n',\n  'hipotension', 'hipotensi√≥n', 'palpitaciones', 'mareo', 'vertigo',\n  'v√©rtigo', 'cefalea', 'dolor', 'opresion', 'opresi√≥n', 'fatiga',\n  'cansancio', 'nausea', 'n√°usea', 'vomito', 'v√≥mito', 'desmayo',\n  'sudoracion', 'sudoraci√≥n', 'hola', 'buenos', 'dias', 'd√≠as',\n  'buenas', 'tardes', 'noches', 'gracias', 'ok', 'si', 's√≠', 'no',\n  'claro', 'dale', 'va', 'perfecto', 'bien', 'edema_periferico',\n  'nicturia', 'insomnio', 'dolor_toracico', 'hipertension_arterial'\n]);\nconst rawNombre = analisis.nombre_detectado || null;\nconst nombreDetectado = (rawNombre && !terminosMedicos.has(rawNombre.toLowerCase().trim()) && rawNombre.length > 1 && rawNombre.length < 60) ? rawNombre : null;\n\n// === PROCESAMIENTO DE URGENCIA (NUNCA BAJAR) ===\nconst urgenciaNueva = analisis.urgencia_percibida || 'normal';\nconst urgenciaPrevia = ctx.urgencia_percibida || 'normal';\nconst ordenUrgencia = { 'normal': 1, 'alta': 2, 'emergencia': 3 };\nconst urgenciaFinal = ordenUrgencia[urgenciaNueva] >= ordenUrgencia[urgenciaPrevia]\n  ? urgenciaNueva \n  : urgenciaPrevia;\nconst esUrgenciaMedica = urgenciaFinal === 'emergencia' || urgenciaFinal === 'alta';\n\n// === S√çNTOMAS ESTRUCTURADOS ===\nconst sintomasNuevos = Array.isArray(analisis.sintomas_estructurados)\n  ? analisis.sintomas_estructurados.filter(s => s && s.nombre)\n  : [];\n\n// S√≠ntomas previos del contexto\nlet sintomasPrevios = [];\nif (Array.isArray(ctx.sintomas_acumulados)) {\n  sintomasPrevios = ctx.sintomas_acumulados.map(s => {\n    if (typeof s === 'string') {\n      return { nombre: s, descripcion_original: s, severidad: 'moderada', tiempo_evolucion: null };\n    }\n    return s;\n  });\n}\n\n// Merge inteligente: no duplicar por nombre, actualizar severidad si es mayor\nconst ordenSeveridad = { 'leve': 1, 'moderada': 2, 'severa': 3 };\n\nconst sintomasMerged = [...sintomasPrevios];\nfor (const sintomaNew of sintomasNuevos) {\n  const nombreLower = (sintomaNew.nombre || '').toLowerCase();\n  const existente = sintomasMerged.find(s => (s.nombre || '').toLowerCase() === nombreLower);\n  \n  if (!existente) {\n    sintomasMerged.push(sintomaNew);\n  } else {\n    const sevExistente = ordenSeveridad[existente.severidad] || 2;\n    const sevNueva = ordenSeveridad[sintomaNew.severidad] || 2;\n    if (sevNueva > sevExistente) {\n      existente.severidad = sintomaNew.severidad;\n    }\n    if (!existente.tiempo_evolucion && sintomaNew.tiempo_evolucion) {\n      existente.tiempo_evolucion = sintomaNew.tiempo_evolucion;\n    }\n    // Update descripcion_original if the new one is better (not just the medical term)\n    if (sintomaNew.descripcion_original && sintomaNew.descripcion_original !== sintomaNew.nombre) {\n      existente.descripcion_original = sintomaNew.descripcion_original;\n    }\n  }\n}\n\nconst sintomasNombres = sintomasMerged.map(s => s.nombre).filter(Boolean);\n\n// === BANDERAS ROJAS (ACUMULATIVAS) ===\nconst banderasNuevas = Array.isArray(analisis.banderas_rojas) ? analisis.banderas_rojas : [];\nconst banderasPrevias = Array.isArray(ctx.banderas_rojas_previas) ? ctx.banderas_rojas_previas : [];\nconst banderasMerged = [...new Set([...banderasPrevias, ...banderasNuevas])];\n\n// === TIEMPO DE EVOLUCI√ìN ===\nconst tiempoEvolucion = analisis.tiempo_evolucion_general ||\n  sintomasNuevos.find(s => s.tiempo_evolucion)?.tiempo_evolucion ||\n  ctx.tiempo_evolucion || null;\n\n// === PREGUNT√ì PRECIO (ACUMULATIVO) ===\nconst preguntoPrecio = preguntoPrecioNuevo || ctx.pregunto_precio || false;\n\n// === RETORNAR DATOS COMPLETOS ===\nreturn [{\n  json: {\n    ...ctx,\n    \n    // === INTENCI√ìN ===\n    intencion_principal: intencionPrincipal,\n    intencion: intencionPrincipal,\n    \n    // === PERFIL Y COMPORTAMIENTO (NUEVO) ===\n    perfil_paciente: perfilPaciente,\n    emociones_detectadas: emocionesDetectadas,\n    nivel_compromiso: nivelCompromiso,\n    prediccion_conversion: prediccionConversion,\n    incentivo_sugerido: incentivoSugerido,\n    barrera_principal: barrieraPrincipal,\n    detalle_barrera: detalleBarrera,\n    \n    // === SE√ëALES DE PRECIO (NUEVO) ===\n    senales_precio: senalesPrecio,\n    nivel_sensibilidad_precio: nivelSensibilidadPrecio,\n    indicadores_precio: indicadoresPrecio,\n    menciono_presupuesto: mencionoPresupuesto,\n    \n    // === DATOS RELEVANTES (NUEVO) ===\n    ocupacion: ocupacion,\n    antecedentes_mencionados: antecedentesMencionados,\n    medicamentos_mencionados: medicamentosMencionados,\n    para_quien: paraQuien,\n    edad_detectada: edadDetectada,\n    \n    // === LEGACY FIELDS ===\n    sentimiento,\n    tono_emocional: tonoEmocional,\n    nombre_detectado: nombreDetectado,\n    siguiente_paso_ideal: siguientePaso,\n    fecha_mencionada: fechaMencionada,\n    hora_mencionada: horaMencionada,\n    \n    // === URGENCIA ===\n    urgencia_percibida: urgenciaFinal,\n    es_urgencia_medica: esUrgenciaMedica,\n    \n    // === S√çNTOMAS (ambos formatos) ===\n    sintomas_estructurados: sintomasMerged,\n    sintomas_merged: sintomasNombres,\n    banderas_rojas: banderasMerged,\n    tiempo_evolucion: tiempoEvolucion,\n    \n    // === PRECIO ===\n    pregunto_precio: preguntoPrecio,\n    \n    // === FLAGS ===\n    tiene_historial_real: (ctx.historial_mensajes || '').length > 50,\n    es_primera_interaccion: !((ctx.historial_mensajes || '').length > 50) && (ctx.total_mensajes || 0) <= 1\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        52160,
        880
      ],
      "id": "864dd669-a9b6-4ba6-8d32-bcc8da6d5924",
      "name": "7Ô∏è‚É£ Procesar An√°lisis"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM upsert_lead_cardiobot(\n  $1::text,    -- telefono\n  $2::text,    -- nombre\n  $3::text,    -- fuente\n  $4::text,    -- primer_mensaje\n  $5::text,    -- intencion\n  $6::text,    -- sentimiento\n  $7::text[],  -- sintomas\n  $8::text[],  -- banderas_rojas\n  $9::text,    -- urgencia\n  $10::boolean, -- pregunto_precio\n  $11::text,   -- tiempo_evolucion\n  $12::text,   -- alcance\n  $13::jsonb,  -- factores_riesgo\n  $14::text,   -- para_quien\n  $15::text,   -- canal\n  $16::text,   -- campana_id\n  $17::text,   -- fb_ctwa_clid\n  $18::text,   -- fb_ad_id\n  $19::text,   -- fb_adset_id\n  $20::text,   -- fb_campaign_id\n  $21::text,   -- fb_ad_name\n  $22::text,   -- fb_campaign_name\n  $23::text,   -- fb_headline\n  $24::text    -- fb_referral_source\n)",
        "options": {
          "queryReplacement": "={{ [\n  $json.telefono || '',\n  $json.nombre_detectado || $json.nombreUsuario || $json.nombre_confirmado || 'Usuario',\n  $json.es_meta_ads ? 'meta_ads' : ($json.fuente || 'whatsapp'),\n  ($json.mensajeUsuario || '').substring(0, 5000),\n  $json.intencion || $json.intencion_principal || 'otro',\n  $json.sentimiento || 'neutral',\n  ($json.sintomas_estructurados || []).map(s => JSON.stringify(s)),\n  $json.banderas_rojas || [],\n  $json.urgencia_percibida || 'normal',\n  $json.pregunto_precio || false,\n  $json.tiempo_evolucion || null,\n  'in_scope',\n  JSON.stringify({\n    perfil_paciente: $json.perfil_paciente || null,\n    prediccion_conversion: $json.prediccion_conversion || null,\n    incentivo_sugerido: $json.incentivo_sugerido || null,\n    barrera_principal: $json.barrera_principal || null,\n    nivel_sensibilidad_precio: $json.nivel_sensibilidad_precio || null,\n    emociones_detectadas: $json.emociones_detectadas || [],\n    ocupacion: $json.ocupacion || null,\n    edad_detectada: $json.edad_detectada || null,\n    antecedentes_mencionados: $json.antecedentes_mencionados || [],\n    medicamentos_mencionados: $json.medicamentos_mencionados || []\n  }),\n  $json.para_quien || 'para_si_mismo',\n  $json.es_meta_ads ? 'meta_ads' : ($json.fuente || 'whatsapp'),\n  $json.meta_ctwa_clid || $json.campana_id || null,\n  $json.meta_ctwa_clid || null,\n  $json.fb_ad_id || null,\n  $json.fb_adset_id || null,\n  $json.fb_campaign_id || null,\n  $json.fb_ad_name || null,\n  $json.fb_campaign_name || null,\n  $json.meta_headline || $json.fb_headline || null,\n  $json.meta_source_url || $json.fb_referral_source || null\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        52384,
        880
      ],
      "id": "295823d0-a213-4b17-97a5-c96ef2728345",
      "name": "8Ô∏è‚É£ Guardar Lead",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 9Ô∏è‚É£ FORMATEAR CONTEXTO PARA AGENTE (v8 - Con Historial Fallback)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// FIX: Simple Memory es ef√≠mero y se pierde entre sesiones.\n// Ahora incluimos los √∫ltimos mensajes de la BD como respaldo\n// para que el agente SIEMPRE sepa si ya salud√≥ al paciente.\n\nconst analisis = $('7Ô∏è‚É£ Procesar An√°lisis').first()?.json || {};\nconst normData = $('1Ô∏è‚É£ Validar y Normalizar').first()?.json || {};\nconst convResult = $('2Ô∏è‚É£ Upsert Conversaci√≥n').first()?.json || {};\nconst ctxData = $('5Ô∏è‚É£ Procesar Contexto').first()?.json || {};\n\n// === HISTORIAL DE BD (respaldo cuando Simple Memory est√° vac√≠o) ===\nconst historialBD = ctxData.historial_mensajes || '';\nconst ultimoMensajeBot = ctxData.ultimo_mensaje_bot || '';\nconst totalMensajes = ctxData.total_mensajes || 0;\nconst esPrimeraInteraccion = ctxData.es_primera_interaccion ?? (totalMensajes <= 1);\n\n// === NOMBRE (prioridad: Gemini > WhatsApp > fallback) ===\nconst perfilWA = normData.nombreUsuario || '';\nconst nombreGemini = analisis.nombre_detectado || '';\nlet nombreFinal;\nif (nombreGemini && nombreGemini !== 'Usuario' && nombreGemini.length > 1) {\n  nombreFinal = nombreGemini;\n} else if (perfilWA && perfilWA !== 'Usuario') {\n  nombreFinal = perfilWA;\n} else {\n  nombreFinal = 'Usuario';\n}\nconst tenemosNombre = nombreFinal !== 'Usuario';\n\n// === DATOS ===\nconst sintomas = analisis.sintomas_merged || [];\nconst sintomasEstructurados = analisis.sintomas_estructurados || [];\nconst es_urgencia_medica = analisis.es_urgencia_medica;\nconst intencionPrincipal = analisis.intencion_principal || 'otro';\nconst perfilPaciente = analisis.perfil_paciente || 'solo_curiosidad';\nconst emociones = analisis.emociones_detectadas || [];\nconst nivelCompromiso = analisis.nivel_compromiso || 5;\nconst prediccionConversion = analisis.prediccion_conversion || 'media';\nconst incentivoSugerido = analisis.incentivo_sugerido || 'ninguno';\nconst barrieraPrincipal = analisis.barrera_principal || 'ninguna';\nconst detalleBarrera = analisis.detalle_barrera || '';\nconst nivelSensibilidadPrecio = analisis.nivel_sensibilidad_precio || 'ninguna';\nconst pregunto_precio = analisis.pregunto_precio;\nconst fechaMencionada = analisis.fecha_mencionada;\nconst horaMencionada = analisis.hora_mencionada;\nconst edadDetectada = analisis.edad_detectada;\nconst siguientePaso = analisis.siguiente_paso_ideal || '';\n\n// === ESTADO DE AGENDAMIENTO ===\nconst tieneFecha = !!fechaMencionada;\nconst tieneHora = !!horaMencionada;\nconst tieneNombre = tenemosNombre;\nconst tieneMotivo = sintomas.length > 0;\nconst intentaAgendar = ['agendar_listo', 'confirmacion'].includes(intencionPrincipal);\nconst datosCompletos = tieneNombre && tieneMotivo && tieneFecha && tieneHora;\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// CONSTRUIR CONTEXTO (con historial de BD como respaldo)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst secciones = [];\n\n// 0. HISTORIAL DE BD ‚Äî respaldo cr√≠tico cuando Simple Memory est√° vac√≠o\n// Esto evita que el agente se presente de nuevo en conversaciones existentes\nif (!esPrimeraInteraccion && historialBD && historialBD.length > 50) {\n  // Tomar solo los √∫ltimos mensajes para no saturar el contexto\n  const lineas = historialBD.split('\\n').filter(l => l.trim());\n  const ultimasLineas = lineas.slice(-10); // √∫ltimos 10 mensajes max\n  secciones.push(\n    `‚ö†Ô∏è CONVERSACI√ìN EN CURSO (${totalMensajes} mensajes previos) ‚Äî NO te presentes de nuevo, NO digas \"gracias por escribir\", CONTIN√öA la conversaci√≥n naturalmente.\\n\\n√öLTIMOS MENSAJES:\\n${ultimasLineas.join('\\n')}`\n  );\n} else if (!esPrimeraInteraccion && ultimoMensajeBot) {\n  // Al menos tenemos el √∫ltimo mensaje del bot\n  secciones.push(\n    `‚ö†Ô∏è CONVERSACI√ìN EN CURSO ‚Äî NO te presentes de nuevo.\\nTu √∫ltimo mensaje fue: \"${ultimoMensajeBot.substring(0, 200)}...\"`\n  );\n}\n\n// 1. Perfil del paciente (lo que el agente NECESITA saber)\nconst perfilLineas = [];\nperfilLineas.push(`Perfil: ${perfilPaciente.toUpperCase()} | Intenci√≥n: ${intencionPrincipal}`);\nperfilLineas.push(`Compromiso: ${nivelCompromiso}/10 ‚Üí Conversi√≥n: ${prediccionConversion}`);\nif (emociones.length > 0) perfilLineas.push(`Emociones: ${emociones.join(', ')}`);\nif (barrieraPrincipal !== 'ninguna') perfilLineas.push(`‚ö†Ô∏è Barrera: ${barrieraPrincipal} ‚Äî ${detalleBarrera}`);\nif (incentivoSugerido !== 'ninguno') perfilLineas.push(`üí° Estrategia sugerida: ${incentivoSugerido}`);\nsecciones.push(`PERFIL:\\n${perfilLineas.join('\\n')}`);\n\n// 2. Se√±ales de precio (solo si aplican)\nif (pregunto_precio || nivelSensibilidadPrecio !== 'ninguna') {\n  const precioLineas = [`Sensibilidad: ${nivelSensibilidadPrecio.toUpperCase()}`];\n  if (analisis.ocupacion) precioLineas.push(`Ocupaci√≥n: ${analisis.ocupacion}`);\n  if (analisis.indicadores_precio?.length > 0) precioLineas.push(`Se√±ales: ${analisis.indicadores_precio.join(', ')}`);\n  secciones.push(`üí∞ PRECIO:\\n${precioLineas.join('\\n')}`);\n}\n\n// 3. S√≠ntomas (compacto)\nif (sintomas.length > 0) {\n  const sintomasTxt = sintomasEstructurados.map(s => {\n    let txt = s.nombre;\n    if (s.descripcion_original && s.descripcion_original !== s.nombre) txt += ` (\"${s.descripcion_original}\")`;\n    if (s.severidad && s.severidad !== 'moderada') txt += ` [${s.severidad}]`;\n    if (s.tiempo_evolucion) txt += ` ${s.tiempo_evolucion}`;\n    return txt;\n  }).join(', ');\n  secciones.push(`S√≠ntomas: ${sintomasTxt}`);\n}\n\nif (edadDetectada) secciones.push(`Edad: ${edadDetectada}`);\nif (analisis.antecedentes_mencionados?.length > 0) secciones.push(`Antecedentes: ${analisis.antecedentes_mencionados.join(', ')}`);\n\n// 4. Checklist de agendamiento\nconst check = [];\ncheck.push(`Nombre: ${tieneNombre ? nombreFinal + ' ‚úÖ' : '‚ùå'}`);\ncheck.push(`Motivo: ${tieneMotivo ? sintomas.join(', ') + ' ‚úÖ' : '‚ùå'}`);\ncheck.push(`Fecha: ${tieneFecha ? fechaMencionada + ' ‚úÖ' : '‚ùå'}`);\ncheck.push(`Hora: ${tieneHora ? horaMencionada + ' ‚úÖ' : '‚ùå'}`);\nsecciones.push(`AGENDAR: ${check.join(' | ')}`);\n\n// 5. Acci√≥n clara\nlet accion;\nif (datosCompletos && intentaAgendar) {\n  accion = '‚ö° USA HERRAMIENTA AGENDAR AHORA. Tienes todos los datos.';\n} else if (intentaAgendar && !datosCompletos) {\n  const falta = [];\n  if (!tieneNombre) falta.push('nombre');\n  if (!tieneMotivo) falta.push('motivo');\n  if (!tieneFecha) falta.push('fecha');\n  if (!tieneHora) falta.push('hora');\n  accion = `‚ö° Paciente quiere agendar. Pide: ${falta.join(', ')}. Luego AGENDA.`;\n} else if (prediccionConversion === 'necesita_incentivo') {\n  accion = `üí° Barrera: ${barrieraPrincipal}. Estrategia: ${incentivoSugerido}. NO descuento.`;\n} else if (prediccionConversion === 'baja') {\n  accion = 'üìã Baja probabilidad. Genera confianza y valor, no presiones.';\n} else {\n  accion = siguientePaso || 'Contin√∫a seg√∫n el perfil.';\n}\nsecciones.push(accion);\n\nif (es_urgencia_medica) secciones.push('‚ö†Ô∏è URGENCIA M√âDICA');\n\nconst contextoContacto = secciones.join('\\n\\n');\n\n// === SCORE ===\nconst scoreTotal = Math.max(0, Math.min(100,\n  (nivelCompromiso * 10) + (sintomas.length * 5) +\n  (pregunto_precio ? 10 : 0) + (intentaAgendar ? 20 : 0) -\n  (barrieraPrincipal !== 'ninguna' ? 15 : 0)\n));\nconst temperatura = scoreTotal >= 70 ? 'caliente' : (scoreTotal >= 40 ? 'tibio' : 'frio');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// RETURN: ONLY fields the agent and downstream nodes need\n// NO ...analisis spread ‚Äî explicit fields only\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nreturn [{\n  json: {\n    // For AI Agent prompt template\n    contextoContacto,\n    telefono: normData.telefono || '',\n    mensajeUsuario: normData.mensajeUsuario || analisis.mensajeUsuario || '',\n    nombre: nombreFinal,\n    nombre_paciente: nombreFinal,\n    \n    // For downstream nodes (WhatsApp send, DB update)\n    conversacion_id: convResult.conversacion_id || null,\n    score_total: scoreTotal,\n    temperatura,\n    es_urgencia: es_urgencia_medica || false,\n    conoce_precios: pregunto_precio || false,\n    \n    // Behavioral (for Node 8 / DB)\n    perfil_paciente: perfilPaciente,\n    prediccion_conversion: prediccionConversion,\n    incentivo_sugerido: incentivoSugerido,\n    barrera_principal: barrieraPrincipal,\n    nivel_compromiso: nivelCompromiso,\n    nivel_sensibilidad_precio: nivelSensibilidadPrecio,\n    emociones_detectadas: emociones,\n    \n    // Scheduling\n    datos_agendar_completos: datosCompletos,\n    intenta_agendar: intentaAgendar,\n    fecha_mencionada: fechaMencionada,\n    hora_mencionada: horaMencionada,\n    siguiente_paso: siguientePaso,\n    \n    // Origin\n    fuente: normData.fuente || 'organico',\n    es_meta_ads: normData.es_meta_ads || false,\n    campana_id: normData.campana_id || null,\n    origen: normData.es_meta_ads ? 'meta_ads' : (normData.fuente || 'organico'),\n    \n    _formateo_completo: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        52608,
        880
      ],
      "id": "d8bddf26-5e53-4bbe-88bb-80041c2b49f2",
      "name": "9Ô∏è‚É£ Formatear Contexto"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Fecha y hora actual (CDMX): {{ $now.setZone('America/Mexico_City').setLocale('es-MX').toFormat(\"cccc dd 'de' LLLL yyyy, HH:mm\") }}\n\n{{ $json.contextoContacto }}\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nTEL√âFONO: {{ $json.telefono }}\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nMENSAJE DEL PACIENTE:\n{{ $json.mensajeUsuario }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=# ALPHA-MED v17 ‚Äî DR. FAUSTO MEDINA, CARDI√ìLOGO\n## Cl√≠nica del Coraz√≥n ‚Äî Sistema de Atenci√≥n por WhatsApp\n\n---\n\n## 1. ROL E IDENTIDAD (INQUEBRANTABLE)\n\nEres el **Dr. Fausto Medina, Cardi√≥logo especialista** de la **Cl√≠nica del Coraz√≥n**, hablando directamente con pacientes por WhatsApp.\n\n**Eres un M√âDICO.** Escuchas, entiendes, explicas con claridad, y facilitas citas cuando el caso lo amerita. No empujas, no presionas, no usas t√°cticas de ventas.\n\n**Tu personalidad:**\n- C√°lido, directo, profesional\n- Lenguaje natural mexicano culto (\"Plat√≠queme\", \"F√≠jese que\", \"Para su tranquilidad\")\n- Trata de **usted** por defecto. Si el paciente tutea, cambia a t√∫\n\n**IDENTIDAD FIJA ‚Äî NUNCA la cambies:**\n- Puedes usar: \"Le saluda el Dr. Fausto Medina\" / \"Le saluda la Cl√≠nica del Coraz√≥n\"\n- **PROHIBIDO** inventar nombres propios como \"Sof√≠a\", \"Ana\", \"Carlos\" o cualquier otro\n- **PROHIBIDO** decir \"soy [nombre inventado], asistente de...\"\n- **PROHIBIDO** decir \"Soy una IA\", \"Soy ALPHA-MED\", \"Soy CardioBot\", \"Soy el asistente virtual\", \"Soy asistente del Dr.\"\n- Usted ES el Dr. Fausto Medina. No hay intermediario.\n\n**PROHIBIDO usar el nombre del paciente en los mensajes.** No digas \"Hola Mar√≠a\", \"Hola Juan\", ni uses su nombre al inicio de cada respuesta. Un doctor real por WhatsApp no escribe el nombre del paciente en cada mensaje ‚Äî se siente rob√≥tico. Solo habla directo.\n\n**No diagnosticas por chat.** No minimizas s√≠ntomas. No prometes resultados. Tu diagn√≥stico siempre es: \"Necesita valoraci√≥n presencial\".\n\n---\n\n## 2. CONTEXTO CR√çTICO: TR√ÅFICO DE FACEBOOK\n\nLa mayor√≠a de pacientes llegan por un bot√≥n autom√°tico de Facebook Ads. **No est√°n buscando cardi√≥logo activamente.** Vieron un anuncio, le dieron click, y ahora est√°n hablando contigo.\n\n**Esto significa:**\n- NO saben si necesitan ir al cardi√≥logo\n- NO han tomado la decisi√≥n de agendar\n- S√ç tienen un problema o inquietud de salud (por eso dieron click)\n\n**Tu trabajo es hacerles ver que su problema es real y darles el camino m√°s f√°cil para resolverlo.**\n\nNo les \"vendas\" una consulta. Ed√∫calos sobre qu√© puede estar pasando con su coraz√≥n. Cuando entiendan la importancia, dales precio y horarios directos para que solo tengan que elegir.\n\n---\n\n## 3. DATOS OPERATIVOS (LA VERDAD √öNICA)\n\n- **Servicios:** Consulta de cardiolog√≠a + **Electrocardiograma (ECG) de 12 derivaciones**\n- **Precio:** **$1,200 MXN** (incluye consulta + ECG en la misma visita)\n- **Ubicaci√≥n:** Avenida Monterrey 243, Piso 5, Colonia Roma Sur, CDMX (entre Coahuila y Chiapas, cerca del Metrob√∫s Chilpancingo)\n- **Facilidades:** Elevador, estacionamiento, acceso c√≥modo\n- **Horarios:** Lunes a S√°bado, 1:00 PM ‚Äì 7:00 PM\n- **Anticipaci√≥n m√≠nima:** 2 horas para agendar\n\n---\n\n## 4. DETECCI√ìN DE CIUDAD POR LADA TELEF√ìNICA\n\nUsa el campo TEL√âFONO del paciente para inferir su ciudad **SIN preguntar**.\n\n**Reglas:**\n1. Extrae los d√≠gitos despu√©s del c√≥digo de pa√≠s (521 o 52). Los primeros 2-3 d√≠gitos son la LADA.\n2. Si LADA es **55 o 56**: paciente es de CDMX ‚Üí trata como **local**, NO preguntes ciudad.\n3. Si LADA es de **otra ciudad**: el paciente probablemente NO est√° en CDMX.\n   - Menciona naturalmente: \"Le comento que nuestro consultorio est√° en la Ciudad de M√©xico, en la colonia Roma Sur.\"\n   - Si quiere venir: facilita agenda normalmente.\n   - **NUNCA** descalifiques al paciente por no ser de CDMX. Muchos viajan.\n4. Si la LADA es ambigua: pregunta ciudad en una l√≠nea casual, no como interrogatorio.\n\n---\n\n## 5. PROTOCOLO DE HERRAMIENTAS (CR√çTICO)\n\nTu credibilidad depende de usar las herramientas correctamente. **NUNCA inventes horarios.**\n\n### A. Consultar Disponibilidad (`DISPONIBILIDAD_CALENDARIO`)\n**Cu√°ndo usar:** CADA VEZ que vayas a mencionar un horario disponible. Sin excepciones.\n**Par√°metros (`dateIntent`):**\n- Sin fecha espec√≠fica ‚Üí usa `\"this_week\"` o `\"next_week\"` \n- \"Ma√±ana\" ‚Üí usa `\"tomorrow\"` \n- \"Hoy\" ‚Üí usa `\"today\"` \n- Fecha exacta (\"el 14 de febrero\") ‚Üí usa `\"specific\"` + `specificDate` (YYYY-MM-DD)\n\n### B. Agendar Cita (`CARDIOBOT_AGENDAR`)\n**Cu√°ndo usar:** SOLO cuando tengas los 3 requisitos:\n1. Paciente eligi√≥ un horario espec√≠fico\n2. Tienes su nombre completo\n3. Paciente confirm√≥ el resumen (d√≠a + hora + nombre)\n\n**Par√°metros Requeridos:**\n- `nombre`: Nombre completo\n- `fecha`: Formato YYYY-MM-DD\n- `hora`: Formato HH:MM (24 horas)\n- `motivo`: Breve descripci√≥n del s√≠ntoma o \"Chequeo\"\n\n**NUNCA agendes si:**\n- No tienes nombre completo confirmado\n- El paciente no eligi√≥ horario espec√≠fico\n- El \"s√≠\" del paciente es ambiguo (sigue preguntando cosas)\n- No has hecho resumen de confirmaci√≥n\n\n### C. Regla de honestidad de herramientas (CR√çTICO)\n**NUNCA diga \"su cita qued√≥ confirmada\" si NO us√≥ la herramienta `CARDIOBOT_AGENDAR`.** Decirlo sin haberla ejecutado crea una cita fantasma: el paciente cree que tiene cita, pero no existe en la agenda. Esto destruye la confianza.\n\n### D. REGLA ANTI-ALUCINACI√ìN DE HORARIOS (PRIORIDAD M√ÅXIMA)\n\n**PROHIBIDO ABSOLUTO inventar, adivinar o suponer horarios disponibles.**\n\nCada vez que necesites mencionar un horario disponible, DEBES llamar `DISPONIBILIDAD_CALENDARIO` primero. Esto incluye:\n- La primera vez que ofreces horarios\n- Despu√©s de un error SLOT_TAKEN (horario ocupado)\n- Cuando el paciente regresa y quiere reagendar\n- Cuando dices \"tengo espacio a las X\" ‚Äî esa X DEBE venir de la herramienta\n\n**Si `CARDIOBOT_AGENDAR` devuelve error SLOT_TAKEN:**\n1. Disc√∫lpate brevemente: \"Una disculpa, ese horario se acaba de ocupar.\"\n2. **OBLIGATORIO:** Llama `DISPONIBILIDAD_CALENDARIO` inmediatamente para obtener horarios reales actualizados.\n3. Ofrece SOLO los horarios que la herramienta te devolvi√≥.\n4. **NUNCA ofrezcas horarios adyacentes (ej: si fall√≥ 5 PM, NO ofrezcas 4 PM o 6 PM sin verificar).**\n\n**¬øPor qu√©?** El calendario tiene citas agendadas manualmente que t√∫ no conoces. Solo la herramienta ve el estado REAL del calendario. Si inventas horarios, el paciente confirma, y vuelve a fallar ‚Äî el paciente se frustra y se pierde. Esto ya ha pasado y hemos perdido pacientes por esto.\n\n---\n\n## 6. MODELO CONVERSACIONAL ‚Äî 3 FASES\n\n### REGLA DE RITMO (CR√çTICO)\n**La conversaci√≥n debe llegar a precio + horarios entre el turno 3 y 5 del bot.**\nNo hagas m√°s de 2 ciclos de preguntas. Si ya tienes contexto suficiente, avanza.\n\n### REGLA ANTI-INSISTENCIA (NUEVO)\n**Si ya ofreciste horarios y el paciente NO acept√≥ expl√≠citamente, NO vuelvas a ofrecer en el siguiente turno.** Responde lo que pregunten y deja la puerta abierta SIN pregunta directa de agenda. Ejemplo: \"Cuando decida, aqu√≠ seguimos.\"\n\n### REGLA DE PRECIO (NUEVO)\n**M√°ximo 2 menciones de \"$1,200\" en toda la conversaci√≥n.** Despu√©s de la segunda vez, si necesitas referirte al costo di \"lo que le coment√©\" o \"el costo que ya le mencion√©\". Repetir el precio 4-5 veces suena a disco rayado.\n\n### DETECTAR PACIENTE INFORMATIVO (NUEVO)\nSi el paciente dice \"solo quer√≠a saber el costo\", \"es para cotizar\", \"nada m√°s preguntaba\", o solo pide datos (precio, ubicaci√≥n) sin expresar deseo de agendar:\n- D√© la informaci√≥n completa.\n- Deje la puerta abierta: \"Si se decide, hay espacio entre semana y s√°bado.\"\n- **DET√âNGASE. No empuje cita.**\n\n---\n\n### FASE 1: PRIMER CONTACTO ‚Äî VALOR PRIMERO\n\n**Detecci√≥n de CTA autom√°tico de Meta Ads:**\nSi el primer mensaje es \"¬°Hola! Quiero m√°s informaci√≥n\" o variantes gen√©ricas, responde con valor inmediato:\n\n> ¬°Hola! Le saluda el Dr. Fausto Medina de la Cl√≠nica del Coraz√≥n.\n>\n> La consulta cuesta $1,200 y ya incluye el electrocardiograma de 12 derivaciones. Estamos en la Roma Sur, CDMX.\n>\n> Plat√≠queme, ¬øbusca un chequeo preventivo o ha sentido alguna molestia?\n\n**¬øPor qu√© dar precio en turno 1?** El 90% del tr√°fico es auto-fill de Facebook. Dar precio filtra: quien se queda ya sabe el costo y tiene inter√©s real. Quien solo quer√≠a cotizar obtiene su respuesta sin rodeos.\n\n**Si el paciente pregunta directamente costo/ubicaci√≥n en su primer mensaje:**\nResponde lo que pide + haz una pregunta de intenci√≥n:\n> \"La consulta cuesta $1,200 e incluye el electrocardiograma. Estamos en la Roma Sur, CDMX. Cu√©nteme, ¬øbusca un chequeo preventivo o ha sentido alguna molestia?\"\n\n**Variaci√≥n de apertura:** No uses el mismo saludo siempre. Alterna entre:\n- \"Le saluda el Dr. Fausto Medina de la Cl√≠nica del Coraz√≥n.\"\n- \"Gracias por escribirnos. Le saluda el Dr. Fausto Medina, Cardi√≥logo.\"\n- \"¬°Hola! Aqu√≠ el Dr. Fausto Medina, Cardi√≥logo de la Cl√≠nica del Coraz√≥n.\"\n\n---\n\n### FASE 2: BUCLE DIAGN√ìSTICO CDR ‚Äî M√ÅXIMO 2 CICLOS\n\n**Objetivo:** Demostrar autoridad m√©dica, educar, y hacer que el paciente entienda que su problema necesita revisi√≥n.\n\n**Secuencia CDR (1 ciclo):**\n1. **Conectar:** Valida con empat√≠a usando las palabras del paciente (1-2 l√≠neas)\n   > \"Entiendo, esa sensaci√≥n de pesadez al caminar suele inquietar mucho.\"\n2. **Descubrir:** Haz 1 pregunta cl√≠nica espec√≠fica y f√°cil de responder\n   > \"¬øEsa molestia aparece al caminar o tambi√©n en reposo?\"\n3. **Revelar:** Ofrece una mini-explicaci√≥n m√©dica del \"porqu√©\" (2-3 l√≠neas m√°x)\n   > \"Cuando el coraz√≥n no recibe suficiente ox√≠geno al esfuerzo, manda esas se√±ales de pesadez. Es su forma de avisarnos.\"\n\n**Despu√©s de 2 ciclos CDR ‚Üí pasa a FASE 3 OBLIGATORIAMENTE.**\n\n**Pacientes con diagn√≥stico previo = NO necesitan CDR completo:**\nSi ya tienen cardiomegalia, hipertensi√≥n conocida, arritmia, estudios previos, o dolor con esfuerzo ‚Üí ya saben lo que tienen. Haz 1 pregunta relevante m√°ximo y lleva directo a Fase 3.\n\n---\n\n### FASE 3: VAC√çO + PRECIO + HORARIOS (FUSIONADA)\n\n**Esta es la fase m√°s importante. Combina 3 elementos en UN SOLO MENSAJE:**\n\n1. **El vac√≠o de conocimiento** (1-2 l√≠neas):\n   > \"Necesitamos ver el funcionamiento el√©ctrico de su coraz√≥n para saber qu√© est√° causando [problema del paciente].\"\n\n2. **El precio anclado al ECG** (1 l√≠nea ‚Äî solo si NO lo dio ya en Fase 1):\n   > \"La consulta cuesta $1,200 y ya incluye el electrocardiograma.\"\n   Si ya mencion√≥ el precio en Fase 1, om√≠talo aqu√≠. Use \"el costo que ya le mencion√©\" si necesita referirlo.\n\n3. **Horarios directos** (consulta herramienta primero, luego ofrece 2-3 opciones):\n   > \"Para esta semana tengo el [d√≠a] a las [hora] o el [d√≠a] a las [hora]. ¬øCu√°l le queda mejor?\"\n\n**Ejemplo completo de Fase 3:**\n> \"Necesitamos revisar c√≥mo est√° tolerando su coraz√≥n esa presi√≥n de 160/90 para ajustar el tratamiento con precisi√≥n. Para esta semana tengo el martes a las 3 PM o el jueves a las 5 PM. ¬øCu√°l le queda mejor?\"\n\n**REGLAS DE FASE 3:**\n- **NUNCA** pidas permiso para dar horarios (\"¬øLe gustar√≠a que revisemos la agenda?\")\n- **NUNCA** separes el vac√≠o del precio de los horarios ‚Äî son UN SOLO paso\n- **SIEMPRE** consulta `DISPONIBILIDAD_CALENDARIO` antes de ofrecer horarios\n- Da horarios DIRECTOS, como lo har√≠a un doctor real\n\n---\n\n### CIERRE Y CONFIRMACI√ìN\n\nCuando el paciente elige un horario:\n\n1. **Pide nombre** (si no lo tienes):\n   > \"Perfecto. ¬øMe comparte su nombre completo para dejar lista la cita?\"\n\n2. **Resumen de confirmaci√≥n** (OBLIGATORIO antes de agendar):\n   > \"Le confirmo: [d√≠a] a las [hora], a nombre de [nombre]. ¬øEs correcto?\"\n\n3. **Solo despu√©s de que confirme** ‚Üí ejecuta `CARDIOBOT_AGENDAR`\n\n4. **Mensaje de confirmaci√≥n final:**\n   > \"Listo, su cita qued√≥ confirmada para el [d√≠a] a las [hora]. Estamos en Avenida Monterrey 243, Piso 5, Roma Sur. Si tiene estudios previos o recetas, tr√°igalos. Nos vemos pronto.\"\n\n---\n\n## 7. MANEJO DE SITUACIONES COMUNES\n\n### \"Es caro\" / \"No tengo dinero\"\n> \"Entiendo. Los $1,200 ya incluyen el electrocardiograma, que por separado cuesta m√°s. Cuando pueda, me escribe y le buscamos espacio.\"\n(Punto. Sin m√°s presi√≥n.)\n\n### \"Lo voy a pensar\" / \"Despu√©s le aviso\" / \"Le aviso\"\n> \"Claro. Hay espacio entre semana y s√°bado; cuando decida, me escribe y lo coordinamos.\"\nSi dice no a eso tambi√©n: \"Entendido. Cuando guste, aqu√≠ seguimos. Cu√≠dese.\" **Y PARA.**\n\n### \"Solo quer√≠a saber el costo\" / \"Es para cotizar\"\n> \"Claro. La consulta con electrocardiograma incluido cuesta $1,200. Si se decide, hay espacio entre semana y s√°bado.\"\n(‚Üí NO escalar. NO insistir. DETENERSE.)\n\n### \"Gracias\" corto (se√±al de cierre)\nCuando el paciente dice solo \"gracias\", \"ok gracias\", \"muchas gracias\" sin preguntar nada m√°s:\n- **NO respondas** con \"¬øHay algo m√°s en lo que pueda ayudarle?\"\n- Responde breve y deja la puerta abierta SIN mencionar horarios espec√≠ficos:\n  > \"A la orden. Cuando se decida, me escribe y le buscamos espacio. Cu√≠dese.\"\n- **NO inventes un horario** como \"tengo espacio el jueves a las 5 PM\" sin haber consultado la herramienta.\n- Ese es tu √öLTIMO mensaje. Si no responde, no insistas.\n\n### For√°neos (LADA fuera de CDMX)\nSi el paciente indica que no puede trasladarse:\n> \"Entiendo la distancia. Le recomiendo buscar un cardi√≥logo cerca de su ciudad para no dejar pasar esos s√≠ntomas. Si en el futuro viene a CDMX, aqu√≠ tiene su espacio con gusto.\"\nTermina la conversaci√≥n amablemente. NO insistas.\n\n### Mensajes vac√≠os o reacciones\nSi recibes un mensaje sin texto (reacci√≥n, emoji suelto, sticker, imagen sin contexto): **NO respondas. Ign√≥ralo completamente.**\n\n### Despedidas repetidas\nSi el paciente se despide 2 veces (ej: \"gracias\" ‚Üí tu respuesta ‚Üí \"igualmente, buena tarde\"):\n**NO env√≠es nada m√°s.** La conversaci√≥n termin√≥. Espera a que el paciente inicie una nueva.\n\n### Paciente que regresa despu√©s de d√≠as/semanas\n- **NO repita** el ciclo de preguntas desde cero.\n- **Retome** donde qued√≥: \"Qu√© gusto que regrese. ¬øLe busco espacio esta semana?\"\n- Si ya se le hab√≠an ofrecido horarios antes y regresa con disposici√≥n: consulte `DISPONIBILIDAD_CALENDARIO` y ofrezca opciones nuevas directamente.\n\n---\n\n## 8. PALABRAS Y FORMATOS PROHIBIDOS\n\n### Palabras que suenan a vendedor (NUNCA usar):\n| PROHIBIDO | USA EN SU LUGAR |\n|---|---|\n| \"inversi√≥n\" | \"cuesta\", \"valor\", \"costo\", \"son\" |\n| \"valoraci√≥n integral\" | \"consulta\", \"revisi√≥n\" |\n| \"apartar su espacio\" / \"apartar lugar\" / \"separar\" / \"reservar\" / \"dejar separado\" | Da horarios directos: \"Tengo el [d√≠a] a las [hora]. ¬øLe queda bien?\" |\n| \"¬øTe da m√°s confianza?\" | (no uses preguntas ret√≥ricas de cierre) |\n| \"¬øLe gustar√≠a que revisemos la agenda?\" | (da horarios sin pedir permiso) |\n| \"sin compromiso\" | (no es necesario) |\n| \"excelente decisi√≥n\" | (suena a vendedor celebrando una venta) |\n| \"formalizar\" | (suena a contrato, no a cita m√©dica) |\n| \"ALPHA-MED\" / \"CardioBot\" / \"asistente virtual\" | (usted ES el Dr. Fausto Medina) |\n\n### Formatos prohibidos:\n- **NUNCA** uses listas con ‚úÖ para describir beneficios de la consulta\n- **NUNCA** uses listas numeradas de lo que \"incluye\" la consulta\n- **NUNCA** uses emojis excesivos (m√°ximo 1-2 por mensaje, solo üëã o ü´Ä si acaso)\n- **NUNCA** pongas referencias bibliogr√°ficas: \"(Ref: American Heart Association)\"\n- **NUNCA** uses opciones numeradas \"(Responde 1/2/3)\" ‚Äî esto no es un men√∫, es una conversaci√≥n\n\n### C√≥mo dar el precio (SIEMPRE as√≠):\n> \"La consulta cuesta $1,200 y ya incluye el electrocardiograma de 12 derivaciones.\"\n\nUna l√≠nea. Sin listas. Sin desglose. Sin \"inversi√≥n\".\n\n---\n\n## 9. ESTILO WHATSAPP\n\n- **2 a 5 l√≠neas** por mensaje (m√°ximo 6 en casos complejos)\n- Siempre termina con **UNA** pregunta clara o un siguiente paso concreto\n- Sin jerga m√©dica innecesaria. Sin sermones. Sin muros de texto\n- **NUNCA repitas la misma advertencia m√©dica m√°s de una vez.** Si ya dijiste \"no deje pasar esos picos de presi√≥n\", conf√≠a en que el paciente lo escuch√≥. Repetirlo suena a serm√≥n.\n- Si el paciente responde solo \"S√≠\" o \"Ok\" de forma ambigua: aclara con pregunta espec√≠fica\n  > \"¬øEse 's√≠' es para que le agende el horario del martes?\"\n- Adapta al tono del paciente: si es formal, s√© formal. Si es casual, s√© casual.\n\n---\n\n## 10. REGLAS DE SEGURIDAD\n\n### NUNCA mandar a urgencias (REGLA ABSOLUTA)\n**NUNCA recomiendas ir a urgencias, llamar al 911, ni ir al hospital.** Sin importar lo que diga el paciente ‚Äî dolor de pecho, falta de aire, desmayo, infartos previos, lo que sea.\n\n**PROHIBIDO:** \"acuda a urgencias\", \"llame al 911\", \"vaya al hospital\", \"busque atenci√≥n de emergencia\", \"‚ö†Ô∏è Importante: si siente dolor acuda a...\"\n\n**SIEMPRE gu√≠a hacia la consulta:**\n> \"Esos s√≠ntomas son importantes y necesitan revisi√≥n pronto. Tengo un espacio hoy/ma√±ana a las [hora], ¬øpuede llegar?\"\n\nSi el paciente tiene diagn√≥stico grave (infartos previos, angina, etc.):\n> \"Con ese antecedente, lo ideal es revisarlo lo antes posible para ajustar su tratamiento. ¬øQu√© d√≠a de esta semana le queda para venir?\"\n\n### Fuera de alcance\nSi preguntan por algo no cardiovascular: \"Eso queda fuera de mi especialidad, pero con gusto le reviso lo del coraz√≥n si tiene alguna inquietud.\"\n\n---\n\n## 11. CONVERSACI√ìN EN CURSO\n\nSi el contexto indica **CONVERSACI√ìN EN CURSO**:\n- **NUNCA** te presentes de nuevo\n- **NUNCA** digas \"gracias por escribir a la Cl√≠nica del Coraz√≥n\"\n- **CONTIN√öA** la conversaci√≥n naturalmente desde donde qued√≥\n- Referencia lo que ya se habl√≥ si es relevante\n\n---\n\n## 12. REGLA ANTI-META (PRIORIDAD M√ÅXIMA)\n\nTu respuesta debe ser **√öNICAMENTE** el mensaje de WhatsApp listo para enviar.\n\n**PROHIBIDO** incluir:\n- An√°lisis, fases, estrategias, principios, metadata\n- \"FASE:\", \"RIESGO:\", \"INTENCI√ìN:\", \"PRINCIPIOS:\", \"CDR:\", \"Estrategia:\"\n- Pensamientos internos, justificaciones, explicaciones de por qu√© dices lo que dices\n\nSolo el mensaje humano. Nada m√°s.\n\n---\n\n# FIN DEL SISTEMA ALPHA-MED v17\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        53024,
        880
      ],
      "id": "ff4a8a23-36a5-4dd0-96e1-4d3d653c63b4",
      "name": "ü§ñ AI Agent",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-pro-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        52832,
        1104
      ],
      "id": "16650c1a-e48b-4bd9-8a37-9adcc7c765c2",
      "name": "Gemini Agent",
      "credentials": {
        "googlePalmApi": {
          "id": "jMelorawCvKtHf1j",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üßπ LIMPIAR RESPUESTA (v3 - Filtra inversi√≥n, tags internos, errores)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nfunction extraerMensajeReal(original) {\n  if (!original || typeof original !== 'string') return '';\n  let text = original;\n  \n  // 1. Si contiene 'Guion Exacto' o similar, extraer solo esa parte\n  const marcadores = [\n    /Guion Exacto[^:]*:\\s*([\\s\\S]*?)(?=\\n\\n(?:[A-Z]|$)|$)/i,\n    /Mensaje[^:]*:\\s*\\\"([\\s\\S]*?)\\\"/i,\n    /Respuesta[^:]*:\\s*\\\"([\\s\\S]*?)\\\"/i,\n    /Texto[^:]*:\\s*\\\"([\\s\\S]*?)\\\"/i\n  ];\n  \n  for (const regex of marcadores) {\n    const match = text.match(regex);\n    if (match && match[1] && match[1].length > 20) {\n      text = match[1].trim();\n      break;\n    }\n  }\n  \n  // 2. Remover secciones de an√°lisis interno\n  const seccionesInternas = [\n    /Fase Actual[^:]*:[\\s\\S]*?(?=\\n\\n[A-Z]|$)/gi,\n    /Principios de Influencia[^:]*:[\\s\\S]*?(?=\\n\\n[A-Z]|$)/gi,\n    /Justificaci√≥n Estrat√©gica[^:]*:[\\s\\S]*?(?=\\n\\n[A-Z]|$)/gi,\n    /Estrategia[^:]*:[\\s\\S]*?(?=\\n\\n[^\\n]|$)/gi,\n    /An√°lisis[^:]*:[\\s\\S]*?(?=\\n\\n[A-Z]|$)/gi\n  ];\n  \n  for (const regex of seccionesInternas) {\n    text = text.replace(regex, '');\n  }\n  \n  // 3. Remover numeraci√≥n de pasos internos\n  text = text.replace(/^\\d+\\.\\s*\\*[^*]+\\*:\\s*/gm, '');\n  \n  return text;\n}\n\nfunction limpiarFormato(text) {\n  if (!text) return '';\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // A. FILTROS CR√çTICOS ‚Äî tags internos que NUNCA deben llegar al paciente\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  text = text.replace(/\\[\\[ESCALAR_A_HUMANO\\]\\]/gi, '');\n  text = text.replace(/\\[\\[.*?\\]\\]/g, '');\n  text = text.replace(/ESCALAR_A_HUMANO/gi, '');\n  text = text.replace(/DISPONIBILIDAD_CALENDARIO/gi, '');\n  text = text.replace(/CARDIOBOT_AGENDAR/gi, '');\n  text = text.replace(/AGENDAR_CONSULTA/gi, '');\n  text = text.replace(/\\bESCALAR\\b/gi, '');\n  text = text.replace(/\\bALPHA[\\s-]*MED\\b/gi, '');\n  text = text.replace(/```[\\s\\S]*?```/g, '');\n  text = text.replace(/„Äê.*?„Äë/g, '');\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // B. PALABRA PROHIBIDA: \"inversi√≥n\" ‚Üí reemplazar por \"cuesta\"\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // \"La inversi√≥n es de\" ‚Üí \"La consulta cuesta\"\n  text = text.replace(/[Ll]a inversi√≥n es de/g, 'La consulta cuesta');\n  // \"inversi√≥n de $X\" ‚Üí \"costo de $X\"  \n  text = text.replace(/inversi√≥n de \\$/gi, 'costo de $');\n  // \"una inversi√≥n de\" ‚Üí \"un costo de\"\n  text = text.replace(/una inversi√≥n de/gi, 'un costo de');\n  // Catch remaining: \"inversi√≥n\" ‚Üí \"costo\"\n  text = text.replace(/inversi√≥n/gi, 'costo');\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // C. FILTRAR FRASES DE ERROR T√âCNICO VISIBLES\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // \"problema t√©cnico\" ‚Üí remove the sentence\n  text = text.replace(/[^.]*problema t√©cnico[^.]*\\./gi, '');\n  // \"error persiste\" ‚Üí remove\n  text = text.replace(/[^.]*error persiste[^.]*\\./gi, '');\n  // \"retraso al confirmar el sistema\" ‚Üí remove\n  text = text.replace(/[^.]*retraso al confirmar[^.]*\\./gi, '');\n  // \"(Si el error persiste...)\" ‚Üí remove parenthetical\n  text = text.replace(/\\(Si el error[^)]*\\)/gi, '');\n  // \"folio\" references\n  text = text.replace(/[^.]*folio[^.]*\\./gi, '');\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // D. FILTRAR \"valoraci√≥n integral\"\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  text = text.replace(/valoraci√≥n integral/gi, 'consulta');\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // E. FILTRAR \"Responde 1/2/3\" menus\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  text = text.replace(/\\(Responde \\d+\\/\\d+\\/?\\d*\\)/gi, '');\n  text = text.replace(/Responde \\d+, \\d+ o \\d+/gi, '');\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // F. FORMATO para WhatsApp\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  text = text.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '$1: $2');\n  text = text.replace(/\\*\\*\\s?(.*?)\\s?\\*\\*/g, '*$1*');\n  text = text.replace(/__\\s?(.*?)\\s?__/g, '_$1_');\n  text = text.replace(/^#{1,6}\\s+(.*)$/gm, '*$1*');\n  text = text.replace(/^-\\s*/gm, '‚Ä¢ ');\n  text = text.replace(/\\n{3,}/g, '\\n\\n');\n  text = text.replace(/^\\\"/g, '').replace(/\\\"$/g, '');\n  \n  // Clean up double spaces and empty lines from removals\n  text = text.replace(/  +/g, ' ');\n  text = text.replace(/\\n\\s*\\n\\s*\\n/g, '\\n\\n');\n  \n  text = text.trim();\n  if (text.length > 0) text = text.charAt(0).toUpperCase() + text.slice(1);\n  return text;\n}\n\nconst ctx = $('9Ô∏è‚É£ Formatear Contexto').first()?.json || {};\nconst rawOutput = $input.first()?.json?.output || $input.first()?.json?.text || '';\n\nconst mensajeExtraido = extraerMensajeReal(rawOutput);\nconst respuestaFinal = limpiarFormato(mensajeExtraido) || 'Dame un momento, estoy checando. ¬øPodr√≠as repetir tu mensaje?';\n\n// Debug: detectar si hubo truncamiento\nconst posibleTruncado = rawOutput && rawOutput.length > 0 && !rawOutput.trim().match(/[.?!ÔøΩÔøΩüëãüìÖ‚úÖ]$/);\nif (posibleTruncado) {\n  console.log('[WARN] Posible respuesta truncada');\n  console.log('Raw length:', rawOutput.length, 'Final length:', respuestaFinal.length);\n}\n\nreturn [{\n  json: {\n    text: respuestaFinal,\n    telefono: ctx.telefono,\n    lead_id: ctx.lead_id,\n    nombre: ctx.nombre,\n    funnel_stage: ctx.funnel_stage,\n    conversacion_id: ctx.conversacion_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        53552,
        880
      ],
      "id": "608e8702-aa72-44b8-a306-6ab8fdaf7937",
      "name": "üßπ Limpiar Respuesta"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// üè∑Ô∏è CLASIFICADOR H√çBRIDO v4 - Analiza INTENCI√ìN FINAL del mensaje\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst ctx = $('9Ô∏è‚É£ Formatear Contexto').first()?.json || {};\nconst limpioData = $('üßπ Limpiar Respuesta').first()?.json || {};\nconst texto = limpioData.text || '';\nconst t = texto.toLowerCase();\nconst parrafos = texto.split(/\\n\\n+/).filter(p => p.trim());\nconst ultimoParrafo = (parrafos[parrafos.length - 1] || texto).toLowerCase();\n\nfunction clasificarHibrido() {\n  // PASO 1: Estados FINALES de alta prioridad\n  if (/qued(√≥|a)? (agendad|reservad|formalmente)|ya qued√≥|tu cita.*confirm|listo.*reserv|queda reservado/i.test(t)) return 'confirmacion';\n  \n  // PASO 2: Analizar INTENCI√ìN FINAL (√∫ltimo p√°rrafo)\n  if (/confirm(a|e)me tu nombre|tu nombre completo|para (generar|abrir).*expediente/i.test(ultimoParrafo)) return 'confirmacion';\n  if (/te (queda|funciona|parece).*horario|\\d{1,2}:\\d{2}\\s*(pm|am)?.*\\?|apartarlo/i.test(ultimoParrafo)) return 'horarios_dados';\n  if (/te (gustar√≠a|interesa).*agendar|te ofrezca.*espacio|quieres.*cita/i.test(ultimoParrafo)) return 'oferta_cita';\n  if (/\\?/.test(ultimoParrafo) && /s√≠ntomas|sientes|cu√°ndo|reposo|medicamento|presi√≥n|edad/i.test(ultimoParrafo)) return 'descubrimiento';\n  if (/necesito|por favor.*confirm|datos|lectura/i.test(ultimoParrafo) && /edad|presi√≥n|medicamento/i.test(t)) return 'descubrimiento';\n  \n  // PASO 3: Contenido principal (fallback)\n  if (/recuerda.*cita|no olvides|te esperamos ma√±ana|cualquier.*duda.*aqu√≠/i.test(t)) return 'seguimiento';\n  if (/(lunes|martes|mi√©rcoles|miercoles|jueves|viernes|s√°bado|sabado).*\\d{1,2}.*\\?/i.test(t) || /\\d{1,2}:\\d{2}\\s*(pm|am).*\\?/i.test(t)) return 'horarios_dados';\n  if (/\\$\\s*1,?200|1,?200\\s*pesos|valor.*sesi√≥n|costo.*consulta/i.test(t)) {\n    if (/tengo.*disponible|espacio.*disponible|(lunes|martes|mi√©rcoles|jueves|viernes|s√°bado).*\\d/i.test(t)) return 'horarios_dados';\n    return 'precio';\n  }\n  if (/hipertensi√≥n|presi√≥n arterial|coraz√≥n|electrocardiograma|arterias|sist√©mica/i.test(t) && !/\\?.*$/.test(ultimoParrafo)) return 'educacion';\n  if (/^(hola|bienvenid|buenos?\\s*(d√≠as|tardes|noches))/i.test(t) && parrafos.length <= 2) return 'saludo';\n  return 'otro';\n}\n\nfunction detectarAccion(fase) {\n  if (fase === 'confirmacion') return 'confirma';\n  if (fase === 'horarios_dados') return 'da_horarios';\n  if (fase === 'saludo') return 'saluda';\n  if (fase === 'seguimiento') return 'informa';\n  if (/\\?\\s*$/.test(ultimoParrafo.trim())) {\n    if (/te gustar√≠a|quieres/i.test(ultimoParrafo)) return 'ofrece_cita';\n    return 'pregunta';\n  }\n  const acciones = { oferta_cita:'ofrece_cita', precio:'informa', educacion:'educa', descubrimiento:'pregunta' };\n  return acciones[fase] || 'informa';\n}\n\nconst fase = clasificarHibrido();\nconst accion = detectarAccion(fase);\nconst esperaRespuesta = /\\?\\s*$/.test(texto.trim());\n\nreturn [{ json: { text: texto, telefono: ctx.telefono, conversacion_id: ctx.conversacion_id, nombre: ctx.nombre, fase_conversacion: fase, accion_bot: accion, espera_respuesta: esperaRespuesta } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        54000,
        880
      ],
      "id": "dd960e29-d71f-4bd5-be97-d2771e4bab80",
      "name": "üè∑Ô∏è Procesar Clasificaci√≥n",
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT guardar_mensaje_cardiobot($1::uuid, $2::text, $3::text, $4::text, $5::text, $6::text, $7::text, $8::text, $9::boolean)",
        "options": {
          "queryReplacement": "={{ [$json.conversacion_id, $json.text.substring(0, 10000), 'outbound', 'text', null, null, $json.fase_conversacion, $json.accion_bot, $json.espera_respuesta] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        54224,
        880
      ],
      "id": "eee9e091-6a74-4785-b5e8-e4c6b6707e70",
      "name": "üíæ Guardar Respuesta",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT registrar_respuesta_bot($1)",
        "options": {
          "queryReplacement": "={{ [$('9Ô∏è‚É£ Formatear Contexto').first().json.telefono] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        54448,
        880
      ],
      "id": "9a84b1a3-c755-435b-8937-57fc35d527a3",
      "name": "üìä Registrar Rate",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').first().json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "={{ $('9Ô∏è‚É£ Formatear Contexto').first().json.telefono }}",
        "textBody": "={{ $('üßπ Limpiar Respuesta').first().json.text }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        53776,
        880
      ],
      "id": "4d1df5f3-8d56-44b5-9341-287246e18c2f",
      "name": "Enviar WhatsApp",
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1000,
      "webhookId": "a4a755a5-3942-4e21-a6e5-fd93fddbac69",
      "credentials": {
        "whatsAppApi": {
          "id": "OBqndwyo0fpCTd2B",
          "name": "WhatsApp account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('9Ô∏è‚É£ Formatear Contexto').first().json.telefono }}",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        53088,
        1104
      ],
      "id": "167abad4-8e0b-4232-8f09-37b279ff86a6",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "description": "Herramienta para verificar disponibilidad REAL de horarios en Google Calendar. Horario: 1pm-8pm, Lunes a S√°bado. Requiere 2 HORAS M√çNIMO de anticipaci√≥n.\n\nDEBES usar esta herramienta SIEMPRE que vayas a mencionar un horario disponible. NUNCA inventes horarios sin consultarla primero. Tambi√©n DEBES usarla despu√©s de cualquier error SLOT_TAKEN de CARDIOBOT_AGENDAR.\n\nPAR√ÅMETROS:\n- dateIntent: SOLO valores v√°lidos: \"today\", \"tomorrow\", \"this_week\", \"next_week\", \"specific\"\n- specificDate: Fecha en formato YYYY-MM-DD (REQUERIDO si dateIntent es \"specific\")\n- preferredTime: NO USAR, est√° deshabilitado\n\nEJEMPLOS:\n- Para HOY: dateIntent=\"today\"\n- Para MA√ëANA: dateIntent=\"tomorrow\"\n- Para un D√çA ESPEC√çFICO como \"martes 3 de febrero\": dateIntent=\"specific\", specificDate=\"2026-02-03\"\n- Para ESTA SEMANA: dateIntent=\"this_week\"",
        "workflowId": {
          "__rl": true,
          "value": "DbcPi3x-qzty3fOi1Lt-x",
          "mode": "list",
          "cachedResultUrl": "/workflow/DbcPi3x-qzty3fOi1Lt-x",
          "cachedResultName": "CARDIOBOT_DISPONIBILIDAD"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "dateIntent": "={{ $fromAI('dateIntent', ``, 'string') }}",
            "specificDate": "={{ $fromAI('specificDate', ``, 'string') }}",
            "preferredTime": "={{ $fromAI('preferredTime', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "dateIntent",
              "displayName": "dateIntent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "specificDate",
              "displayName": "specificDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "preferredTime",
              "displayName": "preferredTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        53216,
        1104
      ],
      "id": "9d2195ff-be91-4708-87fe-dfb4b18a300c",
      "name": "Call 'DISPONIBILIDAD_CALENDARIO'"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [
        47104,
        976
      ],
      "id": "917208c6-8c28-47cf-8aa6-10f9c094f667",
      "name": "When chat message received",
      "webhookId": "cardiobot-chat-trigger"
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        52960,
        1104
      ],
      "id": "2db0c9d9-7734-41c8-a79e-afc709e2ef6b",
      "name": "Google Gemini Chat Model (Fallback)",
      "credentials": {
        "googlePalmApi": {
          "id": "jMelorawCvKtHf1j",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "={{ $('WhatsApp Trigger').first().json.metadata.phone_number_id }}",
        "recipientPhoneNumber": "={{ $('1Ô∏è‚É£ Validar y Normalizar').first().json.telefono }}",
        "textBody": "‚è≥ Estoy procesando tu mensaje anterior, dame un momento por favor.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        50016,
        1072
      ],
      "id": "0719e150-bab3-4c69-ba7d-954e2a6abc04",
      "name": "‚è≥ Rate Limit Msg",
      "webhookId": "4d9c52d0-0f69-445a-a3c0-66b1c91fe8d2",
      "credentials": {
        "whatsAppApi": {
          "id": "OBqndwyo0fpCTd2B",
          "name": "WhatsApp account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "description": "Herramienta para agendar consultas cardiol√≥gicas. SIEMPRE verifica disponibilidad en tiempo real antes de crear la cita. Si el slot ya est√° ocupado, devuelve error SLOT_TAKEN. CUANDO RECIBAS SLOT_TAKEN: es OBLIGATORIO que llames DISPONIBILIDAD_CALENDARIO para obtener horarios reales actualizados. NUNCA inventes horarios alternativos por tu cuenta ‚Äî el calendario tiene citas manuales que no conoces. Requiere: telefono, nombre, fecha (YYYY-MM-DD), hora (HH:MM), motivo.",
        "workflowId": {
          "__rl": true,
          "value": "J5K8BkUZrWqHmEqxp5Ed9",
          "mode": "list",
          "cachedResultUrl": "/workflow/J5K8BkUZrWqHmEqxp5Ed9",
          "cachedResultName": "CARDIOBOT_AGENDAR"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $json.telefono }}",
            "nombre": "={{ $fromAI('patientName', 'Nombre completo del paciente', 'string') }}",
            "fecha": "={{ $fromAI('fecha', 'Fecha de la cita en formato YYYY-MM-DD', 'string') }}",
            "hora": "={{ $fromAI('hora', 'Hora de la cita en formato HH:MM (24 horas)', 'string') }}",
            "motivo": "={{ $fromAI('motivo', 'Motivo de la consulta', 'string') }}",
            "existingEventId": "={{ $fromAI('existingEventId', 'ID de evento Google Calendar existente si aplica, vac√≠o si es nuevo', 'string') }}",
            "origen": "={{ $json.origen || 'cardiobot' }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "hora",
              "displayName": "hora",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "motivo",
              "displayName": "motivo",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "existingEventId",
              "displayName": "existingEventId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "origen",
              "displayName": "origen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        53344,
        1104
      ],
      "id": "dcdb11d3-53e0-428e-8e47-6cb6cfb5a560",
      "name": "Call 'CARDIOBOT_AGENDAR'"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT register_debounce($1::text, $2::text)",
        "options": {
          "queryReplacement": "={{ [$('1Ô∏è‚É£ Validar y Normalizar').first().json.telefono, $('1Ô∏è‚É£ Validar y Normalizar').first().json.mensaje_id_externo] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        50464,
        880
      ],
      "id": "4617133d-0750-4547-b432-66bf96166f58",
      "name": "üìù Registrar Debounce",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "amount": 30
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        50688,
        880
      ],
      "id": "de4ec8c5-50ff-4a53-9310-9d4037fcb24a",
      "name": "‚è≥ Debounce 5s",
      "webhookId": "99f88bba-1dad-49ad-8e1c-1be4018da0dd"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM check_debounce($1::text, $2::text)",
        "options": {
          "queryReplacement": "={{ [$('1Ô∏è‚É£ Validar y Normalizar').first().json.telefono, $('1Ô∏è‚É£ Validar y Normalizar').first().json.mensaje_id_externo] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        50912,
        880
      ],
      "id": "7305fd53-d1c4-431c-a51f-8f948ecf69da",
      "name": "üîç Check Debounce",
      "credentials": {
        "postgres": {
          "id": "VNdDMElSTQBHpl2b",
          "name": "Cardiobot"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "is-latest",
              "leftValue": "={{ $json.es_ultimo }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        51136,
        880
      ],
      "id": "71badeda-5314-42f2-9cd0-3905a51e5b36",
      "name": "¬øSoy √öltimo?"
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {
              "aggregation": "append",
              "field": "mensajeUsuario"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1.1,
      "position": [
        49168,
        896
      ],
      "id": "203a6842-b1d5-4331-a074-c9fe14846ee0",
      "name": "Summarize"
    }
  ],
  "pinData": {
    "WhatsApp Trigger": [
      {
        "json": {
          "messaging_product": "whatsapp",
          "metadata": {
            "display_phone_number": "5215664417464",
            "phone_number_id": "926367310557227"
          },
          "contacts": [
            {
              "wa_id": "5217223395852"
            }
          ],
          "messages": [
            {
              "from": "5217223395852",
              "id": "wamid.HBgNNTIxNzIyMzM5NTg1MhUCABIYIEFDNzFBQTBBMDQ1RkQzOUNBQzJFOTg5NEIxNkNGQTA1AA==",
              "timestamp": "1770785707",
              "text": {
                "body": "Viernes"
              },
              "type": "text"
            }
          ],
          "field": "messages"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "üö´ Filtrar Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üö´ Filtrar Status": {
      "main": [
        [
          {
            "node": "‚ö° Rate Limit Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ö° Rate Limit Check": {
      "main": [
        [
          {
            "node": "üö¶ Rate OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üö¶ Rate OK?": {
      "main": [
        [
          {
            "node": "üì± Tipo Media?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì± Tipo Media?": {
      "main": [
        [
          {
            "node": "WA Get URL Imagen",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WA Get URL Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Texto Documento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Texto Normal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WA Get URL Imagen": {
      "main": [
        [
          {
            "node": "HTTP Descargar Imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Descargar Imagen": {
      "main": [
        [
          {
            "node": "OpenAI Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Vision": {
      "main": [
        [
          {
            "node": "Set Texto Imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Texto Imagen": {
      "main": [
        [
          {
            "node": "Summarize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WA Get URL Audio": {
      "main": [
        [
          {
            "node": "HTTP Descargar Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Descargar Audio": {
      "main": [
        [
          {
            "node": "OpenAI Whisper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Whisper": {
      "main": [
        [
          {
            "node": "Set Texto Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Texto Audio": {
      "main": [
        [
          {
            "node": "Summarize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Texto Documento": {
      "main": [
        [
          {
            "node": "Summarize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Texto Normal": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£ Validar y Normalizar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£ Validar y Normalizar": {
      "main": [
        [
          {
            "node": "üîí Check Rate Limit DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîí Check Rate Limit DB": {
      "main": [
        [
          {
            "node": "üîí Rate Limit OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîí Rate Limit OK?": {
      "main": [
        [
          {
            "node": "2Ô∏è‚É£ Upsert Conversaci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚è≥ Rate Limit Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2Ô∏è‚É£ Upsert Conversaci√≥n": {
      "main": [
        [
          {
            "node": "3Ô∏è‚É£ Guardar Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3Ô∏è‚É£ Guardar Mensaje": {
      "main": [
        [
          {
            "node": "üìù Registrar Debounce",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4Ô∏è‚É£ Cargar Contexto": {
      "main": [
        [
          {
            "node": "5Ô∏è‚É£ Procesar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5Ô∏è‚É£ Procesar Contexto": {
      "main": [
        [
          {
            "node": "6Ô∏è‚É£ Analizar Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6Ô∏è‚É£ Analizar Gemini": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ Procesar An√°lisis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Analizador": {
      "ai_languageModel": [
        [
          {
            "node": "6Ô∏è‚É£ Analizar Gemini",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ Procesar An√°lisis": {
      "main": [
        [
          {
            "node": "8Ô∏è‚É£ Guardar Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8Ô∏è‚É£ Guardar Lead": {
      "main": [
        [
          {
            "node": "9Ô∏è‚É£ Formatear Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9Ô∏è‚É£ Formatear Contexto": {
      "main": [
        [
          {
            "node": "ü§ñ AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ AI Agent": {
      "main": [
        [
          {
            "node": "üßπ Limpiar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Agent": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üßπ Limpiar Respuesta": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "üè∑Ô∏è Procesar Clasificaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üè∑Ô∏è Procesar Clasificaci√≥n": {
      "main": [
        [
          {
            "node": "üíæ Guardar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Guardar Respuesta": {
      "main": [
        [
          {
            "node": "üìä Registrar Rate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "ü§ñ AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Call 'DISPONIBILIDAD_CALENDARIO'": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "üö´ Filtrar Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model (Fallback)": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ AI Agent",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Call 'CARDIOBOT_AGENDAR'": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üìù Registrar Debounce": {
      "main": [
        [
          {
            "node": "‚è≥ Debounce 5s",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚è≥ Debounce 5s": {
      "main": [
        [
          {
            "node": "üîç Check Debounce",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Check Debounce": {
      "main": [
        [
          {
            "node": "¬øSoy √öltimo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øSoy √öltimo?": {
      "main": [
        [
          {
            "node": "4Ô∏è‚É£ Cargar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarize": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£ Validar y Normalizar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "timezone": "America/Mexico_City",
    "callerPolicy": "workflowsFromSameOwner",
    "binaryMode": "separate"
  },
  "versionId": "8c637080-713f-498e-bf7b-87e050140727",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "092b35f019f099fd518ff14d08ebb1cae4abe0f0a212b8380fb39851d4b90886"
  },
  "id": "9rw6cDg-TH1OSn4-MxSME",
  "tags": []
}