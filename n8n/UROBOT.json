{
  "name": "UROBOT",
  "nodes": [
    {
      "parameters": {
        "description": "Cu√°ndo usar esta herramienta (activar de inmediato)\n\nCuando el usuario pregunte por horarios disponibles: ¬´¬øhay disponibilidad?¬ª, ¬´¬øcu√°ndo hay citas?¬ª.\n\nCuando mencione una fecha relativa o espec√≠fica: ¬´quiero agendar el viernes¬ª, ¬´ma√±ana¬ª, ¬´la pr√≥xima semana¬ª.\n\nCuando pregunte por una sede: ¬´¬øhay horarios en Polanco?¬ª.\n\nCuando use palabras clave: disponibilidad, horario, cita, agendar, consulta.\n\nPar√°metros a extraer\n\ndesiredStart (string, ISO 8601 UTC): fecha/hora de referencia.\nReglas de conversi√≥n (zona base: America/Mexico_City):\n\n¬´ma√±ana¬ª ‚Üí ma√±ana a las 00:00:00 hora local, convertida a UTC y expresada con sufijo Z.\n\n¬´viernes¬ª ‚Üí pr√≥ximo viernes a las 00:00:00 hora local, convertida a UTC (con Z).\n\n¬´la pr√≥xima semana¬ª ‚Üí pr√≥ximo lunes a las 00:00:00 hora local, convertida a UTC (con Z).\n\nSi NO menciona fecha ‚Üí hoy a las 00:00:00 hora local, convertida a UTC (con Z).\nFormato requerido: YYYY-MM-DDTHH:MM:SSZ\nEjemplo: 2025-10-17T00:00:00Z\n\nuserText (string): mensaje original del usuario, sin modificaciones.\n\nsedePreferida (string): sede solicitada por el usuario.\nValores v√°lidos (siempre en may√∫sculas): POLANCO, SATELITE.\nNormalizaci√≥n:\n\n¬´polanco¬ª, ¬´Polanco¬ª ‚Üí POLANCO\n\n¬´sat√©lite¬ª, ¬´satelite¬ª, ¬´Satelite¬ª ‚Üí SATELITE\n\nSi NO menciona sede ‚Üí cadena vac√≠a ''.\n\ntimezone (string): enviar siempre America/Mexico_City.\n\nEjemplos\n\nUsuario: ¬´Quiero cita ma√±ana en Polanco¬ª\n‚Üí desiredStart: ma√±ana 00:00 local ‚Üí a UTC con Z\n‚Üí userText: ¬´Quiero cita ma√±ana en Polanco¬ª\n‚Üí sedePreferida: POLANCO\n\nUsuario: ¬´¬øHay horarios el viernes?¬ª\n‚Üí desiredStart: pr√≥ximo viernes 00:00 local ‚Üí a UTC con Z\n‚Üí userText: ¬´¬øHay horarios el viernes?¬ª\n‚Üí sedePreferida: ''\n\nUsuario: ¬´¬øCu√°ndo tienen disponibilidad?¬ª\n‚Üí desiredStart: hoy 00:00 local ‚Üí a UTC con Z\n‚Üí userText: ¬´¬øCu√°ndo tienen disponibilidad?¬ª\n‚Üí sedePreferida: ''\n\nReglas importantes\n\nNunca inventes horarios: usa siempre esta herramienta para consultar disponibilidad.\n\nSiempre extrae y normaliza la fecha si el usuario la menciona (convierte lenguaje natural ‚Üí ISO 8601 con Z).\n\nSedes siempre en may√∫sculas y limitarse a los valores v√°lidos indicados.\n\nLa marca Z implica UTC: calcula en hora local America/Mexico_City y convierte a UTC antes de formatear.",
        "workflowId": {
          "__rl": true,
          "value": "HtbhK8aN1uBbKCLU",
          "mode": "list",
          "cachedResultUrl": "/workflow/HtbhK8aN1uBbKCLU",
          "cachedResultName": "DISPONIBILIDAD_CALENDARIO"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "maxResults": 50,
            "desiredStart": "={{ $fromAI('desiredStart', $now.toUTC().toISO(), 'string') }}",
            "userText": "={{ $fromAI('userText', $json.mensajeUsuario || '', 'string') }}",
            "sedePreferida": "={{ $fromAI('sedePreferida', '', 'string').toUpperCase() }}",
            "timezone": "America/Mexico_City",
            "windowDays": 14,
            "requestId": "={{ $now.toMillis() + '-' + Math.random().toString(36).substr(2, 9) }}",
            "source": "urobot_whatsapp"
          },
          "matchingColumns": [
            "params"
          ],
          "schema": [
            {
              "id": "desiredStart",
              "displayName": "desiredStart",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "userText",
              "displayName": "userText",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "sedePreferida",
              "displayName": "sedePreferida",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "timezone",
              "displayName": "timezone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "windowDays",
              "displayName": "windowDays",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "maxResults",
              "displayName": "maxResults",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "includeWeekends",
              "displayName": "includeWeekends",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            },
            {
              "id": "onlyMorning",
              "displayName": "onlyMorning",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            },
            {
              "id": "onlyAfternoon",
              "displayName": "onlyAfternoon",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "boolean",
              "removed": false
            },
            {
              "id": "requestId",
              "displayName": "requestId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "source",
              "displayName": "source",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false,
          "values": {
            "string": [
              {
                "name": "userText",
                "value": "={{$json.mensajeUsuario}}"
              },
              {
                "name": "sedePreferida",
                "value": "={{$json.sedePreferida || \"\"}}"
              },
              {
                "name": "timezone",
                "value": "America/Mexico_City"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4784,
        432
      ],
      "id": "3e835cab-bf7c-4632-acd7-1638fd5c0165",
      "name": "call'GET_DISPONIBILIDAD_CALENDARIOS"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "=# UroBot v12 ‚Äî Asistente conversacional con herramientas (Dr. Mario Mart√≠nez, Urolog√≠a)\n\n**SISTEMA**  \n- NOMBRE: **UroBot** ‚Äî Asistente de Agenda M√©dica del **Dr. Mario Mart√≠nez Thomas (Urolog√≠a)**  \n- TIMEZONE_BASE: `America/Mexico_City` (manejo autom√°tico de horario de verano/invierno)  \n- FECHA_ACTUAL: `{{ $now.setZone('America/Mexico_City').toISO() }}`  \n- DIA_HOY: `{{ $today.setZone('America/Mexico_City').toFormat('dd/MM/yyyy') }}`  \n- HORA_ACTUAL: `{{ $now.setZone('America/Mexico_City').toFormat('HH:mm') }}`\n\n---\n\n## Identidad, tono y l√≠mites\n\n**Identidad**  \n- Nombre: **UroBot**  \n- Rol: Asistente virtual de la Cl√≠nica de Urolog√≠a del Dr. Mario Mart√≠nez\n\n**Personalidad y comunicaci√≥n**  \n- Profesional, cercano, emp√°tico y proactivo  \n- Usa **‚Äút√∫‚Äù**  \n- Mensajes concisos (m√°x. 4‚Äì5 l√≠neas por bloque), emojis muy pocos (üìçüè•‚úÖ‚ùå)  \n- Lenguaje m√©dico accesible (explica t√©rminos complejos)  \n- Confirma datos cr√≠ticos antes de procesar\n\n**Evitar**  \n- Ser rob√≥tico o demasiado formal  \n- ‚ÄúMuros de texto‚Äù  \n- Informaci√≥n t√©cnica interna (UUIDs, status codes, nombres de herramientas)  \n- Promesas que no puedas cumplir  \n- Diagn√≥sticos o especulaci√≥n m√©dica\n\n**Reglas n√∫cleo**  \n1) Horarios/costos/direcciones ‚Üí **responde directo** desde este prompt (no RAG).  \n2) Disponibilidad / Agendar / Reagendar / Escalar / Confirmaciones ‚Üí **usa herramientas**.  \n3) **Zona horaria**: interpreta fechas y horas **en CDMX** y **convierte a UTC con Z** usando funciones de fecha. **No sumes offsets manuales**.  \n4) **Validaciones** antes de herramientas: fecha futura (‚â•2 h), d√≠a/horario v√°lido por sede, nombre completo, tel√©fono 10 d√≠gitos, motivo ‚â•3 palabras.  \n5) **Privacidad**: nunca expongas IDs, timestamps ISO, ni errores internos.\n\n---\n\n## üö® Urgencias m√©dicas (m√°xima prioridad)\n\n**Banderas rojas (requieren atenci√≥n inmediata)**  \n- Dolor intenso que no responde a analg√©sicos  \n- Sangrado genital abundante o activo  \n- Fiebre > 38.5¬∞C con escalofr√≠os  \n- Retenci√≥n urinaria completa  \n- Trauma genital severo  \n- Hinchaz√≥n testicular s√∫bita con dolor intenso  \n- Priapismo (>4 horas, doloroso)  \n- Hematuria con dolor severo  \n- Infecci√≥n genital con fiebre alta\n\n**Palabras clave**: ‚Äúno puedo orinar‚Äù, ‚Äúsangre abundante‚Äù, ‚Äúgolpe fuerte‚Äù, ‚Äúdolor insoportable‚Äù, ‚Äúfiebre alta‚Äù, ‚Äúhinchaz√≥n s√∫bita‚Äù, ‚Äúno para de doler‚Äù.\n\n**Acci√≥n inmediata (copiar textualmente)**\n\n> üö® IMPORTANTE: Tu situaci√≥n requiere atenci√≥n m√©dica urgente AHORA.  \n>  \n> Por favor acude de inmediato a:  \n>  \n> üè• Hospital √Ångeles Santa M√≥nica (Polanco)  \n> üìç Tem√≠stocles 210, Polanco, CDMX  \n> ‚è∞ 24 horas  \n>  \n> üè• Hospital San √Ångel Inn Sat√©lite  \n> üìç Circuito Centro Comercial 2251, Sat√©lite  \n> ‚è∞ 24 horas  \n>  \n> Si el dolor es muy intenso o hay sangrado abundante, llama al 911.  \n>  \n> Una vez recibida la atenci√≥n, con gusto te ayudo a agendar una consulta de control con el Dr. Mario.\n\n**Regla cr√≠tica**: **No** ofrecer cita regular para s√≠ntomas de urgencia. Derivar a urgencias primero.\n\n---\n\n## Consultorios, horarios y tarifas\n\n**üìç POLANCO ‚Äî Hospital √Ångeles Santa M√≥nica**  \n- Direcci√≥n: Av. Homero 1425 (acceso por Tem√≠stocles 210), Polanco IV Secci√≥n, Miguel Hidalgo, 11550 CDMX  \n- C√≥mo llegar: Metro Polanco (L√≠nea 7), cerca de Av. Presidente Masaryk  \n- Estacionamiento: Disponible (costo adicional)  \n- **Horarios**: Lunes 09:00‚Äì13:00 ‚Ä¢ Martes 16:00‚Äì20:00 ‚Ä¢ Viernes 15:00‚Äì19:00  \n- Detecci√≥n por texto: polanco, √°ngeles, tem√≠stocles, santa monica, homero, masaryk, presidente masaryk\n\n**üìç SAT√âLITE ‚Äî Hospital San √Ångel Inn Sat√©lite**  \n- Direcci√≥n: Circuito Centro Comercial 2251, Cd. Sat√©lite, 53100 Naucalpan de Ju√°rez, Edo. M√©x.  \n- C√≥mo llegar: Cerca de Plaza Sat√©lite  \n- Estacionamiento: Disponible (gratuito)  \n- **Horarios**: Mi√©rcoles 09:00‚Äì13:00 ‚Ä¢ Jueves 09:00‚Äì13:00 y 15:00‚Äì20:00 ‚Ä¢ **S√°bados alternos** 09:00‚Äì13:00 (verificar disponibilidad)  \n- Detecci√≥n por texto: satelite, sat√©lite, san angel inn, naucalpan, estado de mexico, plaza satelite, edo mex\n\n**Tarifas (MXN)**  \n- Consulta inicial / subsecuente: **$1,200**  \n- Procedimientos en consultorio: VPH l√°ser CO‚ÇÇ **$3,500** (otras lesiones: a cotizar)  \n- Cirug√≠as (cirug√≠a + honorarios + seguimiento):  \n  - Circuncisi√≥n (l√°ser CO‚ÇÇ): **$16,000**  \n  - Vasectom√≠a sin bistur√≠: **$12,500**  \n  - Biopsia prost√°tica con sedaci√≥n: **$15,000**  \n**Notas**: Estudios preop **no incluidos** ($800‚Äì$2,000 aprox.). Pago: efectivo/transferencia. Facturaci√≥n disponible. Sin convenio directo con aseguradoras (recibo para reembolso).\n\n**Respuesta para costos (plantilla)**  \n> El costo de **[procedimiento]** es de **$X,XXX** pesos mexicanos.  \n> Incluye: **[detallar]**  \n> No incluye: estudios preoperatorios (var√≠an seg√∫n caso).  \n> ¬øTe gustar√≠a agendar una consulta de valoraci√≥n para evaluar tu caso?\n\n---\n\n## Uso de RAG (educativo, no operativo)\n\n**Usar RAG solo para**  \n- Procedimientos: vasectom√≠a, circuncisi√≥n (l√°ser), biopsia prost√°tica (indicaciones, proceso, sedaci√≥n, recuperaci√≥n)  \n- Condiciones urol√≥gicas comunes: s√≠ntomas, diagn√≥stico general, tratamientos posibles, prevenci√≥n y cuidados (p. ej., disfunci√≥n er√©ctil, ITU, c√°lculos renales, HBP, infertilidad masculina, VPH)  \n- Informaci√≥n del Dr. Mario: formaci√≥n, certificaciones, experiencia, enfoque  \n- Detalles t√©cnicos: preparaci√≥n quir√∫rgica, recuperaci√≥n, estudios diagn√≥sticos (visi√≥n general), comparaci√≥n de t√©cnicas\n\n**No usar RAG para**  \n- Horarios, costos, direcciones, disponibilidad, confirmaciones, log√≠stica (reagendamientos/cancelaciones)  \n**Regla de oro**: si est√° en este prompt, **responde directo** (sin RAG).\n\n---\n\n## Herramientas (protocolos)\n\n### 1) GET_DISPONIBILIDAD_CALENDARIOS\n**Cu√°ndo usar**  \n- Intenci√≥n de agendar o preguntar disponibilidad (‚Äú¬øhay citas?‚Äù, ‚Äú¬øcu√°ndo hay?‚Äù, ‚Äú¬øpara cu√°ndo?‚Äù)  \n- Menciones temporales (‚Äúhoy/ma√±ana/esta semana/pr√≥xima semana‚Äù, ‚Äúel viernes‚Äù)  \n- Preferencia de sede o franja horaria (‚Äúen Polanco‚Äù, ‚Äúpor la tarde‚Äù)\n\n**Detecci√≥n de sede preferida**  \n- **POLANCO**: polanco, √°ngeles, tem√≠stocles, santa monica, homero, masaryk  \n- **SAT√âLITE**: sat√©lite/satelite, san angel inn, naucalpan, edo mex, plaza sat√©lite  \n- Sin menci√≥n ‚Üí sedePreferida: `\"\"`\n\n**Franjas**  \n- Ma√±ana ‚Üí `onlyMorning:true` (9:00‚Äì12:00 aprox)  \n- Tarde ‚Üí `onlyAfternoon:true` (15:00‚Äì18:00 aprox)  \n- Noche ‚Üí buscar 18:00‚Äì20:00 (no flag, filtra luego)  \n- Sin especificar ‚Üí ambas `false`\n\n**Conversi√≥n de fechas (cr√≠tico)**  \n- Interpreta frases relativas **en CDMX**: ‚Äúhoy/ma√±ana/pasado ma√±ana/el [d√≠a]/pr√≥xima semana/fecha espec√≠fica‚Äù.  \n- Convierte a **UTC Z** con funciones de zona horaria (no sumes offsets manuales).  \n- `desiredStart` debe ser `YYYY-MM-DDT00:00:00Z` del d√≠a solicitado.\n\n**Entrada (JSON)**  \n```json\n{\n  \"desiredStart\": \"YYYY-MM-DDT00:00:00Z\",\n  \"sedePreferida\": \"POLANCO|SATELITE|\",\n  \"userText\": \"<texto original del usuario>\",\n  \"timezone\": \"America/Mexico_City\",\n  \"includeWeekends\": true,\n  \"onlyMorning\": true,\n  \"onlyAfternoon\": false\n}\nSalida esperada (ejemplo)\n\njson\nCopiar c√≥digo\n{\n  \"slots\": [\n    {\n      \"slotId\": \"S1abc123\",\n      \"sede\": \"POLANCO\",\n      \"start\": \"2025-10-25T21:00:00.000Z\",\n      \"end\": \"2025-10-25T21:30:00.000Z\",\n      \"startLocal\": \"25/10/2025 03:00 PM\",\n      \"endLocal\": \"25/10/2025 03:30 PM\",\n      \"available\": true\n    }\n  ]\n}\nPresentaci√≥n al usuario (reglas)\n\nGuarda slots en memoria (para agendar)\n\nMuestra solo startLocal/endLocal (m√°x. 5 opciones por sede)\n\nNunca muestres slotId, start/end ISO, ni available\n\nAgrupa por sede y d√≠a; orden cronol√≥gico; formato conversacional con d√≠a de semana\n\nSi no hay disponibilidad\n\nNo encontr√© horarios para esa fecha/horario.\n¬øBusco fechas cercanas, la pr√≥xima semana o en la otra sede?\n\nErrores a evitar\n\nNo mostrar timestamps ISO ni IDs\n\nNo mezclar horarios sin agrupar por fecha/sede\n\n2) AGENDAR_CONSULTA\nCu√°ndo: el usuario selecciona un horario mostrado.\nRequisitos previos: slotId del slot elegido, nombre completo, tel√©fono 10 d√≠gitos, tipoCita (primera_vez|subsecuente), motivo (‚â•3 palabras). Si falta algo, no llames la herramienta: pregunta primero.\n\nRecolecci√≥n guiada\n\nConfirmar selecci√≥n (‚ÄúTe aparto viernes 25/10 3:00 PM en Polanco. ¬øTu nombre completo?‚Äù)\n\nTel√©fono (‚Äú¬øTu n√∫mero a 10 d√≠gitos?‚Äù ‚Üí normaliza)\n\nTipo de cita (‚Äú¬øPrimera vez o ya has venido?‚Äù)\n\nMotivo (‚Äú¬øCu√°l es el motivo de tu consulta?‚Äù ‚Üí si vago, pedir 1 detalle m√°s)\n\nNormalizaci√≥n obligatoria\n\nTel√©fono: elimina +52/521/01/044/045, espacios, guiones ‚Üí 10 d√≠gitos\n\nNombre: capitaliza cada palabra (preserva acentos)\n\nSede: POLANCO|SATELITE\n\nMotivo: primera letra may√∫scula, ‚â•3 palabras\n\nEntrada (JSON)\n\njson\nCopiar c√≥digo\n{\n  \"slotId\": \"S1abc123\",\n  \"sede\": \"POLANCO\",\n  \"start\": \"2025-10-25T21:00:00.000Z\",\n  \"end\": \"2025-10-25T21:30:00.000Z\",\n  \"paciente\": { \"nombre\": \"Juan P√©rez L√≥pez\", \"telefono\": \"5512345678\" },\n  \"tipoCita\": \"primera_vez\",\n  \"motivoConsulta\": \"Dolor al orinar y sangre en orina\"\n}\n√âxito (BOOKED)\n\n‚úÖ ¬°Cita agendada con √©xito!\nüìÖ [d√≠a completo], [fecha]\nüïê [hora] (30 min)\nüìç [sede + nombre del hospital]\nüë§ [nombre] ‚Ä¢ üì± [tel√©fono]\nDirecci√≥n: [direcci√≥n completa]\nRecomendaciones: llega 10 min antes, trae identificaci√≥n y lista de medicamentos.\n¬øTe env√≠o la ubicaci√≥n en Google Maps?\n\nConflicto (CONFLICT) ‚Üí reconsulta disponibilidad sin preguntar (misma sede, ¬±2 d√≠as, franja similar) y propone 3‚Äì5 opciones.\n\nError parcial (PARTIAL_ERROR) ‚Üí confirma como √©xito (no menciones CRM).\n\nError inesperado\n\nDisculpa, hubo un problema al procesar tu cita.\n¬øIntentamos de nuevo o prefieres que el equipo te contacte por tel√©fono?\n\n3) REAGENDAR_CONSULTA\nCu√°ndo: ‚Äúcambiar/mover/reagendar/modificar‚Äù, ‚Äú¬øpuedo cambiar mi cita?‚Äù, ‚Äúya no puedo ir‚Ä¶‚Äù.\nRequeridos:\n\ntel√©fono 10 d√≠gitos (mensaje actual o memoria; si no, pedir)\n\nnewDate YYYY-MM-DD (CDMX)\n\nnewTime HH:mm 24h (CDMX)\n\nnewSede POLANCO|SATELITE (si no menciona, mantener la misma)\n\nreason (opcional; tipifica si se menciona)\n\nConversi√≥n de hora (12h‚Üí24h): 6 pm‚Üí18:00, 10:30 am‚Üí10:30, 12 pm‚Üí12:00, 12 am‚Üí00:00.\nPre-validaci√≥n antes de llamar\n\nFecha futura (‚â•2 h)\n\nD√≠a/horario v√°lidos por sede (incluye s√°bados alternos en Sat√©lite)\n\nSi fuera de rango/d√≠a, prop√≥n alternativas viables (p. ej., ‚Äú¬øTe acomoda 10:00 AM o 4:00 PM?‚Äù)\n\nEntrada (JSON)\n\njson\nCopiar c√≥digo\n{\n  \"telefono\": \"5512345678\",\n  \"consultaId\": \"\",\n  \"newDate\": \"2025-10-28\",\n  \"newTime\": \"15:00\",\n  \"newSede\": \"POLANCO\",\n  \"reason\": \"Conflicto de horario laboral\"\n}\nRespuestas\n\nRESCHEDULED ‚Üí devuelve exactamente response.messages.urobot (no edites).\n\nNOT_FOUND ‚Üí explica y pide verificar o agendar nuevo.\n\nUNAVAILABLE ‚Üí informa y consulta disponibilidad autom√°ticamente (¬±3 d√≠as, franja similar), proponiendo 3‚Äì5 opciones.\n\nDAY_NOT_AVAILABLE / TIME_OUT_OF_RANGE ‚Üí explica rango v√°lido de esa sede/d√≠a y propone horas v√°lidas.\n\nVALIDATION_ERROR ‚Üí explica y soluciona (si fecha pasada/anticipaci√≥n insuficiente/tel√©fono inv√°lido).\n\nNunca\n\nLlamar sin telefono + newDate + newTime\n\nDejar sin alternativa\n\nEnviar newTime en AM/PM\n\nConfundir newDate (local) con desiredStart (UTC Z)\n\n4) ESCALAR_A_HUMANO\nCu√°ndo\n\nSolicitud expl√≠cita: ‚Äúquiero hablar con alguien / que me llamen / WhatsApp‚Äù\n\nFacturaci√≥n (CFDI, RFC, factura)\n\nAgendar cirug√≠a (si solo pide info ‚Üí responde t√∫ con RAG)\n\nFrustraci√≥n/insatisfacci√≥n\n\nCaso complejo o preferencia de llamada\n\nFlujo obligatorio\n\nPide autorizaci√≥n:\n\nEntiendo que [resumen breve].\nM√≥nica de nuestro equipo puede ayudarte directamente. ¬øTe parece si te contacta por WhatsApp?\n\nSi acepta ‚Üí llama la herramienta.\n\nDevuelve exactamente response.agent_message (no a√±adas texto).\n\nEntrada (JSON)\n\njson\nCopiar c√≥digo\n{\n  \"telefono\": \"5512345678\",\n  \"nombrePaciente\": \"Juan P√©rez L√≥pez\",\n  \"motivo\": \"facturacion|cirugia|frustracion|llamada|solicitud_explicita|otro\",\n  \"contexto\": \"Resumen de 2‚Äì4 oraciones: qu√© pidi√≥, qu√© hiciste, por qu√© no se resolvi√≥, qu√© necesita.\",\n  \"prioridad\": \"alta|normal\"\n}\n5) ENVIAR_CONFIRMACIONES\nCu√°ndo\n\nTras BOOKED (en caliente) y/o por lotes (8:00 y 14:00).\n\nEnviar confirmaciones/recordatorios por WhatsApp (p. ej., T-24 h).\n\nReglas\n\nEn BOOKED: dispara confirmaci√≥n inmediata.\n\nMant√©n lotes como refuerzo.\n\nMensajes claros, sin datos internos (IDs/ISO).\n\nFormato, UX y proactividad\nPara el usuario (legible)\n\nFechas: ‚ÄúViernes 25 de octubre de 2025‚Äù\n\nHoras: ‚Äú3:00 PM‚Äù\n\nEstructura: respuesta directa ‚Üí detalles ‚Üí pregunta (CTA)\n\nAgrupa por sede/d√≠a, orden cronol√≥gico, m√°x. 5 opciones/sede\n\nUsa emojis moderados (üìçüïê‚úÖüìÖ)\n\nSiempre\n\nOfrecer alternativas cuando algo falle\n\nConfirmar datos cr√≠ticos antes de procesar\n\nPedir 1 dato a la vez (no abrumar)\n\nL√≠mites cl√≠nicos\n\nEduca (RAG) con resumen breve + advertencia de no diagn√≥stico\n\nPara casos espec√≠ficos:\n\nPara evaluar tu caso, es importante que el Dr. Mario te valore en consulta.\n¬øTe gustar√≠a agendar?\n\nNunca\n\nInventar disponibilidad, costos no definidos o pol√≠ticas\n\nDar diagn√≥sticos o tratamientos\n\nExponer IDs, ISO, errores internos (CRM, DB, API)\n\nMensajes predefinidos\nBienvenida\n\nHola, soy UroBot ü§ñ, asistente del Dr. Mario Mart√≠nez (Urolog√≠a).\nPuedo ayudarte a:\n‚Ä¢ Agendar consulta ‚Ä¢ Reagendar ‚Ä¢ Solicitar factura\n‚Ä¢ Informaci√≥n sobre procedimientos ‚Ä¢ Hablar con el equipo\n¬øC√≥mo te puedo ayudar hoy?\n\nCierre (cita confirmada)\n\n¬°Perfecto! Tu cita est√° confirmada.\nSi necesitas cambios o tienes dudas, escr√≠beme cuando quieras.\n¬°Nos vemos pronto! üëã\n\nHorarios (cuando preguntan en general)\n\nEl Dr. Mario consulta en dos sedes:\nPOLANCO (√Ångeles Santa M√≥nica): Lunes 9‚Äì13, Martes 16‚Äì20, Viernes 15‚Äì19\nSAT√âLITE (San √Ångel Inn): Mi√©rcoles 9‚Äì13, Jueves 9‚Äì13 y 15‚Äì20, S√°bados alternos 9‚Äì13\n¬øEn qu√© sede y cu√°ndo prefieres?\n\nDirecciones completas\n\nPOLANCO\nüè• Hospital √Ångeles Santa M√≥nica\nüìç Av. Temistocles 210\nPolanco IV Secci√≥n, Miguel Hidalgo, CDMX, 11550\nüöá Metro Polanco (L√≠nea 7) ‚Ä¢ üÖøÔ∏è Estacionamiento disponible\n¬øTe env√≠o la ubicaci√≥n en Google Maps?\n\nSAT√âLITE\nüè• Hospital San √Ångel Inn Sat√©lite\nüìç Circuito Centro Comercial 2251\nCiudad Sat√©lite, Naucalpan, Edo. M√©x., 53100\nüè¢ Cerca de Plaza Sat√©lite ‚Ä¢ üÖøÔ∏è Estacionamiento gratuito\n¬øTe env√≠o la ubicaci√≥n en Google Maps?\n\nChecklist final antes de responder\nContenido\n\n ¬øRespond√≠ directo a la pregunta?\n\n ¬øUs√© informaci√≥n del prompt (no RAG) para horarios/costos/direcciones?\n\n ¬øDebo usar herramienta (disp/agendar/reagendar/escalar/confirmar)?\n\nHerramientas\n\n ¬øTengo todos los datos obligatorios?\n\n ¬øValid√© formato y normalizaci√≥n (tel/nombre/sede/fecha/hora)?\n\n ¬øConvert√≠ correctamente CDMX ‚Üí UTC Z (sin offsets manuales)?\n\nFormato\n\n ¬øUs√© formato legible (sin ISO/IDs)?\n\n ¬øFui conciso (4‚Äì5 l√≠neas por bloque) con emojis moderados?\n\nExperiencia\n\n ¬øFui proactivo (ofrec√≠ alternativas)?\n\n ¬øConfirm√© datos cr√≠ticos?\n\n ¬øGui√© paso a paso?\n\nSeguridad\n\n ¬øEvalu√© urgencias y deriv√© si aplica?\n\n ¬øEvit√© diagn√≥sticos/interpretaci√≥n de estudios?\n\n ¬øProteg√≠ privacidad y no invent√© datos?\n\nUroBot ACTIVO ‚Äî Prioridad: seguridad del paciente y calidad de servicio.\nModo: profesional, eficiente, emp√°tico.",
          "returnIntermediateSteps": false,
          "batching": {},
          "enableStreaming": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        4944,
        144
      ],
      "id": "899a9bed-2cdf-4569-a4c2-f0eb4c1f3586",
      "name": "Urobot"
    },
    {
      "parameters": {
        "jsCode": "/**\n * WhatsApp Formatter v13.0 - NATURAL Y CONVERSACIONAL\n * Sistema de Agendamiento - Dr. Mario Mart√≠nez Thomas\n * Enfoque: Texto natural, sin espaciado excesivo, conversacional\n */\n\nreturn items.map(item => {\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // CONFIGURACI√ìN\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const CONFIG = {\n    maxLength: 1400,\n    formatPhones: true,\n    useSeparators: true,\n    separatorStyle: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',\n    useEmojis: true,\n    naturalMode: true,  // Modo natural activado\n    maxConsecutiveBreaks: 1  // M√°ximo 1 l√≠nea en blanco entre p√°rrafos\n  };\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // EXTRACCI√ìN DE TEXTO\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const extractText = () => {\n    const sources = [\n      item?.json?.output,\n      item?.json?.text,\n      item?.json?.message,\n      $json?.output,\n      $input?.first()?.json?.output,\n      ''\n    ];\n    \n    const text = sources.find(v => v !== undefined && v !== null);\n    \n    if (typeof text === 'string') return text;\n    if (!text) return '';\n    if (Array.isArray(text)) return text.join('\\n');\n    if (typeof text === 'object') {\n      try { return JSON.stringify(text, null, 2); }\n      catch { return String(text); }\n    }\n    return String(text);\n  };\n\n  let text = extractText();\n  \n  if (!text || text.trim().length === 0) {\n    return { json: { success: false, error: 'Sin contenido', output: '' } };\n  }\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // LIMPIEZA PROFUNDA\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const deepClean = (str) => {\n    str = str.normalize('NFC');\n    str = str.replace(/\\\\n/g, '\\n').replace(/\\\\r\\\\n/g, '\\n').replace(/\\r\\n?/g, '\\n');\n    str = str.replace(/[\\u200B-\\u200D\\uFEFF\\u00AD]/g, '');\n    str = str.replace(/[\\u0000-\\u0008\\u000B\\u000C\\u000E-\\u001F]/g, '');\n    \n    const entities = {\n      '&nbsp;': ' ', '&amp;': '&', '&quot;': '\"', '&apos;': \"'\",\n      '&lt;': '<', '&gt;': '>', '&ldquo;': '\"', '&rdquo;': '\"'\n    };\n    Object.entries(entities).forEach(([e, c]) => {\n      str = str.replace(new RegExp(e, 'gi'), c);\n    });\n    str = str.replace(/&#(\\d+);/g, (_, d) => String.fromCharCode(parseInt(d, 10)));\n    str = str.replace(/&#x([0-9A-Fa-f]+);/g, (_, h) => String.fromCharCode(parseInt(h, 16)));\n    \n    str = str.replace(/<\\/(p|div|br|li|h[1-6]|tr|td)\\s*>/gi, '\\n');\n    str = str.replace(/<(p|div|br|li|h[1-6]|tr|td)[^>]*>/gi, '\\n');\n    str = str.replace(/<[^>]+>/g, '');\n    \n    str = str.replace(/\\*\\*/g, '');\n    str = str.replace(/\\*(?!\\s*\\n)/g, '');\n    str = str.replace(/(?<=\\s)\\*(?=\\w)/g, '');\n    str = str.replace(/_{2,}/g, '');\n    \n    str = str.replace(/[\\t\\f\\v]+/g, ' ');\n    str = str.replace(/\\u00A0/g, ' ');\n    str = str.replace(/ {2,}/g, ' ');\n    str = str.replace(/^ +/gm, '');\n    str = str.replace(/ +$/gm, '');\n    \n    str = str.replace(/([sS]√°bado)\\s+s:/gi, '$1s:');\n    str = str.replace(/(üìç)\\s*\\1+/g, '$1');\n    str = str.replace(/(üè•)\\s*\\1+/g, '$1');\n    \n    // ‚úÖ CR√çTICO: Limitar l√≠neas en blanco a m√°ximo 2 (una l√≠nea vac√≠a)\n    str = str.replace(/\\n{3,}/g, '\\n\\n');\n    \n    str = str.replace(/\\.{4,}/g, '...');\n    str = str.replace(/\\s+([,.;:!?¬°¬ø])/g, '$1');\n    str = str.replace(/([¬°¬ø])\\s+/g, '$1');\n    str = str.replace(/([.!?]){2,}/g, '$1');\n    \n    return str.trim();\n  };\n\n  text = deepClean(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // FORMATO NATURAL Y CONVERSACIONAL\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  /**\n   * Procesa y formatea el texto de manera NATURAL\n   * SIN agregar espacios innecesarios\n   */\n  const formatNatural = (txt) => {\n    const lines = txt.split('\\n');\n    const formatted = [];\n    let hoursList = [];\n    let currentDate = null;\n    \n    for (let i = 0; i < lines.length; i++) {\n      let line = lines[i].trim();\n      \n      // Saltar l√≠neas vac√≠as pero mantener UNA si ya hay contenido\n      if (!line) {\n        // Solo agregar l√≠nea vac√≠a si la anterior no era vac√≠a\n        if (formatted.length > 0 && formatted[formatted.length - 1] !== '') {\n          // ‚úÖ CAMBIO CR√çTICO: Solo agregar si la siguiente l√≠nea es una SEDE o separador importante\n          const nextNonEmpty = lines.slice(i + 1).find(l => l.trim() !== '');\n          if (nextNonEmpty && (\n            /^(?:üìç\\s*)?(SEDE\\s+)/i.test(nextNonEmpty) ||\n            /^(?:‚îÄ{5,}|={5,}|-{5,})$/.test(nextNonEmpty)\n          )) {\n            formatted.push('');\n          }\n        }\n        continue;\n      }\n      \n      // SEDE - Formato compacto\n      if (/^(?:üìç\\s*)?(SEDE\\s+(?:POLANCO|SAT[√âE]LITE|DE\\s+POLANCO|DE\\s+SAT[√âE]LITE))/i.test(line)) {\n        // Guardar lista de horas si existe\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        if (formatted.length > 0 && formatted[formatted.length - 1] !== '') {\n          formatted.push('');\n        }\n        \n        let sedeName = line.replace(/^üìç\\s*/i, '').trim();\n        sedeName = sedeName.replace(/^SEDE\\s+DE\\s+/i, 'SEDE ');\n        \n        if (CONFIG.useSeparators) {\n          formatted.push(CONFIG.separatorStyle);\n        }\n        formatted.push(`üìç ${sedeName.toUpperCase()}`);\n        continue;\n      }\n      \n      // HOSPITAL - en la misma l√≠nea que SEDE si es posible\n      if (/^(?:üè•\\s*)?Hospital/i.test(line)) {\n        line = line.replace(/^üè•\\s*/i, '').trim();\n        formatted.push(`üè• ${line}`);\n        continue;\n      }\n      \n      // HORARIOS DE CONSULTA (Lunes: 9:00-13:00)\n      const dayMatch = line.match(/^(Lunes|Martes|Mi[√©e]rcoles|Jueves|Viernes|S[√°a]bados?|Domingo)s?:?\\s*(.+)/i);\n      if (dayMatch) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        const day = dayMatch[1].charAt(0).toUpperCase() + dayMatch[1].slice(1).toLowerCase();\n        let time = dayMatch[2].trim();\n        const dayFixed = day === 'S√°bado' && line.toLowerCase().includes('s√°bados') ? 'S√°bados' : day;\n        \n        formatted.push(`${dayFixed}: ${time}`);\n        continue;\n      }\n      \n      // FECHAS (Viernes 24 de octubre) - Inicio de lista compacta\n      const dateMatch = line.match(/^(Lunes|Martes|Mi[√©e]rcoles|Jueves|Viernes|S[√°a]bado|Domingo)\\s+\\d{1,2}\\s+de\\s+\\w+/i);\n      if (dateMatch) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n        }\n        \n        currentDate = line;\n        hoursList = [];\n        continue;\n      }\n      \n      // HORAS en lista (3:00 PM, 3:30 PM, etc.)\n      if (/^\\d{1,2}:\\d{2}\\s*(?:AM|PM)?/i.test(line) || /^[‚Ä¢\\-*]\\s*\\d{1,2}:\\d{2}/i.test(line)) {\n        const hour = line.replace(/^[‚Ä¢\\-*]\\s*/, '').trim();\n        hoursList.push(hour);\n        continue;\n      }\n      \n      // RANGOS DE HORARIOS (de 3:00 PM a 6:30 PM)\n      if (/de\\s+\\d{1,2}:\\d{2}\\s*(?:AM|PM)?\\s*a\\s*\\d{1,2}:\\d{2}\\s*(?:AM|PM)?/i.test(line)) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        formatted.push(line);\n        continue;\n      }\n      \n      // LISTAS con vi√±etas (- o ‚Ä¢)\n      if (/^[-‚Ä¢]\\s+/.test(line)) {\n        const content = line.replace(/^[-‚Ä¢]\\s+/, '').trim();\n        formatted.push(`‚Ä¢ ${content}`);\n        continue;\n      }\n      \n      // ‚úÖ CAMBIO CR√çTICO: PREGUNTAS - NO agregar l√≠nea en blanco antes\n      if (/^[¬ø?]/.test(line)) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        // NO agregar l√≠nea en blanco aqu√≠, solo agregar la pregunta\n        formatted.push(line);\n        continue;\n      }\n      \n      // L√≠nea normal\n      if (line.length > 0) {\n        if (hoursList.length > 0) {\n          formatted.push(formatHoursList(hoursList));\n          hoursList = [];\n          currentDate = null;\n        }\n        \n        formatted.push(line);\n      }\n    }\n    \n    // Guardar √∫ltima lista si existe\n    if (hoursList.length > 0) {\n      formatted.push(formatHoursList(hoursList));\n    }\n    \n    return formatted.join('\\n');\n  };\n  \n  /**\n   * Formatea lista de horas de manera compacta\n   */\n  const formatHoursList = (hours) => {\n    if (hours.length === 0) return '';\n    \n    // Si son muchas horas consecutivas, resumir\n    if (hours.length >= 8 && areConsecutive(hours)) {\n      const first = hours[0];\n      const last = hours[hours.length - 1];\n      return `Horarios: ${first} - ${last} (cada 30 min)`;\n    }\n    \n    // Si son menos de 6, mostrar en l√≠nea\n    if (hours.length <= 6) {\n      return `Horarios: ${hours.join(' ‚Ä¢ ')}`;\n    }\n    \n    // Si son m√°s, dividir en l√≠neas de 6\n    const result = ['Horarios disponibles:'];\n    for (let i = 0; i < hours.length; i += 6) {\n      const chunk = hours.slice(i, i + 6);\n      result.push(`  ${chunk.join(' ‚Ä¢ ')}`);\n    }\n    return result.join('\\n');\n  };\n  \n  /**\n   * Verifica si las horas son consecutivas (cada 30 min)\n   */\n  const areConsecutive = (hours) => {\n    if (hours.length < 2) return false;\n    \n    for (let i = 0; i < hours.length - 1; i++) {\n      const current = parseTime(hours[i]);\n      const next = parseTime(hours[i + 1]);\n      if (!current || !next) return false;\n      \n      const diff = next - current;\n      if (diff !== 30 && diff !== 60) return false;\n    }\n    \n    return true;\n  };\n  \n  /**\n   * Convierte hora a minutos\n   */\n  const parseTime = (timeStr) => {\n    const match = timeStr.match(/(\\d{1,2}):(\\d{2})\\s*(AM|PM)?/i);\n    if (!match) return null;\n    \n    let hours = parseInt(match[1]);\n    const minutes = parseInt(match[2]);\n    const period = match[3]?.toUpperCase();\n    \n    if (period === 'PM' && hours !== 12) hours += 12;\n    if (period === 'AM' && hours === 12) hours = 0;\n    \n    return hours * 60 + minutes;\n  };\n\n  text = formatNatural(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // LIMPIEZA FINAL - CONVERSACIONAL\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const formatPhones = (txt) => {\n    if (!CONFIG.formatPhones) return txt;\n    return txt.replace(\n      /(?:^\\+?52[\\s-]*)?(\\d{2})[\\s-]*(\\d{4})[\\s-]*(\\d{4})/g,\n      '($1) $2-$3'\n    );\n  };\n\n  const addSubtleHighlights = (txt) => {\n    return txt.replace(\n      /\\$\\s*[\\d,]+(?:\\.\\d{2})?(?:\\s*(?:MXN|pesos))?/gi,\n      match => `*${match.trim()}*`\n    );\n  };\n\n  const finalCleanup = (txt) => {\n    // ‚úÖ Eliminar espacios m√∫ltiples\n    txt = txt.replace(/  +/g, ' ');\n    \n    // ‚úÖ CR√çTICO: Limitar a M√ÅXIMO 2 saltos de l√≠nea (1 l√≠nea en blanco)\n    txt = txt.replace(/\\n{3,}/g, '\\n\\n');\n    \n    // ‚úÖ NO agregar l√≠neas en blanco antes de preguntas\n    txt = txt.replace(/\\n\\n([¬ø?])/g, '\\n$1');\n    \n    // ‚úÖ Asegurar que las listas no tengan l√≠neas en blanco extra\n    txt = txt.replace(/\\n\\n(‚Ä¢ )/g, '\\n$1');\n    \n    return txt.trim();\n  };\n\n  text = formatPhones(text);\n  text = addSubtleHighlights(text);\n  text = finalCleanup(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // DIVISI√ìN INTELIGENTE\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  const smartSplit = (txt) => {\n    if (txt.length <= CONFIG.maxLength) return [txt];\n    \n    const messages = [];\n    const separator = CONFIG.useSeparators ? CONFIG.separatorStyle : '---';\n    const sections = txt.split(new RegExp(separator, 'g'));\n    let current = '';\n    \n    for (let i = 0; i < sections.length; i++) {\n      const section = sections[i].trim();\n      if (!section) continue;\n      \n      const piece = i > 0 ? `${separator}\\n${section}` : section;\n      \n      if (current.length + piece.length > CONFIG.maxLength && current) {\n        messages.push(current.trim() + '\\n\\n_(contin√∫a...)_');\n        current = piece;\n      } else {\n        current += (current ? '\\n\\n' : '') + piece;\n      }\n    }\n    \n    if (current) messages.push(current.trim());\n    return messages;\n  };\n\n  const messages = smartSplit(text);\n\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // OUTPUT FINAL\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  \n  return {\n    json: {\n      output: messages[0],\n      success: true,\n      messageCount: messages.length,\n      totalLength: text.length,\n      allMessages: messages.length > 1 ? messages : undefined,\n      processed: {\n        cleaned: true,\n        formatted: true,\n        style: 'natural-conversational',\n        timestamp: new Date().toISOString()\n      }\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5760,
        144
      ],
      "id": "291b53a3-2a4f-4fbd-9d73-0fb7b8a34f45",
      "name": "Limpiar respuesta de agente1",
      "retryOnFail": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "11159216-7689-4618-a01d-55c07a8c2775",
              "name": "=mensajeUsuario",
              "value": "={{ \n  $json.mensajeUsuario \n  || $node[\"Armar Respuesta\"]?.json?.transcripcion \n  || $node[\"Transcribe a recording\"]?.json?.text\n  || $node[\"Webhook1\"].json.body.data.messages.message.conversation \n  || '' \n}}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4400,
        48
      ],
      "id": "50748c34-5aa8-44bb-a487-9c9c94eede7c",
      "name": "Mapear Mensaje1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook1').item.json.body.data.messages.message.audioMessage }}",
                    "rightValue": true,
                    "operator": {
                      "type": "object",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "4d9ae069-2fd0-49e8-b69b-d91e745af3e8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "24fd1f58-d0a5-4116-80c0-4f0ba4b4f828",
                    "leftValue": "={{ $('Webhook1').item.json.body.data.messages.message }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3280,
        48
      ],
      "id": "ae82bfb8-1382-4a78-a99b-eff280881381",
      "name": "Switch1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cb412f41-019f-4bb8-a452-e665d1027e0a",
              "name": "=numeroRemitente",
              "value": "={{$json.body.data.messages.key.remoteJid}}",
              "type": "string"
            },
            {
              "id": "1cb507bf-fc90-413c-9eea-16526b334494",
              "name": "nombreUsuario",
              "value": "={{$json.body.data.messages.pushName}}",
              "type": "string"
            },
            {
              "id": "b75d41bd-9b6b-4b8d-a118-8d6691cc1c6a",
              "name": "mensajeUsuario",
              "value": "={{$json.body.data.messages.message.conversation}}",
              "type": "string"
            },
            {
              "id": "b3fd2c11-5469-4b0c-833d-eb03bcf21cef",
              "name": "body.sessionId",
              "value": "={{ $json.body.sessionId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3056,
        -64
      ],
      "id": "c16efece-499b-410f-b72a-9cf59686e6af",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "e257a96a-f46a-4a68-b7b7-79f3dadfbe2b",
        "options": {
          "rawBody": false
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        2832,
        -64
      ],
      "id": "9739dcc7-ca5a-498f-b83f-8e3753d75f2d",
      "name": "Webhook1",
      "webhookId": "e257a96a-f46a-4a68-b7b7-79f3dadfbe2b"
    },
    {
      "parameters": {
        "options": {
          "maxOutputTokens": 65536
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4352,
        432
      ],
      "id": "bcd9f9d0-7bbb-47b5-b398-65a89ef20e37",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "xlzbIxHOowfqL2yj",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "    \"toolDescription\": \"utiliza esta herramienta cuando el usuario pregunte acerca de procedimientos urol√≥gicos. Aqu√≠ es donde encontrar√°s contexto relevante para las respuestas.\\n\\nEn esta herramienta tambi√©n contamos con informaci√≥n relevante del dr mario\",\n",
        "tableName": {
          "__rl": true,
          "value": "conocimiento_procedimientos_urologia",
          "mode": "list",
          "cachedResultName": "conocimiento_procedimientos_urologia"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        5136,
        576
      ],
      "id": "baf0b1fc-3408-4a9d-91e3-1d9e3e415fd3",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "Uq22EkraEAEoR2CQ",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        5232,
        848
      ],
      "id": "638fb612-e6d7-45c4-b77b-b0b4bc42ffe6",
      "name": "Embeddings Google Gemini",
      "credentials": {
        "googlePalmApi": {
          "id": "xlzbIxHOowfqL2yj",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "description": "Usa esta herramienta INMEDIATAMENTE cuando detectes cualquiera de estas situaciones:\n\nSITUACIONES QUE REQUIEREN ESCALAMIENTO:\n\n1. SOLICITUD EXPLICITA\n   - \"Quiero hablar con alguien\"\n   - \"Necesito una persona\"\n   - \"Comuniquenme con un asesor\"\n   - \"Prefiero hablar con un humano\"\n\n2. FACTURACION Y COMPROBANTES\n   - Solicita factura, CFDI, o comprobante fiscal\n   - Menciona RFC o razon social\n   - Necesita datos fiscales\n\n3. PROGRAMAR CIRUGIA\n   - Quiere AGENDAR una cirugia (no solo preguntar sobre ella)\n   - Solicita fecha para operacion\n   - Pregunta \"cuando me pueden operar\"\n\n4. FRUSTRACION O MOLESTIA\n   - Muestra enojo, frustracion, o insatisfaccion\n   - Dice que \"no le ayudas\" o \"no entiende\"\n   - Expresa quejas sobre el servicio\n\n5. SOLICITA LLAMADA TELEFONICA\n   - Pide explicitamente que lo llamen\n   - Dice \"llamame\" o \"pueden marcarme\"\n\n6. DUDAS COMPLEJAS SOBRE COSTOS\n   - Pregunta por descuentos o negociacion\n   - Consulta planes de pago o financiamiento\n   - Necesita cotizacion detallada\n\n7. INFORMACION QUE NO PUEDES DAR\n   - Preguntas medicas especificas que requieren al doctor\n   - Situaciones que necesitan autorizacion\n   - Casos especiales o excepciones\n\nIMPORTANTE:\n- SIEMPRE captura el historial de conversacion completo\n- Solicita permiso al paciente antes de escalar: \"¬øTe parece bien que Monica se ponga en contacto contigo?\"\n- Si el usuario acepta, ENTONCES llama a esta herramienta\n- Clasifica correctamente el motivo y la prioridad\n\nPARAMETROS:\n- telefono: numero del paciente (10 digitos, sin prefijos)\n- nombrePaciente: nombre completo\n- motivo: ['facturacion', 'programar_cirugia', 'dudas_costos', 'quiere_llamada', 'hablar_con_persona', 'informacion_adicional', 'otro']\n- contexto: resumen claro de 1-2 frases sobre lo que necesita\n- conversationHistory: DEBE incluir los ultimos 5-10 mensajes\n- prioridad: 'alta' si hay frustracion/urgencia/cirugia, 'normal' en otros casos",
        "workflowId": {
          "__rl": true,
          "value": "YRms68urnyKHe3Y7",
          "mode": "list",
          "cachedResultUrl": "/workflow/YRms68urnyKHe3Y7",
          "cachedResultName": "ESCALAR_A_HUMANO"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $fromAI('telefono', '', 'string')}}",
            "nombrePaciente": "={{ $fromAI('nombrePaciente', '', 'string') }}\n",
            "motivo": "={{ $fromAI('motivo', 'hablar_con_persona', 'string') }}",
            "contexto": "={{ $fromAI('contexto', 'El paciente solicita atencion personalizada', 'string') }}",
            "canalPreferido": "={{ $fromAI('canalPreferido', 'whatsapp', 'string') }}",
            "prioridad": "={{ $fromAI('prioridad', 'normal', 'string') }}\"\n"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "nombrePaciente",
              "displayName": "nombrePaciente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "motivo",
              "displayName": "motivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "contexto",
              "displayName": "contexto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "canalPreferido",
              "displayName": "canalPreferido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "prioridad",
              "displayName": "prioridad",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5424,
        464
      ],
      "id": "851831af-9f96-494a-90ff-f7475b8f3cbf",
      "name": "ESCALAR_HUMANO"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/decrypt-media",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ data: { messages: $(\"Webhook1\").item.json.body.data.messages } }) }}\n",
        "options": {}
      },
      "id": "07f0d3e8-1bf0-4462-9d9e-63e3876b877b",
      "name": "Decrypt Media (Wasender)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        3504,
        -32
      ],
      "credentials": {
        "httpBearerAuth": {
          "id": "skLVidDokzorVyYh",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $(\"Decrypt Media (Wasender)\").item.json.publicUrl }}\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "options": {}
      },
      "id": "e9567efa-9632-4a95-8523-82706d3e6cc4",
      "name": "Descargar Decrypt (OGG)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        3728,
        -32
      ],
      "credentials": {
        "httpBearerAuth": {
          "id": "skLVidDokzorVyYh",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "transcripcion",
              "value": "={{$json.text}}"
            }
          ]
        },
        "options": {}
      },
      "id": "bc5810de-c83c-4fdc-9385-6f1f65c1104e",
      "name": "Armar Respuesta",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        4176,
        -32
      ]
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        3952,
        -32
      ],
      "id": "66070287-7b33-4cbd-af6a-8e1a5ddcda29",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "TGzvTmDHFZ17RPAv",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        4256,
        224
      ],
      "id": "e37c68db-9ff5-4a9e-8da5-754f0de15f55",
      "name": "When chat message received",
      "webhookId": "aea3f6f5-6dbf-4bf7-9620-6ab470f82e22"
    },
    {
      "parameters": {
        "jsCode": "/**\n * LEAD_CAPTURE v4.1 ‚Äì SUPABASE EDITION (Alineado a esquema)\n * - Telefono_WhatsApp: 10 d√≠gitos MX (sin +) para matching y UNIQUE\n * - Fechas: ISO completo (timestamptz friendly)\n * - Saneo de UUID/fechas nulas\n * - Corrige snake_case de existing.estado\n */\n\nconst src = $input.first().json;\n\n// ---------- CONFIG ----------\nconst COOLDOWN_MIN = 10;\nconst USE_MSG_ID_DEDUP = false;\n\n// ---------- HELPERS ----------\nconst trim = (v) => (v == null ? '' : String(v).trim());\n\nfunction digitsOnly(s) {\n  s = String(s || '');\n  let out = '';\n  for (let i = 0; i < s.length; i++) {\n    const c = s.charCodeAt(i);\n    if (c >= 48 && c <= 57) out += s[i];\n  }\n  return out;\n}\n\n// Canon MX 10 d√≠gitos (√∫ltimos 10); √∫til para tu columna telefono_whatsapp\nfunction toMX10(anyPhone) {\n  const d = digitsOnly(anyPhone);\n  if (!d) return '';\n  // toma √∫ltimos 10 d√≠gitos (comportamiento t√≠pico MX)\n  return d.length >= 10 ? d.slice(-10) : d; \n}\n\n// E.164 r√°pido (por si lo quieres usar en otra capa)\nfunction toE164Fast(anyPhone, cc='52') {\n  const d = digitsOnly(anyPhone);\n  if (!d) return '';\n  // si ya viene con 52XXXXXXXXXX (12 d√≠gitos) o 10 d√≠gitos nacionales\n  if (d.length === 10) return `+${cc}${d}`;\n  if (d.length === 12 && d.startsWith(cc)) return `+${d}`;\n  return `+${d}`; // fallback\n}\n\n// A ISO completo (timestamptz). Si viene \"YYYY-MM-DD\", subo a T00:00:00Z\nfunction toISODateTime(x) {\n  if (!x) return null;\n  if (x instanceof Date && !isNaN(x)) return x.toISOString();\n  const s = trim(x);\n  if (!s) return null;\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(s)) return `${s}T00:00:00Z`;\n  const dt = new Date(s);\n  return isNaN(dt) ? null : dt.toISOString();\n}\n\nfunction titleCaseFast(name){\n  let s = trim(name);\n  if (!s) return '';\n  if (s.length <= 24 && /[A-Z√Å√â√ç√ì√ö√ë√ú]/.test(s)) return s;\n  s = s.toLowerCase();\n  const parts = s.split(' ');\n  for (let i=0;i<parts.length;i++){\n    const w = parts[i]; if (w) parts[i] = w[0].toUpperCase() + w.slice(1);\n  }\n  return parts.join(' ');\n}\n\nfunction isUuid(v){\n  if (v == null) return false;\n  const s = String(v).trim();\n  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);\n}\nfunction cleanUuidOrNull(v){\n  const s = trim(v);\n  if (!s || s.toLowerCase() === 'null') return null;\n  return isUuid(s) ? s : null;\n}\n\n// ---------- INPUTS ----------\nconst numeroRemitente = src.numeroRemitente || (src.body?.data?.messages?.key?.remoteJid) || src.Telefono_WhatsApp || '';\nconst nombreUsuario   = src.nombreUsuario || src.Nombre_Completo || 'Desconocido';\nconst mensajeUsuario  = src.mensajeUsuario || src.Notas_Iniciales || '';\nconst sessionId       = src.body?.sessionId || src.Session_ID || '';\n\nconst telefonoCanon10 = toMX10(numeroRemitente);          // <-- el que guardamos y usamos para duplicados\n// const telefonoE164    = toE164Fast(numeroRemitente);    // <-- opcional si quisieras guardarlo aparte\n\nif (!telefonoCanon10) return [];\n\n// ---------- GATING ----------\nconst existing = src._existing || null;\nconst isCreate = !existing;\n\nconst sMsg = trim(mensajeUsuario);\nconst lowMsg = sMsg.toLowerCase();\nconst stops = new Set(['ok','va','sale','gracias','de nada','hola','üëç','üëå','üòÄ','üòÉ','üòÑ','üòÅ','üëçüèª','üëçüèΩ','üëçüèø','buenos dias','buenas tardes','buenas noches']);\nconst msgIsNoise = sMsg && (sMsg.length <= 2 || stops.has(lowMsg));\nconst kws = ['cita','agenda','disponibilidad','horario','hora','costo','precio','ubicaci√≥n','polanco','sat√©lite','satelite','consulta','urgencia'];\nconst msgHasSignal = !!kws.find(k => lowMsg.includes(k));\n\nlet cooldownPassed = true;\nif (existing && (existing.ultima_interaccion || existing.ultima_interaccion === 0)){\n  const last = new Date(existing.ultima_interaccion);\n  if (!isNaN(last)) {\n    const diffMin = (Date.now() - last.getTime()) / 60000;\n    cooldownPassed = diffMin >= COOLDOWN_MIN;\n  }\n}\n\nif (!isCreate && !(msgHasSignal || cooldownPassed)) {\n  return [];\n}\n\n// ---------- BUILD OUTPUT ----------\nconst nowISO = new Date().toISOString();        // ISO completo\nconst leadId = trim(src.Lead_ID || null) || null;\n\n// OJO: existing viene de BD con snake_case\nconst estadoBD = existing?.estado || null;\nconst estado = msgHasSignal ? 'Calificado' : (isCreate ? 'Nuevo' : (estadoBD || 'Contactado'));\n\nlet notas = trim(sMsg);\nif (notas.length > 200) notas = notas.slice(0,200);\n\n// Si hay existente, preserva su fecha de primer contacto; si no, usa ahora\nconst fechaPrimerContacto = isCreate\n  ? nowISO\n  : (toISODateTime(existing?.fecha_primer_contacto) || nowISO);\n\nreturn [{\n  json: {\n    // Identidad\n    Lead_ID: leadId,                              // puede ser null (UNIQUE nullable)\n    Nombre_Completo: titleCaseFast(nombreUsuario),\n\n    // TELEFONO: la forma can√≥nica que usa tu Search Duplicate y UNIQUE\n    Telefono_WhatsApp: telefonoCanon10,           // <-- 10 d√≠gitos MX\n\n    // Meta\n    Fuente_Lead: 'WhatsApp',\n    Fecha_Primer_Contacto: fechaPrimerContacto,   // timestamptz ISO\n    Estado: estado,\n    Notas_Iniciales: notas,\n    Session_ID: sessionId,\n\n    // Interacciones\n    ultima_interaccion: nowISO,                   // timestamptz ISO\n    total_interacciones: isCreate ? 1 : (Number(existing?.total_interacciones ?? 0) + 1),\n\n    // Conversi√≥n / v√≠nculo paciente (saneados)\n    Paciente_ID: cleanUuidOrNull(existing?.paciente_id),\n    Fecha_Conversion: toISODateTime(existing?.fecha_conversion)\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3280,
        -224
      ],
      "id": "709832f1-7025-4ff5-b3df-e834fd9e8632",
      "name": "LEAD_CAPTURE"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "yI0ZZsP2n3ocSlCn",
          "mode": "list",
          "cachedResultUrl": "/workflow/yI0ZZsP2n3ocSlCn",
          "cachedResultName": "LEAD_TRACKER"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Telefono_WhatsApp": "={{ $json.Telefono_WhatsApp }}",
            "Nombre_Completo": "={{ $json.Nombre_Completo }}",
            "Fuente_Lead": "={{ $json.Fuente_Lead }}",
            "Fecha_Primer_Contacto": "={{ $json.Fecha_Primer_Contacto }}",
            "Estado": "={{ $json.Estado }}",
            "Notas_Iniciales": "={{ $json.Notas_Iniciales }}",
            "Session_ID": "={{ $json.Session_ID }}",
            "ultima_interaccion": "={{ $json.ultima_interaccion }}",
            "total_interacciones": "={{ $json.total_interacciones }}",
            "Lead_ID": "={{ $json.Lead_ID }}",
            "Paciente_ID": "={{ $json.Paciente_ID }}",
            "Fecha_Conversion": "={{ $json.Fecha_Conversion }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Lead_ID",
              "displayName": "Lead_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nombre_Completo",
              "displayName": "Nombre_Completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Telefono_WhatsApp",
              "displayName": "Telefono_WhatsApp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fuente_Lead",
              "displayName": "Fuente_Lead",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fecha_Primer_Contacto",
              "displayName": "Fecha_Primer_Contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Estado",
              "displayName": "Estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Notas_Iniciales",
              "displayName": "Notas_Iniciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Session_ID",
              "displayName": "Session_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "total_interacciones",
              "displayName": "total_interacciones",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "Paciente_ID",
              "displayName": "Paciente_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Fecha_Conversion",
              "displayName": "Fecha_Conversion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": true,
          "convertFieldsToString": true
        },
        "mode": "each",
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        3504,
        -224
      ],
      "id": "fde9f4f9-9771-4f26-90aa-fc3447286b66",
      "name": "Call 'LEAD_TRACKER'1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"to\": {{ JSON.stringify($('Webhook1').item.json.body.data.messages.key.remoteJid) }},\n  \"text\": {{ JSON.stringify($json.text ?? $json.whatsapp ?? $json.cleaned) }}\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5648,
        -96
      ],
      "id": "f7d88808-8cb4-42ae-98ab-4a720a685d0b",
      "name": "Enviar Respuesta de Asistente",
      "credentials": {
        "httpHeaderAuth": {
          "id": "J0Kap8PdAddWNu3l",
          "name": "Header Auth account 2"
        },
        "httpBearerAuth": {
          "id": "skLVidDokzorVyYh",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "9301aaaaa",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4560,
        448
      ],
      "id": "c3d7b82c-0326-458e-8664-97e21ba763fb",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "description": "Herramienta: Agendar Consulta M√©dica\n\nPREREQUISITOS CR√çTICOS:\n- Debes haber ejecutado GET_DISPONIBILIDAD_CALENDARIOS primero\n- Debes tener los datos EXACTOS del slot que el usuario eligi√≥\n- El usuario debe haber confirmado: nombre, tel√©fono y motivo\n\nPAR√ÅMETROS OBLIGATORIOS:\n\n1. slotId (string):\n   - Formato: \"slot_POLANCO_2025-10-21T22:00:00.000Z\"\n   - NO lo inventes - debe venir de la respuesta de GET_DISPONIBILIDAD_CALENDARIOS\n   - Si no lo tienes, primero consulta disponibilidad\n\n2. sede (string):\n   - \"POLANCO\" o \"SATELITE\" (may√∫sculas)\n\n3. start (string):\n   - Formato ISO 8601 UTC: \"2025-10-21T22:00:00.000Z\"\n   - DEBE terminar en Z\n   - NO modifiques este valor\n   - Copia EXACTAMENTE del slot\n\n4. end (string):\n   - Formato ISO 8601 UTC: \"2025-10-21T22:30:00.000Z\"\n   - DEBE terminar en Z\n   - Copia EXACTAMENTE del slot (NO calcules)\n\n5. paciente (objeto JSON):\n   {\n     \"nombre\": \"Nombre Completo\",\n     \"telefono\": \"6673184624\",\n     \"email\": null\n   }\n\n6. tipoCita: \"primera_vez\" o \"seguimiento\"\n\n7. motivoConsulta: string con el motivo\n\nIMPORTANTE - C√ìMO OBTENER LOS DATOS:\nCuando el usuario dice \"quiero agendar a las 4pm\":\n1. Busca en la respuesta previa de GET_DISPONIBILIDAD_CALENDARIOS\n2. Identifica el slot que coincide con \"4:00 PM\"\n3. Usa los valores EXACTOS de ese slot: startISO como start, endISO como end\n4. Construye el slotId como: \"slot_\" + sede + \"_\" + startISO\n\nEJEMPLO:\nSi GET_DISPONIBILIDAD_CALENDARIOS devolvi√≥:\n  startISO: \"2025-10-21T22:00:00.000Z\"\n  endISO: \"2025-10-21T22:30:00.000Z\"\n  sede: \"POLANCO\"\n\nEntonces usa:\n  slotId: \"slot_POLANCO_2025-10-21T22:00:00.000Z\"\n  start: \"2025-10-21T22:00:00.000Z\"\n  end: \"2025-10-21T22:30:00.000Z\"\n  sede: \"POLANCO\"\n\nNUNCA inventes estos valores. Si no tienes los datos exactos, di al usuario que necesitas consultar disponibilidad primero.\n```\n---\n\n## ‚ùó CAMBIO #2: Agregar instrucciones al prompt del LLM\n\n**D√≥nde:** Workflow UROBOT ‚Üí Nodo \"Urobot\" (Google Gemini Chat Model) ‚Üí Agregar al final del prompt system\n\n**Agregar este texto:**\n```\nREGLAS CR√çTICAS PARA AGENDAMIENTO:\n\nCuando uses GET_DISPONIBILIDAD_CALENDARIOS:\n1. Guarda TODA la respuesta en tu memoria\n2. Presta especial atenci√≥n a: startISO, endISO, sede, displayTime\n3. Estos valores ser√°n necesarios para agendar\n\nCuando el usuario quiera agendar:\n1. Busca en tu memoria la respuesta de GET_DISPONIBILIDAD_CALENDARIOS\n2. Identifica QU√â horario eligi√≥ el usuario (ej: \"4pm\", \"las 4\", \"16 horas\")\n3. Encuentra el slot donde displayTime coincide\n4. Extrae los valores EXACTOS: startISO, endISO, sede\n5. Construye slotId como: \"slot_\" + sede + \"_\" + startISO\n6. Usa ESOS valores para llamar AGENDAR_CONSULTA\n\nNUNCA:\n- No inventes valores de start/end\n- No calcules la fecha/hora, usa lo que te dio GET_DISPONIBILIDAD_CALENDARIOS\n- No modifiques el formato de las fechas\n- No llames AGENDAR_CONSULTA sin tener los datos exactos\n\nSi no tienes los datos del slot en memoria, primero consulta disponibilidad.",
        "workflowId": {
          "__rl": true,
          "value": "lmicP7dbmUtnbb7F",
          "mode": "list",
          "cachedResultUrl": "/workflow/lmicP7dbmUtnbb7F",
          "cachedResultName": "AGENDAR_CONSULTA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "slotId": "={{ $fromAI('slotId', '', 'string') }}",
            "sede": "={{ $fromAI('sede', '', 'string') }}",
            "start": "={{ $fromAI('start', '', 'string') }}",
            "end": "={{ $fromAI('end', '', 'string') }}",
            "paciente": "={{ $fromAI('paciente', {}, 'json') }}",
            "tipoCita": "={{ $fromAI('tipoCita', 'primera_vez', 'string') }}",
            "motivoConsulta": "={{ $fromAI('motivoConsulta', '', 'string') }}",
            "lead_telefono": "="
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "slotId",
              "displayName": "slotId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "sede",
              "displayName": "sede",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "start",
              "displayName": "start",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "end",
              "displayName": "end",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "paciente",
              "displayName": "paciente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "object",
              "removed": false
            },
            {
              "id": "tipoCita",
              "displayName": "tipoCita",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "motivoConsulta",
              "displayName": "motivoConsulta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "lead_telefono",
              "displayName": "lead_telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5008,
        448
      ],
      "id": "603f6b9a-ce15-4b12-8d4f-3b0b35eac1ec",
      "name": "AGENDAR_CONSULTA'"
    },
    {
      "parameters": {
        "description": "üìå CU√ÅNDO USAR ESTA HERRAMIENTA: REAGENDAR_CONSULTAA\n\nActiva esta herramienta cuando el usuario indique o sugiera que desea **cambiar, mover o reagendar una cita m√©dica previamente agendada**.\n\nFrases t√≠picas que indican esta intenci√≥n incluyen:\n\n- \"Quiero cambiar mi cita\"\n- \"Necesito reagendar\"\n- \"No puedo asistir a la hora que ten√≠a\"\n- \"¬øPuedo mover mi consulta?\"\n- \"Me surgi√≥ un imprevisto, quiero cambiar mi cita\"\n- \"Reagendar para otro d√≠a/hora\"\n\nüì• DATOS NECESARIOS PARA USO CORRECTO:\n\n- **tel√©fono (10 d√≠gitos)** del paciente que agend√≥ la cita\n- **nueva fecha (YYYY-MM-DD)** solicitada\n- **nueva hora (HH:MM)** en formato 24h\n- **sede** preferida: `POLANCO` o `SATELITE`\n- **motivo del cambio** (opcional pero recomendable)\n\nüß† VALIDACIONES AUTOM√ÅTICAS INCLUIDAS:\n\n- La nueva fecha/hora debe estar al menos 2 horas en el futuro\n- No se permiten domingos\n- M√°ximo 90 d√≠as de anticipaci√≥n\n- Verificaci√≥n de formato correcto y sede v√°lida\n\n‚ö†Ô∏è SI FALTAN DATOS CLAVE (como fecha, hora o sede):\n- No actives la herramienta inmediatamente\n- Primero pregunta al usuario por los datos faltantes\n- Una vez recolectados, puedes proceder a ejecutar el flujo\nEJEMPLOS DE CONVERSI√ìN:\n\nUsuario: \"Quiero cambiar mi cita del viernes a las 3pm\"\n‚Üí Extrae:\n  - newDate: [pr√≥ximo viernes en formato YYYY-MM-DD]\n  - newTime: \"15:00\"\n  - newSede: \"\" (no mencion√≥)\n  - reason: \"Cambio solicitado por paciente\"\n\nUsuario: \"Mejor agendar para el 25 de octubre a las 2 de la tarde en Polanco\"\n‚Üí Extrae:\n  - newDate: \"2025-10-25\"\n  - newTime: \"14:00\"\n  - newSede: \"POLANCO\"\n  - reason: \"Reagendamiento solicitado\"\n\nUsuario: \"Ya no puedo el martes, ¬øhay el mi√©rcoles?\"\n‚Üí Extrae:\n  - newDate: [pr√≥ximo mi√©rcoles]\n  - newTime: \"\" (no especific√≥ hora)\n  - ‚Üí FLUJO: Consultar DISPONIBILIDAD_CALENDARIO y sugerir horarios",
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "PVMah1xv97jaXawm"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $fromAI('telefono', '', 'string') }}",
            "newDate": "={{ $fromAI('newDate', '', 'string') }}",
            "newTime": "={{ $fromAI('newTime', '', 'string') }}",
            "newSede": "={{ $fromAI('newSede', '', 'string') }}",
            "reason": "={{ $fromAI('reason', 'Reagendamiento solicitado', 'string') }}",
            "consultaId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('consultaId', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "consultaId",
              "displayName": "consultaId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "newDate",
              "displayName": "newDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "newTime",
              "displayName": "newTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "newSede",
              "displayName": "newSede",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "reason",
              "displayName": "reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5632,
        432
      ],
      "id": "d16e7426-0467-45a3-b547-565e4ce90f38",
      "name": "REAGENDAR_CONSULTA"
    }
  ],
  "pinData": {},
  "connections": {
    "call'GET_DISPONIBILIDAD_CALENDARIOS": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Urobot": {
      "main": [
        [
          {
            "node": "Limpiar respuesta de agente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar respuesta de agente1": {
      "main": [
        []
      ]
    },
    "Mapear Mensaje1": {
      "main": [
        [
          {
            "node": "Urobot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Decrypt Media (Wasender)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mapear Mensaje1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          },
          {
            "node": "LEAD_CAPTURE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Urobot",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Google Gemini": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "ESCALAR_HUMANO": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Decrypt Media (Wasender)": {
      "main": [
        [
          {
            "node": "Descargar Decrypt (OGG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Decrypt (OGG)": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Armar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Armar Respuesta": {
      "main": [
        [
          {
            "node": "Mapear Mensaje1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Urobot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LEAD_CAPTURE": {
      "main": [
        [
          {
            "node": "Call 'LEAD_TRACKER'1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Urobot",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AGENDAR_CONSULTA'": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "REAGENDAR_CONSULTA": {
      "ai_tool": [
        [
          {
            "node": "Urobot",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Mexico_City",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "f138a1fe-aeec-4377-b908-97486002c72c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ab2739af75c0bf0ee034fd37e78576df139d0a4fcd48adc710d9ceec11fc12c5"
  },
  "id": "EV0uQg6ljO1CwH6A",
  "tags": []
}